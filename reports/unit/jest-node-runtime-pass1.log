FAIL tests/unit/api.runtime.v2.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.v2.spec.ts

      55 | // Use CommonJS require to avoid ESM re-export pitfalls under the lightweight TS transformer
      56 | // eslint-disable-next-line @typescript-eslint/no-var-requires
    > 57 | const real = require('../../apps/web/src/lib/supabaseServer');
         |              ^
      58 | export function getRouteHandlerSupabase(...args: any[]) {
      59 |   return (real as any).getRouteHandlerSupabase?.(...args);
      60 | }

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:57:14)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL tests/unit/api.runtime.outcomes.rate-limit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.rate-limit.spec.ts

      55 | // Use CommonJS require to avoid ESM re-export pitfalls under the lightweight TS transformer
      56 | // eslint-disable-next-line @typescript-eslint/no-var-requires
    > 57 | const real = require('../../apps/web/src/lib/supabaseServer');
         |              ^
      58 | export function getRouteHandlerSupabase(...args: any[]) {
      59 |   return (real as any).getRouteHandlerSupabase?.(...args);
      60 | }

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:57:14)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:52:1)

FAIL tests/unit/api.runtime.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.spec.ts

      55 | // Use CommonJS require to avoid ESM re-export pitfalls under the lightweight TS transformer
      56 | // eslint-disable-next-line @typescript-eslint/no-var-requires
    > 57 | const real = require('../../apps/web/src/lib/supabaseServer');
         |              ^
      58 | export function getRouteHandlerSupabase(...args: any[]) {
      59 |   return (real as any).getRouteHandlerSupabase?.(...args);
      60 | }

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:57:14)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL tests/unit/api.runtime.outcomes.jwks.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.jwks.spec.ts

      55 | // Use CommonJS require to avoid ESM re-export pitfalls under the lightweight TS transformer
      56 | // eslint-disable-next-line @typescript-eslint/no-var-requires
    > 57 | const real = require('../../apps/web/src/lib/supabaseServer');
         |              ^
      58 | export function getRouteHandlerSupabase(...args: any[]) {
      59 |   return (real as any).getRouteHandlerSupabase?.(...args);
      60 | }

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:57:14)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

FAIL tests/unit/api.runtime.outcomes.runtime-token.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.runtime-token.spec.ts

      55 | // Use CommonJS require to avoid ESM re-export pitfalls under the lightweight TS transformer
      56 | // eslint-disable-next-line @typescript-eslint/no-var-requires
    > 57 | const real = require('../../apps/web/src/lib/supabaseServer');
         |              ^
      58 | export function getRouteHandlerSupabase(...args: any[]) {
      59 |   return (real as any).getRouteHandlerSupabase?.(...args);
      60 | }

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:57:14)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

FAIL tests/unit/middleware.cors.disallowed-origin.spec.ts
  ● middleware CSP connect-src allowlist propagation › includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

FAIL tests/unit/api.runtime.cors.headers.spec.ts
  ● runtime CORS headers for allowed origin › includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

Test Suites: 7 failed, 7 total
Tests:       2 failed, 1 passed, 3 total
Snapshots:   0 total
Time:        6.035 s
Ran all test suites related to files matching /tests\/unit\/api.runtime.v2.spec.ts|tests\/unit\/api.runtime.spec.ts|tests\/unit\/api.runtime.cors.headers.spec.ts|tests\/unit\/middleware.cors.disallowed-origin.spec.ts|tests\/unit\/api.runtime.outcomes.jwks.spec.ts|tests\/unit\/api.runtime.outcomes.rate-limit.spec.ts|tests\/unit\/api.runtime.outcomes.runtime-token.spec.ts/i.
{"level":30,"time":1755750011220,"pid":21,"hostname":"bd9c8075ec35","requestId":"45c7abc9-8e90-44ef-9fed-2eeb7139d902","ms":94,"msg":"route_success"}
