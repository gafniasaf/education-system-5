{"level":30,"time":1755735704760,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7b6af142-6050-4a6f-b9a7-7c40adc2d770","ms":4,"msg":"route_success"}
{"level":30,"time":1755735704763,"pid":21,"hostname":"a4bd45f09ad0","requestId":"908037d6-2922-497a-918f-b94f4b880c23","ms":1,"msg":"route_success"}
{"level":30,"time":1755735704768,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9cc7456d-f033-4869-bf45-327132c131a7","ms":5,"msg":"route_success"}
{"level":30,"time":1755735704775,"pid":21,"hostname":"a4bd45f09ad0","requestId":"cdd95a54-4d8d-452c-b256-e873e4d47dc2","ms":1,"msg":"route_success"}
{"level":30,"time":1755735704908,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d4ab9637-23dc-4d33-b376-5ef988214523","ms":1,"msg":"route_success"}
{"level":30,"time":1755735704909,"pid":21,"hostname":"a4bd45f09ad0","requestId":"194051b7-c6ee-46c7-8a64-f642d6d6ba7b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735704909,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e9a36f03-7830-4e03-b8ea-62c0ac8d9dce","ms":0,"msg":"route_success"}
{"level":30,"time":1755735704910,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b1918588-a206-41b5-b602-ff651d08f3f7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735704910,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c8ee6943-b273-479c-bf76-271424ea69e5","ms":0,"msg":"route_success"}
{"level":30,"time":1755735704911,"pid":21,"hostname":"a4bd45f09ad0","requestId":"23f9442c-d29d-4254-9846-a5ca12f2ddb0","ms":1,"msg":"route_success"}
{"level":30,"time":1755735704911,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8d715eb4-8ca7-44a1-82a3-667ed318613c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735705166,"pid":21,"hostname":"a4bd45f09ad0","requestId":"093057c7-647b-49a3-9025-7c43899210f4","ms":1,"msg":"route_success"}
{"level":30,"time":1755735705166,"pid":21,"hostname":"a4bd45f09ad0","requestId":"75605bfd-1677-4371-bd34-11446d03d49c","ms":0,"msg":"route_success"}
{"level":50,"time":1755735705167,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3e3f6a85-7063-430f-bd1c-2c6a571da8a5","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735705167,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d8c0cfeb-4519-41f1-b0d8-603e0cfe818f","ms":1,"msg":"route_success"}
{"level":30,"time":1755735705168,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1241fa00-b5cc-46e9-8fb7-95186001a225","ms":0,"msg":"route_success"}
{"level":30,"time":1755735705169,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b9f9d5bd-c3df-4812-be57-3b1adfcd602a","ms":1,"msg":"route_success"}
FAIL tests/unit/future.messaging.spec.ts
  ● Epic E: Messaging (MVP) › lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ● Epic E: Messaging (MVP) › marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ● Epic E: Messaging (MVP) › PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ● Epic E: Messaging (MVP) › messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL tests/unit/api.runtime.v2.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.v2.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL tests/unit/api.flags.providers.users.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.flags.providers.users.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

{"level":30,"time":1755735705172,"pid":21,"hostname":"a4bd45f09ad0","requestId":"01661999-c1d3-4bde-9030-b28c3767f10e","ms":0,"msg":"route_success"}
{"level":30,"time":1755735705175,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e490c053-6c1f-4ab2-be71-0a11837f73e5","ms":3,"msg":"route_success"}
{"level":30,"time":1755735705176,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1479945b-0839-4743-a0ef-1798c9be2efa","ms":1,"msg":"route_success"}
{"level":30,"time":1755735705177,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0815a18d-c456-42af-ab4a-997e75506008","ms":0,"msg":"route_success"}
{"level":30,"time":1755735705177,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7291e70a-debe-4f1a-9c52-a295b7edac43","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707831,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ccc1cd0c-26e0-4a21-b344-80d19da3ba00","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707831,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c2b0f19c-e897-4419-b304-0dc7b919bb04","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707832,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5b4e1d23-609b-4f57-9691-85f4f90fcb17","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707832,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b55bc28e-5f91-46ea-b5ec-6f28ba4f1f77","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707833,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8b48cb75-24d7-491d-9f08-10b6b2c61e20","ms":1,"msg":"route_success"}
{"level":30,"time":1755735707834,"pid":21,"hostname":"a4bd45f09ad0","requestId":"896788da-b188-4919-8873-d9e7caff1b29","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707835,"pid":21,"hostname":"a4bd45f09ad0","requestId":"78376cc9-0032-44f5-817b-ba93dc82e07e","ms":0,"msg":"route_success"}
{"level":30,"time":1755735707835,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1145c1a9-efe0-4ecd-b476-f9a9a9c5b8ff","ms":0,"msg":"route_success"}
PASS tests/unit/api.reports.spec.ts
PASS tests/unit/lib.runtimeAuth.spec.ts
PASS tests/unit/api.pagination.headers.spec.ts
{"level":30,"time":1755735709761,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9ba9b961-9ab6-459a-bd54-773255c5f621","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709762,"pid":21,"hostname":"a4bd45f09ad0","requestId":"61db29c9-6cb5-4901-b2c6-476fa8ca299f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709763,"pid":21,"hostname":"a4bd45f09ad0","requestId":"21c82b8c-5385-47a5-ad72-576d2f4c0055","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709763,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e540fcb9-e3be-428a-a13b-c7a215c39450","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709764,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7f12c692-6072-4e54-a2f7-d47ee0d4e668","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709764,"pid":21,"hostname":"a4bd45f09ad0","requestId":"18537024-0d68-4d71-9fbd-d55d18eb27d2","ms":0,"msg":"route_success"}
{"level":30,"time":1755735709765,"pid":21,"hostname":"a4bd45f09ad0","requestId":"02b9c026-27c1-4165-b9eb-2c8fbdfa11a0","ms":1,"msg":"route_success"}
{"level":30,"time":1755735710590,"pid":21,"hostname":"a4bd45f09ad0","requestId":"77151c6c-489c-4b45-8c85-f6bd2ab17bbb","ms":1,"msg":"route_success"}
{"level":30,"time":1755735710590,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3412d085-39b8-4d71-9552-a1b8e8948bb9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735710590,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e058fff6-c445-407c-b6b7-93840821a823","ms":0,"msg":"route_success"}
{"level":30,"time":1755735710591,"pid":21,"hostname":"a4bd45f09ad0","requestId":"84179c4f-2581-4b20-a1f8-0b08f542623b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735710592,"pid":21,"hostname":"a4bd45f09ad0","requestId":"24c9d37f-016f-4d7c-bbf3-85aa4d2aba20","ms":1,"msg":"route_success"}
{"level":50,"time":1755735710755,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f7eb790d-6497-4dd7-9198-e87be5924095","ms":0,"err":"schema.safeParse is not a function","msg":"route_error"}
FAIL tests/unit/future.notifications.spec.ts
  ● Epic F: Notifications (MVP) › marks all notifications as read

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/future.notifications.spec.ts:43:17)

FAIL tests/unit/api.registry.mutations.ratelimit.spec.ts
  ● registry mutations rate-limit headers › courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ● registry mutations rate-limit headers › courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ● registry mutations rate-limit headers › courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ● registry mutations rate-limit headers › versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ● registry mutations rate-limit headers › versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

{"level":50,"time":1755735711815,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b596a65e-df6e-4648-88a3-6f18a828df4b","ms":2,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755735711824,"pid":21,"hostname":"a4bd45f09ad0","requestId":"21b8851a-087d-47fb-9339-50668d1ef88e","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755735711825,"pid":21,"hostname":"a4bd45f09ad0","requestId":"586f9227-167e-44f1-8484-788a9279b866","ms":1,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
{"level":50,"time":1755735711826,"pid":21,"hostname":"a4bd45f09ad0","requestId":"12c97b91-a30d-473e-8f89-13a188018480","ms":1,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755735711830,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4e73ab7d-cdbf-4926-b3ed-3098f2ffd1d5","ms":0,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":30,"time":1755735712398,"pid":21,"hostname":"a4bd45f09ad0","requestId":"64f53f9f-8493-45d3-8f8f-8c867268e0fb","ms":0,"msg":"route_success"}
{"level":30,"time":1755735712400,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f63d6d01-e35f-4286-93e5-400826db0d6d","ms":1,"msg":"route_success"}
{"level":30,"time":1755735712401,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f764a1c9-d798-40ed-bdc8-bc8d73048c98","ms":1,"msg":"route_success"}
{"level":30,"time":1755735712402,"pid":21,"hostname":"a4bd45f09ad0","requestId":"311c6cc5-a8e7-4eaf-a736-6230f1954bb5","ms":1,"msg":"route_success"}
{"level":30,"time":1755735712402,"pid":21,"hostname":"a4bd45f09ad0","requestId":"956ac75f-52c6-4b8d-afb9-5e71619d687b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735712403,"pid":21,"hostname":"a4bd45f09ad0","requestId":"48da9105-1015-462a-812d-055db9bce849","ms":0,"msg":"route_success"}
{"level":30,"time":1755735712403,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6762bd19-7968-4516-b1ad-532edf458357","ms":0,"msg":"route_success"}
PASS tests/unit/api.quizzes.spec.ts
PASS tests/unit/api.quiz-attempts.spec.ts
FAIL tests/unit/api.runtime.auth.exchange.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.auth.exchange.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

{"level":30,"time":1755735713116,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4a54586c-b6e9-41ef-9bb2-d7cd5c4320c4","ms":1,"msg":"route_success"}
{"level":30,"time":1755735713116,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6e5b9a40-9e4d-49e2-80f3-166d3738efca","ms":0,"msg":"route_success"}
{"level":30,"time":1755735713116,"pid":21,"hostname":"a4bd45f09ad0","requestId":"34676170-c596-4c80-be4d-e707823c15a7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735713117,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3731b915-e397-4c3f-a99f-6d45575c0f63","ms":0,"msg":"route_success"}
{"level":30,"time":1755735713118,"pid":21,"hostname":"a4bd45f09ad0","requestId":"dd5a7223-165c-48b5-8894-1d3f0c4d2792","ms":1,"msg":"route_success"}
{"level":30,"time":1755735713118,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2cc6de47-902d-4edd-9587-258c65ec0921","ms":0,"msg":"route_success"}
{"level":30,"time":1755735713118,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c8a52e90-f080-487b-86ad-c757dfc46d88","ms":0,"msg":"route_success"}
{"level":30,"time":1755735713119,"pid":21,"hostname":"a4bd45f09ad0","requestId":"885e1ca9-4301-413f-ac28-b5ce5e0ac751","ms":1,"msg":"route_success"}
{"level":30,"time":1755735713119,"pid":21,"hostname":"a4bd45f09ad0","requestId":"840c19c6-94bf-4c24-b6f7-74f8d4e3bd78","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716210,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bdfde4a4-58da-486c-8f73-703bb9736fe3","ms":1,"msg":"route_success"}
{"level":30,"time":1755735716211,"pid":21,"hostname":"a4bd45f09ad0","requestId":"cc4b613a-b92b-4821-bfec-2c5b41f12808","ms":1,"msg":"route_success"}
{"level":30,"time":1755735716211,"pid":21,"hostname":"a4bd45f09ad0","requestId":"eb844d37-8ef4-48e3-95e7-21ef585e8867","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716212,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3217a4ad-7aef-4c16-b2b6-327fad090032","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716212,"pid":21,"hostname":"a4bd45f09ad0","requestId":"373333e5-a18a-42eb-9874-cfdc1b540be6","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716212,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6eaed0b2-23e7-47d4-bc14-ded3b14ab8a6","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716213,"pid":21,"hostname":"a4bd45f09ad0","requestId":"92e8a8d8-2566-4434-a0f0-b12d20e439a9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735716214,"pid":21,"hostname":"a4bd45f09ad0","requestId":"69d4d23f-cfba-49f4-8e7c-0e2d6fb95d3a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735716214,"pid":21,"hostname":"a4bd45f09ad0","requestId":"90302f63-474d-4881-8e0b-e7bca556aedc","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.guard.matrix.spec.ts
PASS tests/unit/api.validation.bad-request.matrix.spec.ts
{"level":30,"time":1755735717681,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b671e2ba-bd1f-4b9a-963b-861439e83476","ms":1,"msg":"route_success"}
{"level":30,"time":1755735717681,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c0627ccc-8536-4bb1-8516-97d7fa33aaaf","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717682,"pid":21,"hostname":"a4bd45f09ad0","requestId":"91acf76a-bd66-4265-99e0-426741dd5fec","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717682,"pid":21,"hostname":"a4bd45f09ad0","requestId":"414acef7-1ca3-486b-bc2c-c53f9aee17fc","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717683,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4d7811f7-1fb0-4194-9786-cf21a281595f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717684,"pid":21,"hostname":"a4bd45f09ad0","requestId":"23d4463b-86df-4498-8685-6c115205e402","ms":1,"msg":"route_success"}
{"level":30,"time":1755735717684,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3c447466-9f9b-4d0b-96c7-ea42b1798a65","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717685,"pid":21,"hostname":"a4bd45f09ad0","requestId":"74255b2a-195c-4c2d-bfd3-eeb5f21b3c7f","ms":1,"msg":"route_success"}
{"level":30,"time":1755735717685,"pid":21,"hostname":"a4bd45f09ad0","requestId":"55786dee-22a1-4560-ab97-21498cbcfb17","ms":0,"msg":"route_success"}
{"level":30,"time":1755735717685,"pid":21,"hostname":"a4bd45f09ad0","requestId":"594df49b-9054-4e25-a3a4-92e47c252ff1","ms":0,"msg":"route_success"}
PASS tests/unit/ui/NotificationsDropdownClient.spec.tsx
FAIL tests/unit/api.runtime.asset.sign-url.scope.spec.ts
  ● runtime asset sign-url scopes (smoke) › missing scope → 403/401

    TypeError: Failed to parse URL from [object Object]

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

    Cause:
    TypeError: Invalid URL

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

  ● runtime asset sign-url scope › valid scope and content-type → 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      49 |     const token = makeJwt(['files.write']);
      50 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 51 |     expect([200]).toContain(res.status);
         |                   ^
      52 |     const json = await res.json();
      53 |     expect(json.url).toBeTruthy();
      54 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:51:19)

  ● runtime asset sign-url scope › unsupported content type → 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      58 |     const token = makeJwt(['files.write']);
      59 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 60 |     expect(res.status).toBe(400);
         |                        ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:60:24)

{"level":30,"time":1755735721699,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9d832bdc-7a49-4eed-9788-a41da19d1959","ms":18,"msg":"route_success"}
{"level":30,"time":1755735721711,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fd712c37-43f7-4d4a-82c5-27a49d854cdc","ms":11,"msg":"route_success"}
{"level":30,"time":1755735721725,"pid":21,"hostname":"a4bd45f09ad0","requestId":"584c7f3b-1ef4-4eb8-87ca-59722e5dab8a","ms":8,"msg":"route_success"}
{"level":30,"time":1755735722274,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c01538e9-3d4d-4aa9-b885-b67a8290ae98","ms":0,"msg":"route_success"}
{"level":30,"time":1755735722275,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0aad03fc-6a6e-4144-af31-7cbd6fbd4d30","ms":0,"msg":"route_success"}
{"level":30,"time":1755735722276,"pid":21,"hostname":"a4bd45f09ad0","requestId":"64136566-a425-4a6c-9a1b-300ad8bdf147","ms":1,"msg":"route_success"}
{"level":30,"time":1755735722276,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7d8aee6a-6855-4980-bd51-3e51f65ad6bc","ms":0,"msg":"route_success"}
{"level":30,"time":1755735722276,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8a1e0b72-4976-450f-a79f-357584fbddb7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735722277,"pid":21,"hostname":"a4bd45f09ad0","requestId":"133334f2-f872-4fc8-9e2f-9af4160c148e","ms":1,"msg":"route_success"}
{"level":30,"time":1755735722277,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d37ed15e-df5c-4609-9fdf-9c782a139363","ms":0,"msg":"route_success"}
{"level":30,"time":1755735722278,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b3291094-6645-42b1-93cf-cbf5845fe2ea","ms":1,"msg":"route_success"}
{"level":30,"time":1755735722278,"pid":21,"hostname":"a4bd45f09ad0","requestId":"869546b8-d10b-48d8-bc58-8f5848507c66","ms":0,"msg":"route_success"}
FAIL tests/unit/api.parent-links.spec.ts
  ● API /api/parent-links › GET unauth → 401; missing parent_id → 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL tests/unit/api.runtime.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL tests/unit/api.runtime.grade.idempotency.spec.ts
  ● runtime grade idempotency (smoke) › duplicate Idempotency-Key returns 200/201 or replay header

    TypeError: Failed to parse URL from [object Object]

      35 |
      36 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 37 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      38 | }
      39 |
      40 | describe('runtime grade idempotency', () => {

      at post (unit/api.runtime.grade.idempotency.spec.ts:37:10)
      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:15:43)

    Cause:
    TypeError: Invalid URL

      35 |
      36 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 37 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      38 | }
      39 |
      40 | describe('runtime grade idempotency', () => {

      at post (unit/api.runtime.grade.idempotency.spec.ts:37:10)
      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:15:43)

  ● runtime grade idempotency › duplicate grade request with same Idempotency-Key returns replayed 200

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      47 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'grade-dup-1' } as Record<string,string>;
      48 |     let res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
    > 49 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      50 |     res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
      51 |     expect([200]).toContain(res.status);
      52 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:49:27)

{"level":30,"time":1755735723569,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4587720e-b21e-4cd2-a79a-9d5ac9505f75","ms":19,"msg":"route_success"}
FAIL tests/unit/lib.serverFetch.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/ping 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 http://localhost:3333http://example.com/api/secure 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/test 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch utils › serverFetch builds absolute URL and propagates headers when given path

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://localhost:3333/api/ping"
    Received: "/api/ping"

      33 |       (process.env as any).PORT = '3333';
      34 |       await serverFetch('/api/ping', { headers: { 'x-request-id': 'in' } });
    > 35 |       expect(calls[0].url).toBe('http://localhost:3333/api/ping');
         |                            ^
      36 |       expect((calls[0].init.headers as Headers).get('x-request-id')).toBe('in');
      37 |     } finally {
      38 |       global.fetch = old;

      at Object.<anonymous> (unit/lib.serverFetch.spec.ts:35:28)

FAIL tests/unit/api.runtime.outcomes.jwks.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.jwks.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

PASS tests/unit/middleware.headers-and-guards.spec.ts
PASS tests/unit/api.announcements.spec.ts
{"level":30,"time":1755735725055,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e502eb96-dcd1-4174-8f8c-c0a8138160ae","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725056,"pid":21,"hostname":"a4bd45f09ad0","requestId":"11ba645a-1950-4ac9-9eb3-eb243bb542f9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725056,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ac7270f6-3e21-4521-9344-241c77e238e7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725057,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1298e8f1-2d35-4a75-97fd-9b31ee2aa13f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725057,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a9b80416-a5e7-4bce-9780-f9b9c0bc0473","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725058,"pid":21,"hostname":"a4bd45f09ad0","requestId":"99e5c7ca-dbf6-49c9-a3ad-cf60b810198c","ms":1,"msg":"route_success"}
{"level":30,"time":1755735725058,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bbde4fe6-91eb-440c-8f64-bf57ca7ceea7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725058,"pid":21,"hostname":"a4bd45f09ad0","requestId":"203be9f7-7712-457d-8f4f-daa40c0d6936","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725058,"pid":21,"hostname":"a4bd45f09ad0","requestId":"52d4c921-14da-4526-905e-745244f84230","ms":0,"msg":"route_success"}
{"level":50,"time":1755735725566,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0f3a51e2-a6f7-4e83-be3c-47b656f5904e","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735725566,"pid":21,"hostname":"a4bd45f09ad0","requestId":"86b72102-1d52-4706-9d2a-21cfb8dd475d","ms":1,"msg":"route_success"}
{"level":50,"time":1755735725569,"pid":21,"hostname":"a4bd45f09ad0","requestId":"330da699-471a-423f-b306-6107913508ea","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735725569,"pid":21,"hostname":"a4bd45f09ad0","requestId":"65127c67-bd2e-46b9-b839-d5f7522361ae","ms":1,"msg":"route_success"}
{"level":30,"time":1755735725569,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1f394c5f-a5f6-431a-b1f4-c5d413b86cb0","ms":0,"msg":"route_success"}
{"level":30,"time":1755735725590,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f655972d-40e8-4228-ad21-702215c0fcf2","ms":1,"msg":"route_success"}
{"level":30,"time":1755735725591,"pid":21,"hostname":"a4bd45f09ad0","requestId":"da9da6df-5248-4d77-bf9c-ef8d382f3def","ms":1,"msg":"route_success"}
FAIL tests/unit/future.files.spec.ts
  ● Epic H: Files and Media › issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ● Epic H: Files and Media › accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

FAIL tests/unit/api.runtime.checkpoint.scopes.spec.ts
  ● runtime checkpoint scopes › save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

{"level":30,"time":1755735726137,"pid":21,"hostname":"a4bd45f09ad0","requestId":"852f7ca5-cfce-47aa-99cb-e4985c8bda92","ms":13,"msg":"route_success"}
{"level":30,"time":1755735726143,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d857ffe1-fec9-4aa7-8423-011674223e4c","ms":5,"msg":"route_success"}
{"level":30,"time":1755735726708,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2cc32263-f7d5-41a2-8923-e64e3a7089bd","ms":0,"msg":"route_success"}
{"level":30,"time":1755735726709,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f4b5978c-8e47-4adc-894a-b167bf2f981a","ms":0,"msg":"route_success"}
{"level":30,"time":1755735726709,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f1ca6763-ba47-4523-b2e7-402dde48a399","ms":0,"msg":"route_success"}
{"level":30,"time":1755735726709,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4c6d7426-15e5-4512-b9b9-24de31d78aa8","ms":0,"msg":"route_success"}
FAIL tests/unit/api.messages.threads-and-messages.spec.ts
  ● messages threads and messages (TEST_MODE) › thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

PASS tests/unit/api.registry.spec.ts
{"level":30,"time":1755735727405,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ad596b25-b071-42e4-96d9-4301c87dbc02","ms":1,"msg":"route_success"}
{"level":30,"time":1755735727409,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2fb8d08b-8bb7-49fb-be19-94a876384e57","ms":0,"msg":"route_success"}
{"level":30,"time":1755735727411,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2415a6ee-8f94-471d-a3fe-428259f5ec0a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735727411,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5cbad22d-9560-4089-90f6-ca4085379f83","ms":0,"msg":"route_success"}
{"level":30,"time":1755735727412,"pid":21,"hostname":"a4bd45f09ad0","requestId":"81fc42ca-f167-4ada-8551-28c31db07eb9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735727412,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b07214ae-03ff-402e-aa89-9a28b4f55961","ms":0,"msg":"route_success"}
{"level":30,"time":1755735727879,"pid":21,"hostname":"a4bd45f09ad0","requestId":"14a8e3c9-b10d-4c75-bc07-d436f559b94e","ms":7,"msg":"route_success"}
{"level":30,"time":1755735727885,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b5f9a46e-caa3-4789-8244-c5b91750d3d7","ms":6,"msg":"route_success"}
FAIL tests/unit/api.runtime.events.scopes.spec.ts
  ● runtime events scopes › course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL tests/unit/api.files.download-url.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

FAIL tests/unit/api.assignments.crud.spec.ts
  ● Assignments CRUD API › DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

{"level":30,"time":1755735729083,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735729084,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9e315974-a8a9-41ff-b4df-7257c7088183","ms":0,"msg":"route_success"}
{"level":30,"time":1755735729084,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e040baeb-57ad-4972-83b8-09e23b91cb20","ms":0,"msg":"route_success"}
{"level":30,"time":1755735729085,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5416b0bd-cb74-4863-b1b1-6bd4c899b6f8","ms":1,"msg":"route_success"}
{"level":30,"time":1755735729085,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fbb6510a-cea2-4acb-b958-5aad38f74d38","ms":0,"msg":"route_success"}
{"level":30,"time":1755735729086,"pid":21,"hostname":"a4bd45f09ad0","requestId":"dc330450-946b-4650-a43b-24bce013fe84","ms":1,"msg":"route_success"}
{"level":50,"time":1755735729086,"pid":21,"hostname":"a4bd45f09ad0","requestId":"df486182-c733-4fec-b27d-43a32253fe85","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735729086,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f149167b-a0dd-46da-977e-279e58c9d12a","ms":0,"msg":"route_success"}
FAIL tests/unit/api.role.guard.matrix.extended.spec.ts (10.549 s)
  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL tests/unit/api.providers.ratelimit.spec.ts
  ● providers create/update/delete rate-limit headers › POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ● providers create/update/delete rate-limit headers › PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ● providers create/update/delete rate-limit headers › DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

{"level":50,"time":1755735740152,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fd935ca1-8193-463b-8fb3-9ab4431ca573","ms":0,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755735740178,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f10d3697-7065-4d63-82da-ffc7624956eb","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755735740178,"pid":21,"hostname":"a4bd45f09ad0","requestId":"867144c9-8b06-4ed0-a5ce-1bac518d629a","ms":0,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
PASS tests/unit/apiHandler.csrf.spec.ts
PASS tests/unit/api.listing.headers.matrix.spec.ts
{"level":30,"time":1755735740955,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ab117de8-1789-45e3-8155-0b59cea52dfc","ms":1,"msg":"route_success"}
{"level":30,"time":1755735740956,"pid":21,"hostname":"a4bd45f09ad0","requestId":"02129027-d2d5-400c-b3b8-4bd755b966e8","ms":0,"msg":"route_success"}
{"level":30,"time":1755735740957,"pid":21,"hostname":"a4bd45f09ad0","requestId":"cfacb804-5f8c-4a65-96e3-1d34f6090650","ms":1,"msg":"route_success"}
{"level":30,"time":1755735740957,"pid":21,"hostname":"a4bd45f09ad0","requestId":"845267b9-b7d6-46b8-85cd-e0cf45d2c2ee","ms":0,"msg":"route_success"}
{"level":30,"time":1755735740958,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4c5519c4-ac30-4d1d-b7aa-955bf24c8f20","ms":1,"msg":"route_success"}
{"level":30,"time":1755735741826,"pid":21,"hostname":"a4bd45f09ad0","requestId":"dc8dd478-3372-4f62-bcba-f893b7b50524","ms":0,"msg":"route_success"}
{"level":30,"time":1755735741827,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d6f2f0cb-c31b-41b8-b226-f038af74012c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735741828,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4a0620a6-fcb4-46f8-bd7f-146cd10aebb3","ms":1,"msg":"route_success"}
{"level":30,"time":1755735741828,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"00000000-0000-0000-0000-00000000ab02","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735741828,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1c8690c6-5fce-417b-9710-f878b6ddb357","ms":0,"msg":"route_success"}
{"level":30,"time":1755735741829,"pid":21,"hostname":"a4bd45f09ad0","requestId":"584affad-ff4f-4abb-a070-0f58bd8d163b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735741829,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"11111111-1111-1111-1111-111111111111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735741829,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e389b07b-5e38-4484-9974-61f4b1d1cba5","ms":0,"msg":"route_success"}
PASS tests/unit/api.lessons.complete.spec.ts
PASS tests/unit/gateways/SubmissionsGateway.contract.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/submissions 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/submissions 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/services.quizAttempts.spec.ts
FAIL tests/unit/api.admin.export.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.export.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

PASS tests/unit/api.headers.common.matrix.spec.ts
FAIL tests/unit/api.runtime.outcomes.runtime-token.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.runtime-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

{"level":30,"time":1755735744670,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1c4051f9-fd69-4502-bcf1-54c490e91949","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744672,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6a8b92d7-b255-4493-ad99-ba5631c364a3","ms":1,"msg":"route_success"}
{"level":30,"time":1755735744672,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a423d628-2ed3-460e-8e26-100e9c0bb142","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744672,"pid":21,"hostname":"a4bd45f09ad0","requestId":"01364106-a816-4a7f-b3b9-31819e5e2d5d","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744673,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7d49871c-ecc6-40b0-b7aa-e6106e584cca","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744673,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5a6250d7-df98-469e-b943-44264c5e5e54","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744673,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a582f013-2bed-4f94-9724-c7cb2e47b702","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744674,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f623fdd4-5c0e-4537-a978-94125c611aae","ms":0,"msg":"route_success"}
{"level":30,"time":1755735744675,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3087f233-33d8-489b-b3b2-a3d9ee453966","ms":0,"msg":"route_success"}
FAIL tests/unit/middleware.cors.disallowed-origin.spec.ts
  ● middleware CSP connect-src allowlist propagation › includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

PASS tests/unit/testStore.edgecases.spec.ts
FAIL tests/unit/server.scheduler.flags.spec.ts
  ● scheduler ensureJobsStarted flags › DUE_SOON_JOB=1 schedules due-soon job

    expect(received).toContain(expected) // indexOf

    Expected value: "assignment_due_soon"
    Received array: []

      26 |     mod.ensureJobsStarted();
      27 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 28 |     expect(calls).toContain('assignment_due_soon');
         |                   ^
      29 |   });
      30 |
      31 |   test('PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:28:19)

  ● scheduler ensureJobsStarted flags › PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "provider_health_refresh"
    Received array: []

      34 |     mod.ensureJobsStarted();
      35 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 36 |     expect(calls).toContain('provider_health_refresh');
         |                   ^
      37 |   });
      38 |
      39 |   test('REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:36:19)

  ● scheduler ensureJobsStarted flags › REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "refresh_progress_summary"
    Received array: []

      42 |     mod.ensureJobsStarted();
      43 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 44 |     expect(calls).toContain('refresh_progress_summary');
         |                   ^
      45 |   });
      46 |
      47 |   test('QUOTA_RECONCILE_JOB=1 schedules quota reconcile', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:44:19)

  ● scheduler ensureJobsStarted flags › QUOTA_RECONCILE_JOB=1 schedules quota reconcile

    expect(received).toContain(expected) // indexOf

    Expected value: "quota_reconcile"
    Received array: []

      50 |     mod.ensureJobsStarted();
      51 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 52 |     expect(calls).toContain('quota_reconcile');
         |                   ^
      53 |   });
      54 |
      55 |   test('BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:52:19)

  ● scheduler ensureJobsStarted flags › BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill

    expect(received).toContain(expected) // indexOf

    Expected value: "attachment_size_backfill"
    Received array: []

      58 |     mod.ensureJobsStarted();
      59 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 60 |     expect(calls).toContain('attachment_size_backfill');
         |                   ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:60:19)

PASS tests/unit/api.courses.id.spec.ts
{"level":30,"time":1755735748486,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ae30fd08-ee61-4e19-9f6c-133a97e13f9a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735748486,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8efdad9e-43d1-4a28-8854-6fea134cebcc","ms":0,"msg":"route_success"}
{"level":30,"time":1755735748487,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-test","ms":1,"msg":"route_success"}
{"level":30,"time":1755735748487,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8b94b79f-7ddf-4b55-8d4c-e3f7a2cee680","ms":0,"msg":"route_success"}
{"level":30,"time":1755735748487,"pid":21,"hostname":"a4bd45f09ad0","requestId":"941dfcfa-9449-4934-80b3-8db76f0c0e02","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.spec.ts
PASS tests/unit/lib.logger.redaction.spec.ts
PASS tests/unit/ui/GradeRowClient.spec.tsx
PASS tests/unit/api.runtime.asset.sign-url.ratelimit.spec.ts
FAIL tests/unit/api.files.attachments.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.attachments.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

{"level":30,"time":1755735750907,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f26d4f95-7ffa-42f2-9009-4b388a0ad7af","ms":16,"msg":"route_success"}
{"level":30,"time":1755735750913,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fd9f9704-36db-4ebe-b63a-9c8f03cc0dbc","ms":6,"msg":"route_success"}
{"level":30,"time":1755735752349,"pid":21,"hostname":"a4bd45f09ad0","requestId":"10ef7e61-b905-4015-b8d0-a1ef2384a1c9","ms":16,"msg":"route_success"}
PASS tests/unit/api.runtime.rate-limit.spec.ts
FAIL tests/unit/api.files.finalize.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.finalize.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:2:1)

FAIL tests/unit/lib.serverFetch.csrf-header.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/messages 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch forwards x-csrf-token when cookie present › adds x-csrf-token header for unsafe method

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc123"
    Received: "cookie-csrf"

      45 |     await serverFetch('/api/messages', { method: 'POST' });
      46 |     const h = calls[0].init.headers as Headers;
    > 47 |     expect(h.get('x-csrf-token')).toBe('abc123');
         |                                   ^
      48 |   });
      49 | });
      50 |

      at Object.<anonymous> (unit/lib.serverFetch.csrf-header.spec.ts:47:35)

FAIL tests/unit/api.runtime.grade.ratelimit.spec.ts
  ● runtime grade rate-limit headers › returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

FAIL tests/unit/api.admin.audit-logs.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.audit-logs.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

{"level":30,"time":1755735753974,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ca3a1bba-43a8-4dc8-b968-deab3849ae4e","ms":17,"msg":"route_success"}
{"level":30,"time":1755735754901,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0ff9d389-f054-41e9-8db7-c410407bd66a","ms":0,"msg":"route_success"}
{"level":50,"time":1755735754903,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c57d2c73-859a-4bba-9eed-32d3da49f953","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
FAIL tests/unit/api.providers.dto-and-ratelimit.spec.ts
  ● providers endpoints DTO + ratelimit headers › rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

FAIL tests/unit/api.runtime.events.ratelimit.spec.ts
  ● runtime events rate-limit headers › returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

{"level":30,"time":1755735755278,"pid":21,"hostname":"a4bd45f09ad0","requestId":"27c2cde8-2b2b-46ec-acd1-141bdfab87b7","ms":10,"msg":"route_success"}
{"level":30,"time":1755735755721,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b79f0d04-c51f-4618-ae58-b1d974eeb779","ms":0,"msg":"route_success"}
{"level":30,"time":1755735755722,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f934f142-e0d5-4bf6-9326-67dbec8751ca","ms":1,"msg":"route_success"}
{"level":30,"time":1755735755722,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ae5d7060-95b3-4e91-980b-f665818a7661","ms":0,"msg":"route_success"}
{"level":30,"time":1755735755722,"pid":21,"hostname":"a4bd45f09ad0","requestId":"832218ec-cf7e-41ac-83e7-46b955f700bc","ms":0,"msg":"route_success"}
{"level":30,"time":1755735755723,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e46dcbe6-534c-499b-aa52-4c60504708f7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735755723,"pid":21,"hostname":"a4bd45f09ad0","requestId":"be9f1484-806b-47c9-a6c3-32f2408af683","ms":0,"msg":"route_success"}
PASS tests/unit/api.quiz-questions.spec.ts
PASS tests/unit/api.runtime.v2.security.spec.ts
{"level":30,"time":1755735756305,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f1820aad-4f64-41b8-9c60-d0aa9d020b75","ms":0,"msg":"route_success"}
{"level":30,"time":1755735756306,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9c14b6b9-78e7-4221-991e-3774e0e34a72","ms":0,"msg":"route_success"}
{"level":30,"time":1755735756306,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bb9e8d47-3b01-4c29-b484-8b26c0c20899","ms":0,"msg":"route_success"}
FAIL tests/unit/lib.serverFetch.headers.spec.ts
  ● Console

    console.debug
      [serverFetch] 400 /api/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch headers and fetchJson › propagates x-request-id and x-test-auth and builds absolute URL

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      22 |   test('propagates x-request-id and x-test-auth and builds absolute URL', async () => {
      23 |     await serverFetch('/api/health');
    > 24 |     expect(fetchSpy).toHaveBeenCalledTimes(1);
         |                      ^
      25 |     const [url, init] = fetchSpy.mock.calls[0];
      26 |     expect(String(url)).toBe('http://localhost:3030/api/health');
      27 |     const hdrs = new Headers(init.headers);

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:24:22)

  ● serverFetch headers and fetchJson › does not attach x-csrf-token on GET even when cookie present

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))

      35 |     store.cookies.set('csrf_token', 'tok');
      36 |     await serverFetch('/api/health', { method: 'GET' });
    > 37 |     const [, init] = fetchSpy.mock.calls[0];
         |                      ^
      38 |     const hdrs = new Headers(init.headers);
      39 |     expect(hdrs.get('x-csrf-token')).toBeNull();
      40 |   });

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:37:22)

PASS tests/unit/api.messages.csrf-double-submit.spec.ts
{"level":30,"time":1755735757099,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7ee124de-973e-429a-be4e-5cde4423b421","ms":1,"msg":"route_success"}
{"level":30,"time":1755735757559,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3dfd323f-b48d-4d3a-b60d-639a561be75d","ms":1,"msg":"route_success"}
{"level":30,"time":1755735757560,"pid":21,"hostname":"a4bd45f09ad0","requestId":"333b1254-00ed-4004-8599-0b32131b53cd","ms":0,"msg":"route_success"}
PASS tests/unit/api.submissions.rate-limit.spec.ts
FAIL tests/unit/api.files.roundtrip.spec.ts
  ● files round-trip › upload-url → PUT bytes → download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

{"level":30,"time":1755735758136,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rid-rt","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758162,"pid":21,"hostname":"a4bd45f09ad0","requestId":"20a667d7-f78b-44ae-aabf-bf2448976d07","ms":1,"msg":"route_success"}
{"level":30,"time":1755735758846,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f0a635c7-e3a7-4d90-a6d0-6f568b1b6817","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758847,"pid":21,"hostname":"a4bd45f09ad0","requestId":"36138b8f-8c28-4c48-b636-e9c199c10ac1","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758847,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a5f021b6-9d81-44ea-825e-2177e46e0911","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758848,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b78431cb-3c7d-43f1-8e45-8f3f8dff69db","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758848,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4725afa7-c00f-4dd9-815b-118391b3e5de","ms":0,"msg":"route_success"}
{"level":30,"time":1755735758848,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a151bd98-80fd-4aa2-ab3d-96c67f9c18e1","ms":0,"msg":"route_success"}
PASS tests/unit/api.quiz-choices.spec.ts
FAIL tests/unit/api.runtime.idempotency.spec.ts
  ● runtime progress idempotency › duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

{"level":30,"time":1755735759380,"pid":21,"hostname":"a4bd45f09ad0","requestId":"44bd4d47-99a1-4f81-a57a-300737345c2a","ms":15,"msg":"route_success"}
{"level":30,"time":1755735759939,"pid":21,"hostname":"a4bd45f09ad0","requestId":"672fa37c-25ac-4648-9fde-2755e6bce1f2","ms":0,"msg":"route_success"}
{"level":30,"time":1755735759940,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d152d1af-9264-4719-9e2b-1ddf4f0b9068","ms":0,"msg":"route_success"}
{"level":30,"time":1755735759940,"pid":21,"hostname":"a4bd45f09ad0","requestId":"90b21d5b-fe3d-4334-9c70-2d52cc40805e","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.read-all.csrf.spec.ts
PASS tests/unit/api.files.negatives.spec.ts
{"level":30,"time":1755735760529,"pid":21,"hostname":"a4bd45f09ad0","requestId":"863191c0-1cf3-48a4-953e-48204449cd9c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735760530,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d65ce02c-ae29-42af-98fe-99e0052e94ee","ms":0,"msg":"route_success"}
{"level":30,"time":1755735760531,"pid":21,"hostname":"a4bd45f09ad0","requestId":"xx","ms":1,"msg":"route_success"}
{"level":30,"time":1755735760531,"pid":21,"hostname":"a4bd45f09ad0","requestId":"yy","ms":0,"msg":"route_success"}
{"level":30,"time":1755735761297,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ec7b3fc0-3312-4aeb-954e-9a5af9a8d712","ms":7,"msg":"route_success"}
FAIL tests/unit/api.runtime.cors.headers.spec.ts
  ● runtime CORS headers for allowed origin › includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

PASS tests/unit/api.lessons.reorder.spec.ts
{"level":30,"time":1755735761884,"pid":21,"hostname":"a4bd45f09ad0","requestId":"542eae4a-e2fa-4cf3-8603-e1489bc25f27","ms":0,"msg":"route_success"}
{"level":30,"time":1755735761885,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8f773b12-559f-45ba-9dcc-ba4011183cc3","ms":0,"msg":"route_success"}
{"level":30,"time":1755735761886,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ff0bb62f-36c4-40bc-897a-cf47f7ae748f","ms":1,"msg":"route_success"}
{"level":30,"time":1755735761886,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fb3fbcd3-4a2c-48c1-80ae-9d3e8842cef8","ms":0,"msg":"route_success"}
{"level":30,"time":1755735762741,"pid":21,"hostname":"a4bd45f09ad0","requestId":"95d95b63-837d-446f-b351-80ade053a375","ms":0,"msg":"route_success"}
{"level":30,"time":1755735762742,"pid":21,"hostname":"a4bd45f09ad0","requestId":"cd4e6015-9b33-466c-ba8b-ead91038d7e2","ms":0,"msg":"route_success"}
{"level":30,"time":1755735762742,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b0557128-b991-4f3b-a92f-53463340ed7f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735762743,"pid":21,"hostname":"a4bd45f09ad0","requestId":"765384c8-59ee-4429-ac29-3b3476de27f7","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications-preferences.spec.ts
FAIL tests/unit/api.assignments.target.upsert.spec.ts
  ● assignments target upsert (EXTERNAL_COURSES=1) › POST upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 500]

      15 |     const body = { course_id: '00000000-0000-0000-0000-000000000001', title: 'A', target: { source: 'v2', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      16 |     const res = await (AssignPOST as any)(req('POST', 'http://localhost/api/assignments', body));
    > 17 |     expect([201, 500]).toContain(res.status); // 201 success; 500 if DTO mismatch in test harness
         |                        ^
      18 |   });
      19 |
      20 |   test('PATCH upserts assignment_targets when target provided', async () => {

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:17:24)

  ● assignments target upsert (EXTERNAL_COURSES=1) › PATCH upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      23 |     const body = { title: 'B', target: { source: 'v1', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      24 |     const res = await (AssignPATCH as any)(req('PATCH', 'http://localhost/api/assignments?id=00000000-0000-0000-0000-000000000001', body));
    > 25 |     expect([200, 500]).toContain(res.status);
         |                        ^
      26 |   });
      27 | });
      28 |

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:25:24)

{"level":30,"time":1755735763284,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c8bd6037-a2f4-4d27-8fdb-6dcfe15c630e","ms":1,"msg":"route_success"}
{"level":30,"time":1755735763286,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5d3d675e-d8f9-430c-a424-c2008c7b25f6","ms":0,"msg":"route_success"}
{"level":50,"time":1755735763901,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ad9411e3-eebe-435b-887b-9be506f58244","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755735764019,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6faf7c5c-29a7-41f0-a51d-23f30247b8a0","ms":1,"msg":"route_success"}
FAIL tests/unit/db.rls.negative.spec.ts
  ● DB RLS negative cases (policy guards) › student cannot read other students notifications

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/db.rls.negative.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ● DB RLS negative cases (policy guards) › non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ● DB RLS negative cases (policy guards) › student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

PASS tests/unit/api.modes.prod-guards.spec.ts
PASS tests/unit/api.notifications.spec.ts
{"level":30,"time":1755735764753,"pid":21,"hostname":"a4bd45f09ad0","requestId":"27d2d039-4649-4de0-96ac-44352ca17dbf","ms":0,"msg":"route_success"}
{"level":30,"time":1755735764754,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ae6aa3a8-67c3-408b-a982-75ddd6c6f138","ms":0,"msg":"route_success"}
{"level":30,"time":1755735765363,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1147ca6c-6a58-4592-a64b-31c9ae7f3178","ms":1,"msg":"route_success"}
{"level":30,"time":1755735765364,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2c32da1e-2c93-4e19-bcd7-1f3e65d56596","ms":0,"msg":"route_success"}
{"level":30,"time":1755735765364,"pid":21,"hostname":"a4bd45f09ad0","requestId":"818156e2-ae18-4a88-803a-ae6049e72c74","ms":0,"msg":"route_success"}
{"level":30,"time":1755735765365,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6f612beb-5fb2-4d74-a8b8-f04204913982","ms":0,"msg":"route_success"}
{"level":30,"time":1755735765365,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ad77dfae-25f4-4c0b-baba-a3f208b68aa2","ms":0,"msg":"route_success"}
PASS tests/unit/api.modules.spec.ts
PASS tests/unit/api.csrf.double-submit.spec.ts
PASS tests/unit/api.messages.threads.ratelimit.headers.spec.ts
{"level":30,"time":1755735766589,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b616ba5a-35d4-4fec-bce6-74b6d3c81f9c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735766590,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ec602af1-48f7-4af6-8f3e-a285ff9743d6","ms":0,"msg":"route_success"}
{"level":30,"time":1755735766591,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b887238a-9202-42d5-90d0-1eae57e7877e","ms":0,"msg":"route_success"}
{"level":30,"time":1755735766591,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8cfd4ebb-f282-45f8-9386-ad972c535409","ms":0,"msg":"route_success"}
FAIL tests/unit/middleware.security-headers.more.spec.ts
  ● middleware additional security headers › sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ● middleware additional security headers › sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL tests/unit/api.runtime.outcomes.rate-limit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.rate-limit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

FAIL tests/unit/api.enrollments.spec.ts
  ● API /api/enrollments › POST unauth → 401; non-student → 403; student → 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth → 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

PASS tests/unit/testStore.spec.ts
{"level":30,"time":1755735767925,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9624a8f4-bd2a-483c-8c29-4a75b45d38d8","ms":1,"msg":"route_success"}
{"level":30,"time":1755735767926,"pid":21,"hostname":"a4bd45f09ad0","requestId":"878d3b94-3966-42be-b129-91eb06175a8c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735767927,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8340f552-8e67-4cdf-b6f6-7c11293f4f47","ms":1,"msg":"route_success"}
{"level":30,"time":1755735767929,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-enr","ms":0,"msg":"route_success"}
{"level":30,"time":1755735768604,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f2a2ad80-0335-4901-965e-e4ca423ea029","ms":0,"msg":"route_success"}
PASS tests/unit/server.withRouteTiming.csrf.spec.ts
FAIL tests/unit/api.providers.health.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.health.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

PASS tests/unit/services.quizzes.spec.ts
FAIL tests/unit/api.notifications.rate-limit.spec.ts
  ● notifications rate-limit headers › GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

{"level":30,"time":1755735770170,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d7b60353-d1a5-4a22-900e-4bd5192c74de","ms":1,"msg":"route_success"}
{"level":30,"time":1755735770171,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3327a1dd-ed4f-4cbd-bdb0-c4476e81bfdb","ms":0,"msg":"route_success"}
{"level":30,"time":1755735770713,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8437ceec-a310-4b5e-b1ad-5e3f3f155af1","ms":15,"msg":"route_success"}
PASS tests/unit/api.runtime.checkpoint.size-limit.spec.ts
FAIL tests/unit/api.assignments.post.csrf.spec.ts
  ● assignments POST CSRF double-submit › 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

{"level":30,"time":1755735771251,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1e5982bd-4b9d-44a3-a92d-9c7ad62686d5","ms":1,"msg":"route_success"}
{"level":20,"time":1755735771775,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755735771800,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_student_widgets"}
PASS tests/unit/services.dashboard.spec.ts
FAIL tests/unit/api.quizzes.ratelimit.spec.ts
  ● quizzes rate-limit headers on PATCH/DELETE › PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

{"level":50,"time":1755735772457,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e4dac442-128b-4b4a-a07e-7d3f9ac9fb6a","ms":1,"err":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 3,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 3 character(s)\",\n    \"path\": [\n      \"title\"\n    ]\n  }\n]","msg":"route_error"}
{"level":30,"time":1755735772474,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5e2832f2-57c3-4cbd-857c-eea7c97912a5","ms":1,"msg":"route_success"}
FAIL tests/unit/future.observability.logs.spec.ts
  ● observability logs (services) › dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ● observability logs (services) › progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

PASS tests/unit/api.messages.threads.ratelimit.spec.ts
FAIL tests/unit/api.progress.errors.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.errors.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

{"level":30,"time":1755735773717,"pid":21,"hostname":"a4bd45f09ad0","requestId":"afec315b-df5d-45fb-a17a-9149e437b1af","ms":1,"msg":"route_success"}
{"level":30,"time":1755735773717,"pid":21,"hostname":"a4bd45f09ad0","requestId":"df87d83f-0272-451c-af7b-e8456fc1a7cf","ms":0,"msg":"route_success"}
{"level":30,"time":1755735773718,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1ee2cbdc-1c78-4008-b30b-544816ea7493","ms":0,"msg":"route_success"}
{"level":20,"time":1755735775071,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755735775072,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/services.dashboard.needsGrading.spec.ts
PASS tests/unit/schemas.env.runtime-keys.required.spec.ts
PASS tests/unit/services.lessons.spec.ts
{"level":30,"time":1755735776097,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f39451ce-1aee-4005-9eb4-3c3145485cba","ms":1,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.pagination.spec.ts
FAIL tests/unit/api.events.behavior.spec.ts
  ● Events API behavior › test-mode: POST 201 and GET lists event; 401 unauth

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [201, 204]

      22 |     jest.spyOn(supa, 'getCurrentUserInRoute').mockResolvedValue({ id: 'u', user_metadata: { role: 'teacher' } } as any);
      23 |     res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'e1', meta: {} }));
    > 24 |     expect([201,204]).toContain(res.status); // test-mode -> 201
         |                       ^
      25 |     const list = await (EventsGET as any)(get('http://localhost/api/events'));
      26 |     expect(list.status).toBe(200);
      27 |   });

      at Object.<anonymous> (unit/api.events.behavior.spec.ts:24:23)

{"level":30,"time":1755735777378,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f129fc44-f701-4d43-b388-1e07a193982b","ms":1,"msg":"route_success"}
{"level":30,"time":1755735777379,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a0470daa-32ae-4dcc-8e12-50b08c923d1b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735777379,"pid":21,"hostname":"a4bd45f09ad0","requestId":"931ddf30-ae99-4441-971e-4f3a027535b4","ms":0,"msg":"route_success"}
{"level":30,"time":1755735778108,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e533b575-2b59-4f3c-b46f-d6f4b778338b","ms":1,"msg":"route_success"}
{"level":30,"time":1755735778109,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9dd18fcf-af1f-4beb-9ab4-787b87cdff9a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735778109,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-test","ms":0,"msg":"route_success"}
PASS tests/unit/api.courses.spec.ts
FAIL tests/unit/api.teacher.grading-queue.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.teacher.grading-queue.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

PASS tests/unit/future.observability.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

{"level":30,"time":1755735779435,"pid":21,"hostname":"a4bd45f09ad0","requestId":"up-123","ms":0,"msg":"route_success"}
{"level":50,"time":1755735779436,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8f083af8-8f07-4b53-b4e4-f9b0dd315456","ms":0,"err":"boom","msg":"route_error"}
{"level":30,"time":1755735780074,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5e6a462d-1b7f-42cd-9523-2497c9dc0333","ms":0,"msg":"route_success"}
{"level":30,"time":1755735780075,"pid":21,"hostname":"a4bd45f09ad0","requestId":"460d4c80-062b-499a-9781-73ffa7e06552","ms":0,"msg":"route_success"}
PASS tests/unit/api.announcements.ratelimit.spec.ts
PASS tests/unit/api.requestId.headers.matrix.spec.ts
{"level":30,"time":1755735780746,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a9a6a0f5-f4f0-43a2-889c-bd9f9cfb7c62","ms":0,"msg":"route_success"}
{"level":30,"time":1755735780747,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d84ab9e3-c934-41c5-9170-b9d6df0765ad","ms":0,"msg":"route_success"}
{"level":30,"time":1755735781278,"pid":21,"hostname":"a4bd45f09ad0","requestId":"64dc2d0c-91af-4bfe-ab56-b8d61613cea1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735781285,"pid":21,"hostname":"a4bd45f09ad0","requestId":"741eb198-fb55-49a5-8118-8a8c320fa31b","ms":0,"msg":"route_success"}
PASS tests/unit/api.parent-links.headers.spec.ts
PASS tests/unit/gateways/health.gateway.spec.ts
PASS tests/unit/apiHandler.spec.ts
FAIL tests/unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ● withRouteTiming skips CSRF on /api/runtime/* › cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

{"level":30,"time":1755735781920,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ae998808-38cd-4f3f-926a-5479ae87c46c","ms":1,"msg":"route_success"}
PASS tests/unit/services.announcements.spec.ts
PASS tests/unit/ui/SystemThroughputProfiler.spec.tsx
FAIL tests/unit/middleware.csrf-cookie.spec.ts
  ● middleware CSRF cookie issuance › sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL tests/unit/api.files.content-type-default.spec.ts
  ● files default content_type › defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

{"level":30,"time":1755735784188,"pid":21,"hostname":"a4bd45f09ad0","requestId":"367bb2f0-05e3-45cc-8183-e55f2ad57c04","ms":0,"msg":"route_success"}
{"level":30,"time":1755735784189,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0ba69360-d6a9-4f37-b3be-8bb8c2a78ce9","ms":1,"msg":"route_success"}
{"level":30,"time":1755735784189,"pid":21,"hostname":"a4bd45f09ad0","requestId":"82ea320d-6290-43da-b076-2daac315552e","ms":0,"msg":"route_success"}
{"level":20,"time":1755735784763,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755735784764,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d47be0ca-59da-466a-aac8-344fc7adbfb1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735784765,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735784765,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9a2cde27-4109-4a3c-94ee-b35d1a0ce421","ms":0,"msg":"route_success"}
PASS tests/unit/api.dto.enforced.on.success.spec.ts
FAIL tests/unit/api.progress.access.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.access.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

PASS tests/unit/schemas.quiz.spec.ts
PASS tests/unit/schemas.dashboard.spec.ts
FAIL tests/unit/api.runtime.teacher.outcomes.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.teacher.outcomes.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL tests/unit/api.messages.read-all.spec.ts
  ● API /api/messages/threads/[id]/read-all › marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

{"level":30,"time":1755735786812,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8808f13f-8af7-437d-be41-a7bab1e7d7ad","ms":1,"msg":"route_success"}
{"level":50,"time":1755735786813,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a02e8877-be14-4aa0-88eb-4f9a5706df5a","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735786813,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7b47899e-d366-4e2e-8ebb-5d0331580aeb","ms":0,"msg":"route_success"}
{"level":30,"time":1755735787157,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3771d495-e550-4861-a33a-34be59413fcb","ms":0,"msg":"route_success"}
{"level":30,"time":1755735787159,"pid":21,"hostname":"a4bd45f09ad0","requestId":"56d836a4-4514-4ca1-81d0-4df1061a3667","ms":0,"msg":"route_success"}
{"level":50,"time":1755735787160,"pid":21,"hostname":"a4bd45f09ad0","requestId":"04e48840-9102-425e-a37b-6bd940f59ba9","issues":[{"path":"abc.url","message":"Invalid url"},{"path":"x y.url","message":"Invalid url"},{"path":"z/1.url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735787160,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9a0f1b70-9520-47ba-a745-28216a844ae1","ms":1,"msg":"route_success"}
FAIL tests/unit/api.files.resolve.spec.ts
  ● API /api/files/resolve › test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

PASS tests/unit/api.lessons-complete.spec.ts
{"level":30,"time":1755735787632,"pid":21,"hostname":"a4bd45f09ad0","requestId":"87da5c8f-75e5-4db1-9b08-cfaa89f46a48","ms":1,"msg":"route_success"}
{"level":30,"time":1755735787634,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3c35d7b0-ceea-4d0b-9ca9-5184d2e75a55","ms":1,"msg":"route_success"}
{"level":30,"time":1755735787635,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735787635,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9ecee570-96ac-4907-9e63-e48993263734","ms":0,"msg":"route_success"}
PASS tests/unit/lib.jwksCache.ttl.spec.ts
FAIL tests/unit/middleware.security-headers.spec.ts
  ● middleware security headers › sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL tests/unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ● runtime outcomes JWKS rotation › refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

{"level":30,"time":1755735788181,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bc534634-7ebf-4e54-9f85-c87f309fda59","ms":0,"msg":"route_success"}
{"level":50,"time":1755735788541,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2d28be56-05b3-4e52-bc05-e6de286f482c","ms":0,"err":"supabase.from(...).upsert is not a function","msg":"route_error"}
FAIL tests/unit/api.admin.quotas.ratelimit.headers.spec.ts
  ● admin quotas rate-limit headers › 429 includes retry-after and rate-limit headers

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.headers.spec.ts:18:17)

FAIL tests/unit/api.courses.transfer-owner.audit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.courses.transfer-owner.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

FAIL tests/unit/api.health.requiredEnvs.spec.ts
  ● api.health requiredEnvs snapshot › includes Supabase keys and runtime keys when RUNTIME_API_V2=1

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      19 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_URL).toBe(true);
      20 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_ANON_KEY).toBe(true);
    > 21 |     expect(json.requiredEnvs.NEXT_RUNTIME_PUBLIC_KEY).toBe(true);
         |                                                       ^
      22 |     expect(json.requiredEnvs.NEXT_RUNTIME_PRIVATE_KEY).toBe(true);
      23 |     expect(json.requiredEnvs.NEXT_RUNTIME_KEY_ID).toBe(true);
      24 |   });

      at Object.<anonymous> (unit/api.health.requiredEnvs.spec.ts:21:55)

PASS tests/unit/api.admin.quotas.auth.spec.ts
{"level":30,"time":1755735790279,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b26d862c-d2c5-4984-996e-537dae5f760c","ms":1,"msg":"route_success"}
{"level":30,"time":1755735790280,"pid":21,"hostname":"a4bd45f09ad0","requestId":"064cd926-1903-4508-a3a7-8a48dc8abf1d","ms":0,"msg":"route_success"}
{"level":30,"time":1755735790280,"pid":21,"hostname":"a4bd45f09ad0","requestId":"79c72bc9-058f-4436-95a9-cd9bc03da0a9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735790281,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e8faae21-019c-420b-816f-11b6020bfba4","ms":0,"msg":"route_success"}
{"level":30,"time":1755735790932,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e68f21a0-6f62-4b0c-898b-8bc63ad8f665","ms":1,"msg":"route_success"}
{"level":30,"time":1755735790934,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2fffc6fc-8402-4c63-a3c8-b04efcdb3f83","ms":0,"msg":"route_success"}
{"level":30,"time":1755735790935,"pid":21,"hostname":"a4bd45f09ad0","requestId":"cfeb7258-f381-4a1c-a1c4-376e64456a20","ms":0,"msg":"route_success"}
FAIL tests/unit/db.rls.assignments.negative.spec.ts
  ● Assignments RLS/authorization negatives › student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

FAIL tests/unit/api.providers.get.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.get.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

PASS tests/unit/api.quiz-choices.dto.spec.ts
{"level":30,"time":1755735791921,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2c7096d4-a43f-4d72-ab20-67d3d584cec7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735791922,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b7b1207a-ac83-4f20-bdc4-f770179b56d6","ms":0,"msg":"route_success"}
{"level":30,"time":1755735792495,"pid":21,"hostname":"a4bd45f09ad0","requestId":"108d5803-b70f-422e-9cda-b66004d72ebf","ms":1,"msg":"route_success"}
{"level":30,"time":1755735792495,"pid":21,"hostname":"a4bd45f09ad0","requestId":"hdr-1","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.guards-and-headers.spec.ts
FAIL tests/unit/api.headers.security.spec.ts
  ● security headers (CSP frame-ancestors + X-Frame-Options) › middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

PASS tests/unit/api.quiz-questions.dto.spec.ts
{"level":30,"time":1755735793168,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ab40cb0d-3015-4cef-b31c-a0d077bd3e29","ms":1,"msg":"route_success"}
{"level":30,"time":1755735793169,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7e29219c-d099-48dc-a191-284c2676661f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735793732,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4a36ea5d-7f27-47c1-b666-370adcbf658b","ms":1,"msg":"route_success"}
{"level":30,"time":1755735793733,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2517cdba-5d93-4499-896d-10ee17f43f1f","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.prefs.dto.spec.ts
PASS tests/unit/api.health.spec.ts
FAIL tests/unit/api.events.producers.spec.ts
  ● Event producers (TEST_MODE) › lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ● Event producers (TEST_MODE) › submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

{"level":30,"time":1755735794675,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"aaaaaaaa-aaaa-aaaa-aaaa-000000000111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735795157,"pid":21,"hostname":"a4bd45f09ad0","requestId":"16d52759-69e2-4c20-bdde-26ef78e2b885","ms":0,"msg":"route_success"}
PASS tests/unit/lib.cors.preflight.spec.ts
PASS tests/unit/api.csrf.double-submit.negatives.spec.ts
FAIL tests/unit/api.files.upload-url.quota.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.upload-url.quota.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

PASS tests/unit/apiHandler.ratelimit.spec.ts
FAIL tests/unit/api.reports.dto.spec.ts
  ● reports endpoints headers and DTO-like responses › GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

{"level":30,"time":1755735797025,"pid":21,"hostname":"a4bd45f09ad0","requestId":"015c6600-fe04-4d6d-ba09-a701d8d87926","ms":1,"msg":"route_success"}
{"level":30,"time":1755735797025,"pid":21,"hostname":"a4bd45f09ad0","requestId":"575ca54c-46a2-4037-823e-9cc2d5670092","ms":0,"msg":"route_success"}
{"level":30,"time":1755735797545,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e509b3f9-53cb-41a4-8178-c0b22a96eff4","ms":0,"msg":"route_success"}
FAIL tests/unit/api.notifications.patch.csrf.spec.ts
  ● notifications preferences PATCH respects CSRF double-submit › 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

PASS tests/unit/api.submissions.csrf.negatives.spec.ts
FAIL tests/unit/ui/TeacherAnnouncements.spec.tsx
  ● Teacher Announcements (labs) › renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL tests/unit/api.user-profile.put.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user-profile.put.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

FAIL tests/unit/ui/TeacherCourseInsightsAdvanced.spec.tsx
  ● Teacher Course Insights (Advanced) › renders table and totals with jitter

    TypeError: cookieStore.getAll is not a function

      15 |   const cookieStore = cookies();
      16 |   const incoming = headers();
    > 17 |   const cookieHeader = cookieStore.getAll().map(c => `${c.name}=${c.value}`).join("; ");
         |                                    ^
      18 |   const xTestAuth = incoming.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;
      19 |
      20 |   const baseHeaders: HeadersInit = {

      at TeacherCourseInsightsAdvancedPage (../apps/web/src/app/labs/teacher/course-insights-advanced/page.tsx:17:36)
      at Object.<anonymous> (unit/ui/TeacherCourseInsightsAdvanced.spec.tsx:27:55)

PASS tests/unit/api.notifications-preferences.rate-limit.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL tests/unit/api.providers.create.negatives.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.negatives.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

{"level":30,"time":1755735801808,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0c0d0bf8-9e22-4e89-968d-7512f61252da","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.announcement.spec.ts
FAIL tests/unit/api.providers.create.happy-path.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.happy-path.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

PASS tests/unit/ui/SystemDiagnosticsSuite.spec.tsx
PASS tests/unit/ui/StudentStudyDigest.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 4ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/api.progress.student-map.spec.ts
{"level":30,"time":1755735806327,"pid":21,"hostname":"a4bd45f09ad0","requestId":"43bd04fb-4402-4173-b740-7f00c9727a63","ms":1,"msg":"route_success"}
{"level":30,"time":1755735806328,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rid-1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735806328,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3cd6bf5f-52da-462c-b26d-a1dd16538df2","ms":0,"msg":"route_success"}
{"level":30,"time":1755735806843,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e8a0ba4a-4397-43dd-9c65-d3dc648b49ef","ms":1,"msg":"route_success"}
FAIL tests/unit/api.messages.post.ratelimit.spec.ts
  ● messages POST rate limit headers › returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

PASS tests/unit/server.withRouteTiming.ratelimit.spec.ts
{"level":30,"time":1755735807293,"pid":21,"hostname":"a4bd45f09ad0","requestId":"00ca7691-466d-4085-954c-c74068e80c2e","ms":0,"msg":"route_success"}
{"level":30,"time":1755735807858,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7d438152-ab40-45f0-8834-670efe8d45b2","ms":1,"msg":"route_success"}
{"level":30,"time":1755735807858,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5d8837a5-c1a5-4ade-adc8-9bb0092648e6","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.access.spec.ts
FAIL tests/unit/api.providers.health.ratelimit.spec.ts
  ● providers health rate-limit headers › 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL tests/unit/api.files.quota.enforcement.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.quota.enforcement.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL tests/unit/api.enrollments.launch-token.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.enrollments.launch-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

{"level":50,"time":1755735808356,"pid":21,"hostname":"a4bd45f09ad0","requestId":"206134ae-93ed-4270-a077-2d997aec8a33","ms":0,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755735809868,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a186f64a-720d-40be-b294-24cfa9c84628","ms":0,"msg":"route_success"}
{"level":50,"time":1755735809869,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b04b476d-dc51-44e2-964e-aa98440dac74","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/server.withRouteTiming.metrics.spec.ts
PASS tests/unit/apiHandler.requestId.spec.ts
PASS tests/unit/services.assignments.spec.ts
FAIL tests/unit/gateways/reports.gateway.spec.ts
  ● ReportsGateway › engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ● ReportsGateway › gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

PASS tests/unit/services.messaging.spec.ts
PASS tests/unit/ui/StudentLearningOverviewDetailed.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/ui/StudentLearningOverviewAdvanced.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 5ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/api.registry.versions.rate-limit.spec.ts
{"level":30,"time":1755735813277,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3ba4d13c-33c5-4d34-9655-25e0b5a5cc6c","ms":1,"msg":"route_success"}
{"level":30,"time":1755735813277,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b57ac4df-f474-4929-aefe-b6108be5950c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735813963,"pid":21,"hostname":"a4bd45f09ad0","requestId":"049549df-0454-4f82-99fe-67dfebce5b28","ms":1,"msg":"route_success"}
PASS tests/unit/api.problem-envelope.matrix.spec.ts
FAIL tests/unit/api.files.av-and-quota.negatives.spec.ts
  ● files AV stub and quota exceed › EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

{"level":30,"time":1755735814540,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7bebb219-7802-4fce-95b2-e4b8aa261884","ms":1,"msg":"route_success"}
{"level":50,"time":1755735814540,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5406613b-2f57-48ea-92f4-48b5c6dd48c9","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735814541,"pid":21,"hostname":"a4bd45f09ad0","requestId":"dae24dcd-64f8-4e17-b0b7-c7a3c6ed2b03","ms":1,"msg":"route_success"}
{"level":30,"time":1755735815173,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c6b2e032-28ea-4d5a-a1f5-4a1b5c4b4197","ms":1,"msg":"route_success"}
{"level":30,"time":1755735815174,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8f982c16-471a-4e0a-aa8c-e95684ceae29","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.scoping.spec.ts
PASS tests/unit/api.runtime.checkpoint.preflight.spec.ts
PASS tests/unit/api.messages.threads.spec.ts
{"level":30,"time":1755735816313,"pid":21,"hostname":"a4bd45f09ad0","requestId":"07d715e0-4628-4d06-9ab0-9f35ba91a218","ms":0,"msg":"route_success"}
{"level":30,"time":1755735816315,"pid":21,"hostname":"a4bd45f09ad0","requestId":"23fef34a-faf3-4fbe-9cdf-4ff3cfc463f5","ms":0,"msg":"route_success"}
{"level":30,"time":1755735816315,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1a11443e-5643-4021-9bbf-bf35668fc952","ms":0,"msg":"route_success"}
{"level":30,"time":1755735816952,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bdd781b0-4401-49b5-9c72-1a8d8ba13972","ms":1,"msg":"route_success"}
{"level":30,"time":1755735816952,"pid":21,"hostname":"a4bd45f09ad0","requestId":"17e43841-a31a-4f38-9d3d-5830e802eb93","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.ratelimit.headers.spec.ts
FAIL tests/unit/middleware.coep.flag.spec.ts
  ● middleware COEP flag › sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

PASS tests/unit/api.admin.metrics.spec.ts
{"level":30,"time":1755735817627,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fb91bfd1-0de9-4914-8263-c36fa79f1744","ms":0,"msg":"route_success"}
{"level":30,"time":1755735817628,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4dc201c9-23ac-4169-a063-cf40c594a563","ms":1,"msg":"route_success"}
{"level":30,"time":1755735817628,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0e817ffa-3632-4116-a35e-045f6efed10e","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.edges.spec.ts
PASS tests/unit/api.runtime.auth.exchange.edgecases.spec.ts
{"level":30,"time":1755735818689,"pid":21,"hostname":"a4bd45f09ad0","requestId":"352335c9-5ef6-43cb-ad94-a13117c926a7","ms":1,"msg":"route_success"}
{"level":30,"time":1755735818771,"pid":21,"hostname":"a4bd45f09ad0","requestId":"738a3781-8dac-47b8-bd32-f27084e5b289","ms":81,"msg":"route_success"}
{"level":30,"time":1755735819334,"pid":21,"hostname":"a4bd45f09ad0","requestId":"17bf4a2d-a656-44ff-be49-475836abed5d","ms":1,"msg":"route_success"}
{"level":30,"time":1755735819334,"pid":21,"hostname":"a4bd45f09ad0","requestId":"969b76b9-7b15-46d5-a426-25da44b3af39","ms":0,"msg":"route_success"}
{"level":30,"time":1755735819335,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0ed60166-3a5e-4d60-8053-f94453bb47c0","ms":1,"msg":"route_success"}
{"level":50,"time":1755735819335,"pid":21,"hostname":"a4bd45f09ad0","requestId":"07e9ebd4-949a-401d-8753-3a5731b6bf27","issues":[{"path":"key","message":"Expected boolean, received string"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735819335,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5abcadac-0e8c-45a5-9993-f4769f8dc70c","ms":0,"msg":"route_success"}
FAIL tests/unit/api.flags.spec.ts
  ● Feature flags API (test-mode) › GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL tests/unit/api.runtime.jwks.rotation.spec.ts
  ● runtime JWKS rotation (kid refresh) › on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

{"level":30,"time":1755735819936,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2797f0f9-78c4-4cb2-a069-168a047ebfb1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735820843,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8e70023b-4c86-495e-b5be-6ef30846c104","ms":1,"msg":"route_success"}
{"level":30,"time":1755735820844,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7c828087-e305-44cb-8537-88901d40e900","ms":1,"msg":"route_success"}
{"level":50,"time":1755735820844,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5db487d5-b9c1-4a85-b0df-25b9517d0da1","ms":0,"err":"supabase.from(...).select(...).order is not a function","msg":"route_error"}
FAIL tests/unit/api.reports.activity-retention.spec.ts
  ● API /api/reports/activity & /api/reports/retention (TEST_MODE) › retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL tests/unit/api.files.upload-url.spec.ts
  ● api.files.upload-url › returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

{"level":30,"time":1755735821414,"pid":21,"hostname":"a4bd45f09ad0","requestId":"917a9c13-f080-4876-bf75-7a263d56b558","ms":1,"msg":"route_success"}
{"level":30,"time":1755735821415,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e4660d5b-61ee-4d74-9c8c-9484c1d16390","ms":1,"msg":"route_success"}
{"level":30,"time":1755735822050,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4e603315-166b-422d-b03f-fc70551ffa79","ms":1,"msg":"route_success"}
{"level":30,"time":1755735822050,"pid":21,"hostname":"a4bd45f09ad0","requestId":"236c04ce-8fec-4041-a8d9-55d2ac1f7b24","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.auth.aud-and-scopes.spec.ts
FAIL tests/unit/api.courses.transfer-owner.ratelimit.spec.ts
  ● courses transfer-owner rate-limit headers › returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

{"level":50,"time":1755735822533,"pid":21,"hostname":"a4bd45f09ad0","requestId":"865a098b-bf04-4058-b745-bf604c5b452b","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755735823109,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6f02343a-e548-4073-90a9-b8efc0a027da","ms":1,"msg":"route_success"}
PASS tests/unit/api.assignments.delete.ratelimit.spec.ts
PASS tests/unit/api.progress.rls.negatives.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.guard.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.guard.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

{"level":30,"time":1755735823480,"pid":21,"hostname":"a4bd45f09ad0","requestId":"58e1bcb4-d7b6-49ae-ade3-315c1c8064a9","ms":1,"msg":"route_success"}
{"level":30,"time":1755735823480,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8b70e1cd-c862-49ec-b0a0-c00d481ff1fa","ms":0,"msg":"route_success"}
{"level":30,"time":1755735824569,"pid":21,"hostname":"a4bd45f09ad0","requestId":"077f4bdc-711f-4ac3-9da6-9718c27a1b44","ms":1,"msg":"route_success"}
{"level":30,"time":1755735824570,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7ee014b4-a37e-4ac0-b5b0-b2695f1ad692","ms":0,"msg":"route_success"}
PASS tests/unit/api.parent-links.ratelimit.spec.ts
FAIL tests/unit/api.files.upload-url.ratelimit.spec.ts
  ● files upload-url rate limit headers › 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

{"level":30,"time":1755735825099,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4276d8e2-1c95-4d64-9efa-d7052ae3b2a7","ms":1,"msg":"route_success"}
PASS tests/unit/ui/ParentAnnouncementsLab.spec.tsx
FAIL tests/unit/api.attachments.delete.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.attachments.delete.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

FAIL tests/unit/lib.serverFetch.extend.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 http://web:3022http://example.com/api/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch extended › absolute URL passes through unchanged

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://example.com/api/x"
    Received: "http://web:3022http://example.com/api/x"

       9 |     try {
      10 |       await serverFetch('http://example.com/api/x');
    > 11 |       expect(calls[0].url).toBe('http://example.com/api/x');
         |                            ^
      12 |     } finally {
      13 |       global.fetch = old;
      14 |     }

      at Object.<anonymous> (unit/lib.serverFetch.extend.spec.ts:11:28)

PASS tests/unit/ui/StudentLearningOverview.spec.tsx
FAIL tests/unit/api.courses.transfer-owner.auth.spec.ts
  ● API /api/courses/[id]/transfer-owner auth › non-admin and non-owner → 403

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:14:17)

FAIL tests/unit/api.user.role.audit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user.role.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

{"level":30,"time":1755735826466,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4bb3b596-210f-4d90-a27a-cf0df7244790","ms":0,"msg":"route_success"}
{"level":50,"time":1755735826467,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a0e0f6eb-0b92-42fc-828b-610b87c5e621","ms":0,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
PASS tests/unit/schemas.message.spec.ts
PASS tests/unit/api.registry.courses.rate-limit.spec.ts
{"level":30,"time":1755735828028,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8ff260fc-09fd-4c69-8274-2846894ecc7c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735828028,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e7eac197-0804-4021-beac-a5310892cd7b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735828555,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c8c09e20-d108-45b9-84ec-cdc2af303aff","ms":1,"msg":"route_success"}
{"level":30,"time":1755735828557,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4e631525-b858-4046-b1cd-7ba76c3bd869","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.per-student.spec.ts
PASS tests/unit/server.withRouteTiming.csrf-double-submit.spec.ts
PASS tests/unit/api.runtime.context.roles.spec.ts
{"level":30,"time":1755735829469,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ffa0eb00-0ee8-4b76-a0dc-ef8c55716edc","ms":1,"msg":"route_success"}
{"level":30,"time":1755735829484,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e36215ab-c72f-4378-b015-96e8dad28377","ms":15,"msg":"route_success"}
PASS tests/unit/schemas.submission.spec.ts
FAIL tests/unit/lib.metrics.inflight.spec.ts
  ● metrics in-flight tracking › increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      21 |     incrInFlight(route);
      22 |     let s1 = snapshot();
    > 23 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      24 |     decrInFlight(route);
      25 |     decrInFlight(route);
      26 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:23:41)

{"level":30,"time":1755735830312,"pid":21,"hostname":"a4bd45f09ad0","requestId":"74c2eecd-aa62-46f0-a375-fdc65b484e2c","ms":0,"msg":"route_success"}
{"level":30,"time":1755735830908,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f11ca795-fc99-4e9f-8841-8c1d6ed35827","ms":1,"msg":"route_success"}
PASS tests/unit/api.lessons.spec.ts
PASS tests/unit/api.role.access.matrix.spec.ts
{"level":20,"time":1755735831522,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755735831522,"pid":21,"hostname":"a4bd45f09ad0","requestId":"662b27b0-86c5-4758-99e2-fd5594b0b14f","ms":1,"msg":"route_success"}
{"level":20,"time":1755735831523,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755735831530,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c21d64c0-4ac2-4dd0-8afa-bb2d2ff7b546","ms":7,"msg":"route_success"}
{"level":30,"time":1755735831531,"pid":21,"hostname":"a4bd45f09ad0","requestId":"34b16ffc-a85e-43b7-a93b-f4a83dde5467","ms":0,"msg":"route_success"}
{"level":30,"time":1755735831531,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c9d06c46-4431-4fef-a150-6d4a76bf9d52","ms":0,"msg":"route_success"}
{"level":30,"time":1755735831532,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d670d6e8-61cd-4f83-ac35-ed4fcce845ab","ms":0,"msg":"route_success"}
{"level":30,"time":1755735831532,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d2003b9d-b658-4fb7-80c1-28aad38a66e1","ms":0,"msg":"route_success"}
{"level":30,"time":1755735831532,"pid":21,"hostname":"a4bd45f09ad0","requestId":"46e4ac50-f818-47f4-95f3-15360c59c1c8","ms":0,"msg":"route_success"}
{"level":30,"time":1755735831533,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8e2c6f95-e39f-4faa-99d4-17d8e38f5641","ms":0,"msg":"route_success"}
{"level":50,"time":1755735832067,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0545770a-c331-4bf7-8132-d8177de1a159","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735832067,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5fa0b528-4e9b-4e2a-ab92-1c62c6c1d5c0","ms":1,"msg":"route_success"}
{"level":50,"time":1755735832068,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1cf1a8d5-7832-4c3c-abf9-e5c029d45a48","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735832068,"pid":21,"hostname":"a4bd45f09ad0","requestId":"29fa6863-12e8-41c6-ba1f-88f53111a159","ms":1,"msg":"route_success"}
PASS tests/unit/api.assignments.delete.ratelimit.headers.spec.ts
PASS tests/unit/api.messages.list.ratelimit.spec.ts
{"level":30,"time":1755735832642,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4170abb4-2a04-4c44-8b47-0f40abba6545","ms":0,"msg":"route_success"}
{"level":30,"time":1755735832643,"pid":21,"hostname":"a4bd45f09ad0","requestId":"01df95b8-c532-40b0-8ee3-d9e67ca2c5de","ms":0,"msg":"route_success"}
{"level":30,"time":1755735833386,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735833386,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e0fd0e7b-c59a-4f5a-a656-384deb80f19f","ms":1,"msg":"route_success"}
{"level":30,"time":1755735833386,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735833386,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5007ba79-2515-4d53-9920-14ab5e4ddc1d","ms":0,"msg":"route_success"}
PASS tests/unit/api.lessons.complete.idempotent.spec.ts
PASS tests/unit/api.files.download-url.disposition.spec.ts
{"level":30,"time":1755735833937,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d6dc81ca-5f19-4fda-aa5f-8cd9c7310290","ms":1,"msg":"route_success"}
PASS tests/unit/services.modules.spec.ts
PASS tests/unit/ui/SystemPercentileTrends.spec.tsx
PASS tests/unit/schemas.lesson.spec.ts
PASS tests/unit/api.messages.patch.ratelimit.spec.ts
{"level":30,"time":1755735836486,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0dc9a635-8a4c-478d-b549-2ed0eebe546b","ms":1,"msg":"route_success"}
{"level":30,"time":1755735836882,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0ac3c48b-8371-4fce-8c50-c04c8cf75fdb","ms":1,"msg":"route_success"}
{"level":30,"time":1755735836883,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8aa4c945-ab6a-4ec5-814e-b5100ae7462a","ms":1,"msg":"route_success"}
FAIL tests/unit/api.analytics.events.emit.spec.ts
  ● API /api/events (analytics ingestion) › teacher authed → 2xx

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 201]

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'teacher');
      16 |     const res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'z', meta: {} }));
    > 17 |     expect([200,201]).toContain(res.status);
         |                       ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.analytics.events.emit.spec.ts:17:23)

FAIL tests/unit/ui/AdminReports.spec.tsx
  ● Admin Reports (dashboard) › renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

PASS tests/unit/api.user-profile.spec.ts
{"level":30,"time":1755735838349,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1b7e470c-b1aa-41ca-98d8-8d727400fa81","ms":1,"msg":"route_success"}
{"level":30,"time":1755735838350,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9bdd1bef-7866-4b15-bc00-55027b950dd6","ms":1,"msg":"route_success"}
{"level":30,"time":1755735838350,"pid":21,"hostname":"a4bd45f09ad0","requestId":"488903db-926a-4b16-afe5-8bde6fc6662d","ms":0,"msg":"route_success"}
{"level":30,"time":1755735838905,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7a701952-b805-40ad-b8ab-c76a7970ca80","ms":1,"msg":"route_success"}
{"level":30,"time":1755735838906,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4bcbd2ec-9286-44f2-8888-545e091d1ad5","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.announcements.negative.spec.ts
PASS tests/unit/api.internal.metrics.token.spec.ts
{"level":30,"time":1755735839484,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3e134a0c-4f7a-4c23-9586-ed9bbdca38a1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735839484,"pid":21,"hostname":"a4bd45f09ad0","requestId":"913d6d1d-73c6-4d1a-a231-844354094def","ms":0,"msg":"route_success"}
{"level":30,"time":1755735840077,"pid":21,"hostname":"a4bd45f09ad0","requestId":"64d91848-ad4f-41bf-b4fe-012f0e034c67","ms":0,"msg":"route_success"}
{"level":30,"time":1755735840078,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0e72feee-6517-430d-9c95-4ea42e7490d5","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.parent-links.negative.spec.ts
PASS tests/unit/api.modules.delete.ratelimit.spec.ts
{"level":30,"time":1755735840684,"pid":21,"hostname":"a4bd45f09ad0","requestId":"73a97cf3-5eef-49bf-8bd5-48a1bc5ac2c9","ms":1,"msg":"route_success"}
{"level":50,"time":1755735841171,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2c110206-829c-4c08-aacf-42dd1f523293","ms":1,"err":"supabase.from(...).upsert is not a function","msg":"route_error"}
FAIL tests/unit/api.admin.quotas.ratelimit.spec.ts
  ● admin quotas PATCH rate-limit headers › returns 429 and retry-after header when limited

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

FAIL tests/unit/gateways/enrollments.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/enrollments 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● EnrollmentsGateway.list › returns enrollments array

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "course_id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "course_id"
        ]
      }
    ]

      112 |     throw new Error(`${code}: ${message}`);
      113 |   }
    > 114 |   return schema.parse(json) as T;
          |                 ^
      115 | }
      116 |
      117 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:114:17)
      at Object.<anonymous> (unit/gateways/enrollments.gateway.spec.ts:27:18)

FAIL tests/unit/db.rls.courses.negative.spec.ts
  ● Courses RLS/authorization negatives › student cannot create course

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/courses', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ title: 'X', description: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot delete course', async () => {

      at Object.<anonymous> (unit/db.rls.courses.negative.spec.ts:6:23)

{"level":30,"time":1755735842200,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5e8fc96a-1fa7-4041-9689-f3f1812d5449","ms":1,"msg":"route_success"}
{"level":30,"time":1755735842216,"pid":21,"hostname":"a4bd45f09ad0","requestId":"33a8e907-4981-4019-af19-7249b5cd8e5f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735842701,"pid":21,"hostname":"a4bd45f09ad0","requestId":"78582a80-0997-48a5-bf70-9791ce7c3123","ms":1,"msg":"route_success"}
PASS tests/unit/api.providers.health.ratelimit.headers.spec.ts
PASS tests/unit/schemas.assignment.spec.ts
PASS tests/unit/api.submissions.list.pagination.spec.ts
{"level":30,"time":1755735843660,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d615374f-45f9-4f45-9c5d-a41de58a3a89","ms":1,"msg":"route_success"}
{"level":30,"time":1755735844147,"pid":21,"hostname":"a4bd45f09ad0","requestId":"aa5dc11f-4ccd-404c-9384-b593450a3584","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.checkpoint.roundtrip.spec.ts
PASS tests/unit/api.submissions.grade.spec.ts
{"level":30,"time":1755735844808,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0f29b25c-f84c-4c7b-83bc-5c1f1925a75b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735844809,"pid":21,"hostname":"a4bd45f09ad0","requestId":"83411828-79a2-48bc-a66f-61f520d910e7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735844809,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ff8e6b8f-2592-4437-b637-1f8ee659fb27","ms":0,"msg":"route_success"}
PASS tests/unit/ui/StudentUpcomingLessons.spec.tsx
PASS tests/unit/api.notifications.auth.spec.ts
{"level":30,"time":1755735845515,"pid":21,"hostname":"a4bd45f09ad0","requestId":"80933b38-1991-414e-9fae-931b71ed8caa","ms":0,"msg":"route_success"}
{"level":30,"time":1755735845516,"pid":21,"hostname":"a4bd45f09ad0","requestId":"63167fc2-e5b8-499f-8259-fc6ca5aa82dc","ms":0,"msg":"route_success"}
PASS tests/unit/ui/SystemObserver.spec.tsx
FAIL tests/unit/lib.runtimeAuth.scopes-aud.spec.ts
  ● runtimeAuth audience and scopes › rejects when aud mismatches allowed origin

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /workspace/tests/node_modules/jose/dist/webapi/index.js:1
    ({"Object.<anonymous>":function(module,exports,require,__dirname,__filename,jest){export { compactDecrypt } from './jwe/compact/decrypt.js';
                                                                                      ^^^^^^

    SyntaxError: Unexpected token 'export'

      10 |     // Mock getRequestOrigin to return allowed origin and jose verify to return payload with different aud
      11 |     jest.spyOn(require('../../apps/web/src/lib/cors'), 'getRequestOrigin').mockReturnValue('https://good.example' as any);
    > 12 |     jest.spyOn(require('jose') as any, 'jwtVerify').mockResolvedValue({ payload: { aud: 'https://bad.example', scopes: [] } });
         |                ^
      13 |     const out = verifyRuntimeAuthorization(req as any, [] as any) as any;
      14 |     expect(out).toBeTruthy();
      15 |   });

      at Runtime.createScriptFromCode (../node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (unit/lib.runtimeAuth.scopes-aud.spec.ts:12:16)

PASS tests/unit/ui/SystemHealthHistory.spec.tsx
FAIL tests/unit/lib.runtimeAuth.clockskew.spec.ts
  ● runtimeAuth clock skew tolerance › accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

PASS tests/unit/ui/TeacherCourseInsights.spec.tsx
PASS tests/unit/db.rls.submissions.negative.spec.ts
{"level":30,"time":1755735848464,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c973c409-3ee1-4af5-801d-8fdd2f1ef6ef","ms":1,"msg":"route_success"}
{"level":30,"time":1755735848465,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8adc0782-4e8c-40a0-b7a1-bf6c2c8d549e","ms":1,"msg":"route_success"}
{"level":30,"time":1755735849019,"pid":21,"hostname":"a4bd45f09ad0","requestId":"319c3c89-50d1-40b0-9e27-b424c107537e","ms":1,"msg":"route_success"}
{"level":30,"time":1755735849019,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3e6e2cb3-11f8-4d7a-962e-c7576cd61d6a","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.prefs.auth.spec.ts
PASS tests/unit/lib.rateLimit.redis-fallback.spec.ts
PASS tests/unit/api.runtime.idempotency.progress.spec.ts
{"level":30,"time":1755735849476,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4de3f5ff-f5e8-479d-ac6f-2584da2ed5f4","ms":10,"msg":"route_success"}
{"level":30,"time":1755735849482,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a52fdd87-d1eb-427d-8210-4a01c303fd5c","ms":6,"msg":"route_success"}
{"level":30,"time":1755735849981,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b647325e-8615-4596-bfb3-799c1ef1cbad","ms":1,"msg":"route_success"}
FAIL tests/unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ● runtime outcomes provider JWT iss/aud negatives › invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

PASS tests/unit/ui/SystemRequestId.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/health 6ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/ui/SystemLatencySampler.spec.tsx
PASS tests/unit/lib.csp.frame-src-allow.spec.ts
PASS tests/unit/db.rls.quiz-attempts.negative.spec.ts
{"level":30,"time":1755735852052,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6681ecee-46f3-4c50-bed7-c2dd3af88768","ms":0,"msg":"route_success"}
{"level":30,"time":1755735852053,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f1ee6ab1-3670-4940-80f9-c59b8040e893","ms":0,"msg":"route_success"}
{"level":30,"time":1755735852555,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7a6e60f2-ecf7-460b-b2bf-3fb13eca3571","ms":0,"msg":"route_success"}
{"level":20,"time":1755735852556,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755735852556,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1c1d1d40-d40a-4f35-9f60-db71fd9ffaad","ms":0,"msg":"route_success"}
PASS tests/unit/api.dashboard.spec.ts
PASS tests/unit/api.submissions.grade.validation.spec.ts
{"level":30,"time":1755735852978,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f836d7d8-2070-47cc-b712-6df0e147b75a","ms":0,"msg":"route_success"}
{"level":30,"time":1755735852979,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0206cb3e-7a71-4d4a-b1bc-962d4c6fa16f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735853429,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5306fc4e-0884-4dfe-91d9-bd7ee508c5d0","ms":0,"msg":"route_success"}
{"level":30,"time":1755735853430,"pid":21,"hostname":"a4bd45f09ad0","requestId":"20aa4a95-7f1d-4797-8d13-d2fe321f1baa","ms":0,"msg":"route_success"}
FAIL tests/unit/api.messages.threads.auth.spec.ts
  ● API /api/messages/threads auth › unauthenticated POST → 401

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 400

      12 |   test('unauthenticated POST → 401', async () => {
      13 |     const res = await (ThreadsPOST as any)(post('http://localhost/api/messages/threads', { participant_ids: [] }));
    > 14 |     expect(res.status).toBe(401);
         |                        ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/api.messages.threads.auth.spec.ts:14:24)

PASS tests/unit/db.rls.messages.negative.spec.ts
{"level":30,"time":1755735853879,"pid":21,"hostname":"a4bd45f09ad0","requestId":"65b416a2-6a6a-4f43-9986-7bbb2cff3a31","ms":0,"msg":"route_success"}
{"level":30,"time":1755735853880,"pid":21,"hostname":"a4bd45f09ad0","requestId":"94489dba-03af-49c4-9fe8-5bda652f973f","ms":0,"msg":"route_success"}
{"level":30,"time":1755735854274,"pid":21,"hostname":"a4bd45f09ad0","requestId":"44ee903d-94b9-4810-8655-ead7528e78b9","ms":0,"msg":"route_success"}
PASS tests/unit/api.problem.envelope.codes.spec.ts
PASS tests/unit/ui/SystemUptimeTile.spec.tsx
PASS tests/unit/schemas.files.spec.ts
PASS tests/unit/api.messages.patch-negatives.spec.ts
{"level":30,"time":1755735855784,"pid":21,"hostname":"a4bd45f09ad0","requestId":"m-p1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735855784,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5e43a295-f9ad-437a-90e8-88896c772b54","ms":0,"msg":"route_success"}
{"level":30,"time":1755735856246,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4870e5fc-2117-4ffc-8a80-2bc51ae91a5b","ms":1,"msg":"route_success"}
PASS tests/unit/api.reports.grade-distribution.empty.spec.ts
PASS tests/unit/lib.serverFetch.baseurl.spec.ts
FAIL tests/unit/ui/StudentProfile.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/user/profile 6ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● Student Profile (labs) › renders email and role when authenticated

    Unable to find an element by: [data-testid="profile-email"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6 space-y-3"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
            [33mdata-testid[39m=[32m"profile-title"[39m
          [36m>[39m
            [0mStudent Profile[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
            [33mdata-testid[39m=[32m"signin-prompt"[39m
          [36m>[39m
            [0mYou are not signed in[0m
          [36m</p>[39m
          [36m<a[39m
            [33mclass[39m=[32m"underline"[39m
            [33mdata-testid[39m=[32m"signin-link"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mGo to login[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await StudentProfilePage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('profile-email')).toHaveTextContent('s@example.com');
         |                         ^
      18 |     expect(await screen.findByTestId('profile-role')).toHaveTextContent('student');
      19 |   });
      20 | });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/StudentProfile.spec.tsx:17:25)

PASS tests/unit/modules.update.spec.ts
PASS tests/unit/services.assignments.producer.spec.ts
PASS tests/unit/api.reports.engagement.headers.spec.ts
{"level":30,"time":1755735860050,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6b4a68f7-2d7b-4491-b24f-9389eb6a53ad","ms":1,"msg":"route_success"}
PASS tests/unit/ui/StudentPlanner.spec.tsx
PASS tests/unit/server.scheduler.spec.ts
PASS tests/unit/ui/SystemRoleBadge.spec.tsx
PASS tests/unit/api.user.profile.auth.spec.ts
{"level":30,"time":1755735862730,"pid":21,"hostname":"a4bd45f09ad0","requestId":"85c7eeec-9c88-4f10-81f7-ca4fd0d90d1a","ms":0,"msg":"route_success"}
{"level":30,"time":1755735862731,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6a205713-b6c1-4e11-a153-bf6dee74b035","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.outcomes.preflight.spec.ts
FAIL tests/unit/ui/SystemAuthCheck.spec.tsx
  ● System Auth Check (labs) › renders email and role when authenticated

    TypeError: cookieStore.getAll is not a function

      14 |
      15 |   const cookieHeader = incomingHeaders.get("cookie") ?? cookieStore
    > 16 |     .getAll()
         |      ^
      17 |     .map((c) => `${c.name}=${c.value}`)
      18 |     .join("; ");
      19 |   const testAuthHeader = incomingHeaders.get("x-test-auth") ?? "";

      at AuthCheckPage (../apps/web/src/app/labs/system/auth-check/page.tsx:16:6)
      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:15:35)

PASS tests/unit/api.pagination.params.spec.ts
{"level":30,"time":1755735865479,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7e0539af-bc34-465d-bbaf-4585f9b22e38","ms":0,"msg":"route_success"}
{"level":30,"time":1755735866246,"pid":21,"hostname":"a4bd45f09ad0","requestId":"af5bdee2-eefc-42e7-b1fb-04ebc626f7d9","ms":1,"msg":"route_success"}
{"level":30,"time":1755735866257,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7911a985-00e8-4e03-a481-751df9444762","ms":10,"msg":"route_success"}
FAIL tests/unit/api.parent.progress.api.spec.ts
  ● API /api/parent/progress (TEST_MODE) › parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

PASS tests/unit/api.files.upload-url.content-type.spec.ts
{"level":30,"time":1755735866835,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d55b3596-e461-41af-9f10-73f71323f03b","ms":1,"msg":"route_success"}
FAIL tests/unit/ui/ParentChildrenReport.spec.tsx
  ● Parent Children Report (labs) › renders total and items

    TypeError: c.getAll is not a function

       8 |   const h = headers();
       9 |   const c = cookies();
    > 10 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      11 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      12 |
      13 |   let rows: ParentLink[] = [];

      at ParentChildrenReportPage (../apps/web/src/app/labs/parent/children-report/page.tsx:10:45)
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:17:46)

PASS tests/unit/services.notifications.spec.ts
FAIL tests/unit/ui/SystemOkCard.spec.tsx
  ● System OK Card (labs) › renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

PASS tests/unit/api.reports.grade-distribution.headers.spec.ts
{"level":30,"time":1755735869495,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a15b820c-2793-40ea-a59f-edc0993e5960","ms":0,"msg":"route_success"}
PASS tests/unit/lib.logger.redaction.extended.spec.ts
PASS tests/unit/services.submissions.spec.ts
PASS tests/unit/api.runtime.asset.sign-url.preflight.spec.ts
PASS tests/unit/gateways/announcements.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/announcements 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/sdk.fetchJson.spec.ts
  ● Console

    console.debug
      [serverFetch] 400 /x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /y 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/schemas.progress.spec.ts
FAIL tests/unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ● runtime outcomes strict iss/aud enforcement › issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

{"level":30,"time":1755735872115,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3490ccc8-2c3e-41bd-abeb-e34499fc9354","ms":1,"msg":"route_success"}
{"level":30,"time":1755735872789,"pid":21,"hostname":"a4bd45f09ad0","requestId":"n1","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.guard.spec.ts
PASS tests/unit/ui/TeacherCourseCardsWithCounts.spec.tsx
PASS tests/unit/api.runtime.events.preflight.spec.ts
PASS tests/unit/api.routeTiming.spec.ts
{"level":30,"time":1755735873948,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-1","ms":0,"msg":"route_success"}
{"level":50,"time":1755735873949,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-2","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/ui/TeacherPrintPages.spec.tsx
PASS tests/unit/api.runtime.grade.cors.preflight.spec.ts
PASS tests/unit/ui/NotificationsInboxPage.spec.tsx
PASS tests/unit/ui/DropdownMenu.spec.tsx
PASS tests/unit/api.user.role.auth.spec.ts
{"level":30,"time":1755735875703,"pid":21,"hostname":"a4bd45f09ad0","requestId":"8a059fe0-a499-42d3-9a82-bed8e63358bb","ms":1,"msg":"route_success"}
{"level":30,"time":1755735875704,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ccaaba91-3482-47a5-bf0b-a018ab537bfa","ms":1,"msg":"route_success"}
{"level":30,"time":1755735876248,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f6614aea-0e36-4d8d-85f7-afce56525957","ms":0,"msg":"route_success"}
{"level":30,"time":1755735876248,"pid":21,"hostname":"a4bd45f09ad0","requestId":"73fa5973-cf1c-444f-afcc-3173f94853c0","ms":0,"msg":"route_success"}
PASS tests/unit/api.submissions.get-required.spec.ts
PASS tests/unit/api.internal.metrics.auth.spec.ts
{"level":30,"time":1755735876749,"pid":21,"hostname":"a4bd45f09ad0","requestId":"bd304ac9-b2f1-4151-be3e-0ac06cacabce","ms":1,"msg":"route_success"}
{"level":30,"time":1755735876749,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3cb4be87-62c0-4d07-88c6-93c521c584fd","ms":0,"msg":"route_success"}
FAIL tests/unit/ui/ParentChildren.spec.tsx
  ● Parent Children (labs) › renders list with one linked student

    TypeError: c.getAll is not a function

       9 | 	const h = headers();
      10 | 	const c = cookies();
    > 11 | 	const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                          ^
      12 | 	const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      13 |
      14 | 	let links: ParentLink[] = [];

      at ParentChildrenListPage (../apps/web/src/app/labs/parent/children/page.tsx:11:44)
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:15:44)

PASS tests/unit/api.messages.list.pagination.params.spec.ts
{"level":30,"time":1755735878694,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0b7b5ac2-2af1-4c42-acd4-d7b20564bff6","ms":0,"msg":"route_success"}
{"level":30,"time":1755735879518,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a6cde6be-6681-4984-b71e-d4be73383d43","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.context.dto-requestid.spec.ts
PASS tests/unit/api.internal.metrics.content-type.spec.ts
{"level":30,"time":1755735880197,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5a18beee-3c8d-4aed-b065-56288e057894","ms":0,"msg":"route_success"}
{"level":30,"time":1755735880819,"pid":21,"hostname":"a4bd45f09ad0","requestId":"56c998bf-9f5d-4be9-9b26-80430f01b53d","ms":1,"msg":"route_success"}
FAIL tests/unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ● runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement › rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

PASS tests/unit/api.messages.threads.pagination.params.spec.ts
{"level":30,"time":1755735881325,"pid":21,"hostname":"a4bd45f09ad0","requestId":"349d2f4c-9ab9-4f2e-861d-b1591074ca7a","ms":1,"msg":"route_success"}
{"level":30,"time":1755735881676,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5b5e741d-81f6-4d2d-9fee-f439a9d36733","ms":0,"msg":"route_success"}
PASS tests/unit/api.reports.csv.content-type.spec.ts
PASS tests/unit/schemas.quiz.extend2.spec.ts
PASS tests/unit/ui/TeacherAnalyticsLab.spec.tsx
PASS tests/unit/api.dashboard.teacher-kpis.spec.ts
{"level":20,"time":1755735882243,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755735882243,"pid":21,"hostname":"a4bd45f09ad0","requestId":"rq-99","ms":1,"msg":"route_success"}
{"level":30,"time":1755735882577,"pid":21,"hostname":"a4bd45f09ad0","requestId":"16c76c6e-fdbf-4b40-a573-9de180f1f363","ms":0,"msg":"route_success"}
PASS tests/unit/api.providers.list.dto.spec.ts
PASS tests/unit/services.parentLinks.spec.ts
PASS tests/unit/schemas.strictness.spec.ts
PASS tests/unit/schemas.auth.spec.ts
PASS tests/unit/api.reports.export.headers.spec.ts
{"level":30,"time":1755735883856,"pid":21,"hostname":"a4bd45f09ad0","requestId":"90187def-37ba-4b56-aa24-5a2889a19222","ms":1,"msg":"route_success"}
{"level":30,"time":1755735884342,"pid":21,"hostname":"a4bd45f09ad0","requestId":"pid-1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735884342,"pid":21,"hostname":"a4bd45f09ad0","requestId":"pid-1","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.request-id.spec.ts
PASS tests/unit/ui/DarkModeToggle.spec.tsx
PASS tests/unit/api.user.role.headers.spec.ts
{"level":30,"time":1755735885279,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f9b13c9c-2c51-42a6-a826-ba7a40c317b7","ms":0,"msg":"route_success"}
{"level":30,"time":1755735885851,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4d7c6d21-6feb-4b31-b6c1-feb58be210cd","ms":0,"msg":"route_success"}
{"level":30,"time":1755735885852,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c565213c-871c-44bf-8e70-fec7cab8237b","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.download-url.spec.ts
FAIL tests/unit/api.messages.read-all-thread.spec.ts
  ● messages read-all by thread id › student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

{"level":50,"time":1755735886337,"pid":21,"hostname":"a4bd45f09ad0","requestId":"40fd97c6-bfbf-4719-ba63-cf63e250d9b1","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755735886337,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0ffcc110-65a8-4725-9772-67f7a951aa52","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.parentLink.spec.ts
FAIL tests/unit/lib.testMode.spec.ts
  ● testMode › isTestMode false otherwise

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      22 |     delete (process.env as any).TEST_MODE;
      23 |     delete (process.env as any).PLAYWRIGHT;
    > 24 |     expect(isTestMode()).toBe(false);
         |                          ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/lib.testMode.spec.ts:24:26)

FAIL tests/unit/gateways.registry.pagination.spec.ts
  ● RegistryGateway listCourses (test mode) › returns rows matching externalCourse schema and totalCount

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          2,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          3,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          4,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          5,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          6,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          7,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          8,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          9,
          "id"
        ]
      }
    ]

      13 |     expect(Array.isArray(rows)).toBe(true);
      14 |     expect(typeof totalCount).toBe('number');
    > 15 |     z.array(externalCourse).parse(rows);
         |                             ^
      16 |   });
      17 | });
      18 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at Object.<anonymous> (unit/gateways.registry.pagination.spec.ts:15:29)

PASS tests/unit/api.assignments.patch-missing-id.spec.ts
{"level":30,"time":1755735887958,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a-p1","ms":2,"msg":"route_success"}
{"level":30,"time":1755735888604,"pid":21,"hostname":"a4bd45f09ad0","requestId":"26acbf05-a953-4034-96e6-a87fa4251f0e","ms":0,"msg":"route_success"}
PASS tests/unit/api.user.profile.headers.spec.ts
PASS tests/unit/api.providers.health.summaries.auth.spec.ts
{"level":30,"time":1755735889245,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3d08aaf4-9fec-49c1-b7af-884cff475d5e","ms":0,"msg":"route_success"}
{"level":30,"time":1755735889246,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a2a8104d-a384-4f2c-8091-1f53e8999c33","ms":0,"msg":"route_success"}
{"level":30,"time":1755735889621,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ee62bfee-e0c7-4229-b0a4-209b12be972c","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.teacher-counts.spec.ts
PASS tests/unit/schemas.event.spec.ts
FAIL tests/unit/api.messages.guard.spec.ts
  ● api.messages guard (MVP_PROD_GUARD) › guard enforced in production-like (non test-mode)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 501]

      11 |     const res = await (MessagesGET as any)(makeReq('http://localhost/api/messages?thread_id=th1', { 'x-test-auth': 'student' }));
      12 |     // In non test-mode, auth may fail or MVP guard may block; accept 401 or 501
    > 13 |     expect([401, 501]).toContain(res.status);
         |                        ^
      14 |   });
      15 | });
      16 |

      at Object.<anonymous> (unit/api.messages.guard.spec.ts:13:24)

{"level":30,"time":1755735890585,"pid":21,"hostname":"a4bd45f09ad0","requestId":"fcfe4c6f-aa0e-4d62-ad2a-8dc5b9b6e0e6","ms":1,"msg":"route_success"}
PASS tests/unit/ui/telemetry.spec.tsx
PASS tests/unit/api.messages.missing-thread.spec.ts
{"level":30,"time":1755735891469,"pid":21,"hostname":"a4bd45f09ad0","requestId":"m1","ms":1,"msg":"route_success"}
{"level":30,"time":1755735892039,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3eb1f726-5677-40ac-a911-963ed1e5fa6b","ms":1,"msg":"route_success"}
PASS tests/unit/api.registry.versions.dto.spec.ts
PASS tests/unit/api.assignments.list.spec.ts
{"level":30,"time":1755735892509,"pid":21,"hostname":"a4bd45f09ad0","requestId":"1569fb21-23f6-4f0b-a9c0-f4f0c5038f33","ms":1,"msg":"route_success"}
{"level":30,"time":1755735892509,"pid":21,"hostname":"a4bd45f09ad0","requestId":"f6c6bb19-9422-4416-950c-6960953a5e6b","ms":0,"msg":"route_success"}
{"level":30,"time":1755735892968,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ca214a33-57f1-412c-971c-7a9a5d565c0b","ms":1,"msg":"route_success"}
{"level":30,"time":1755735892968,"pid":21,"hostname":"a4bd45f09ad0","requestId":"42d71754-68c8-4f3e-bdb2-6d33c82d972d","ms":0,"msg":"route_success"}
PASS tests/unit/api.teacher.grading-queue.auth.spec.ts
PASS tests/unit/api.admin.metrics.auth.spec.ts
{"level":30,"time":1755735893463,"pid":21,"hostname":"a4bd45f09ad0","requestId":"66ea4078-5b9e-4cdb-999c-48de54f38b9d","ms":0,"msg":"route_success"}
{"level":30,"time":1755735893464,"pid":21,"hostname":"a4bd45f09ad0","requestId":"dac8ddf2-3fd9-4a01-86d9-7d75f28574d2","ms":1,"msg":"route_success"}
{"level":30,"time":1755735893964,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0d7039a6-1082-4b0b-a289-8d30f8e39ad9","ms":0,"msg":"route_success"}
{"level":30,"time":1755735893965,"pid":21,"hostname":"a4bd45f09ad0","requestId":"a0b67ede-9600-445b-b23f-2af946a306ae","ms":0,"msg":"route_success"}
PASS tests/unit/api.admin.export.auth.spec.ts
PASS tests/unit/db.rls.registry.negative.spec.ts
{"level":30,"time":1755735894516,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ab439783-1412-4e63-a58d-7fee7da95e26","ms":1,"msg":"route_success"}
PASS tests/unit/gateways.messages.port-flag.spec.ts
PASS tests/unit/api.admin.metrics.text.spec.ts
{"level":30,"time":1755735895432,"pid":21,"hostname":"a4bd45f09ad0","requestId":"6505bfaa-fa62-4e87-9817-6a87928895af","ms":1,"msg":"route_success"}
{"level":30,"time":1755735895953,"pid":21,"hostname":"a4bd45f09ad0","requestId":"ap-eb","ms":0,"msg":"route_success"}
PASS tests/unit/api.assignments.patch-empty-body.spec.ts
FAIL tests/unit/env.validation.spec.ts
  ● environment validation › prod with TEST_MODE=1 throws unless explicitly allowed

    expect(received).toThrow(expected)

    Expected pattern: /TEST_MODE must not be enabled/

    Received function did not throw

      12 |   test('prod with TEST_MODE=1 throws unless explicitly allowed', () => {
      13 |     process.env = { ...original, NODE_ENV: 'production', TEST_MODE: '1' } as any;
    > 14 |     expect(() => loadServerEnv()).toThrow(/TEST_MODE must not be enabled/);
         |                                   ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/env.validation.spec.ts:14:35)

PASS tests/unit/api.admin.audit-logs.auth.spec.ts
{"level":30,"time":1755735896552,"pid":21,"hostname":"a4bd45f09ad0","requestId":"9c61d877-e975-4997-af05-25d0fede1c36","ms":1,"msg":"route_success"}
{"level":30,"time":1755735896552,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7374687d-ff1c-44fc-95b3-f1934173829f","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.env.numeric-bounds.spec.ts
PASS tests/unit/lib.paginate.edgecases.spec.ts
PASS tests/unit/lib.zodQuery.spec.ts
FAIL tests/unit/api.notifications.read-all.spec.ts
  ● notifications read-all › marks all read in test-mode

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.notifications.read-all.spec.ts:13:17)

{"level":50,"time":1755735897637,"pid":21,"hostname":"a4bd45f09ad0","requestId":"b05bbf04-f1bf-4154-9044-8e945cc0edc6","ms":1,"err":"schema.safeParse is not a function","msg":"route_error"}
PASS tests/unit/ui/SettingsPage.spec.tsx
PASS tests/unit/schemas.enrollment.spec.ts
PASS tests/unit/lib.rateLimit.spec.ts
PASS tests/unit/services.courses.spec.ts
PASS tests/unit/api.request-id.on.error.spec.ts
{"level":30,"time":1755735899430,"pid":21,"hostname":"a4bd45f09ad0","requestId":"5895dc0f-dab5-42db-9c06-7ad5bc488460","ms":1,"msg":"route_success"}
{"level":30,"time":1755735899933,"pid":21,"hostname":"a4bd45f09ad0","requestId":"80271452-18ad-4ea9-9e56-542a885db435","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.download-ownership.spec.ts
PASS tests/unit/lib.idempotency.ttl.spec.ts
PASS tests/unit/api.assignments.query-strict.spec.ts
{"level":30,"time":1755735900481,"pid":21,"hostname":"a4bd45f09ad0","requestId":"97a0f109-2427-46cb-946c-ee23d0da83f4","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.env.spec.ts
PASS tests/unit/ui/TeacherCoursesGrid.spec.tsx
PASS tests/unit/api.request-id.on.success.spec.ts
{"level":30,"time":1755735901503,"pid":21,"hostname":"a4bd45f09ad0","requestId":"51e547ea-5e8b-4618-8941-4b6228dbda6e","ms":0,"msg":"route_success"}
PASS tests/unit/gateways/users.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/user/role 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/schemas.problem.spec.ts
PASS tests/unit/db.rls.notifications.negative.spec.ts
{"level":30,"time":1755735902496,"pid":21,"hostname":"a4bd45f09ad0","requestId":"202545af-2dcd-4a6f-bbf6-a03643dc30d2","ms":1,"msg":"route_success"}
{"level":30,"time":1755735903192,"pid":21,"hostname":"a4bd45f09ad0","requestId":"e96fb0cd-b73e-466d-8e9a-14963ec93e76","ms":1,"msg":"route_success"}
{"level":30,"time":1755735903192,"pid":21,"hostname":"a4bd45f09ad0","requestId":"3ebe8064-cd98-4b09-b044-6470b0195835","ms":0,"msg":"route_success"}
PASS tests/unit/api.auth.logout.spec.ts
PASS tests/unit/ui/StudentEnrollmentsGrid.spec.tsx
PASS tests/unit/services.files.signing.spec.ts
PASS tests/unit/db.rls.quiz-choices.negative.spec.ts
{"level":30,"time":1755735903887,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c733eeb9-bb36-4253-b296-73b1e7af5040","ms":1,"msg":"route_success"}
PASS tests/unit/gateways/flags.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/flags 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

FAIL tests/unit/db.rls.quiz-questions.negative.spec.ts
  ● Quiz questions RLS/authorization negatives › student cannot create quiz question

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quiz-questions', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ quiz_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', text: 'T' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quiz-questions.negative.spec.ts:6:23)

{"level":30,"time":1755735904542,"pid":21,"hostname":"a4bd45f09ad0","requestId":"2b06cc9d-e1c2-4ab6-abdd-6d3b45cf5afb","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.notification.spec.ts
PASS tests/unit/gateways.registry.filters.spec.ts
PASS tests/unit/schemas.course.spec.ts
PASS tests/unit/db.rls.providers.negative.spec.ts
{"level":30,"time":1755735906293,"pid":21,"hostname":"a4bd45f09ad0","requestId":"7a8194d0-fddb-4d43-9836-98fdaa75ef3d","ms":1,"msg":"route_success"}
{"level":30,"time":1755735906833,"pid":21,"hostname":"a4bd45f09ad0","requestId":"209f3fa3-f205-4212-a9e4-c848c5743fd1","ms":1,"msg":"route_success"}
FAIL tests/unit/db.rls.lessons.negative.spec.ts
  ● Lessons RLS/authorization negatives › student cannot create lesson

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/lessons', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'L', content: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.lessons.negative.spec.ts:6:23)

PASS tests/unit/api.health.payload.spec.ts
PASS tests/unit/api.runtime.gating.spec.ts
{"level":30,"time":1755735907849,"pid":21,"hostname":"a4bd45f09ad0","requestId":"0dec9802-d559-4696-87fc-c199776778fe","ms":1,"msg":"route_success"}
{"level":30,"time":1755735908200,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d6a3d04a-b434-4c73-b93e-9c249c2eaa54","ms":1,"msg":"route_success"}
PASS tests/unit/db.rls.enrollments.negative.spec.ts
PASS tests/unit/schemas.quiz.extend.spec.ts
FAIL tests/unit/db.rls.modules.negative.spec.ts
  ● Modules RLS/authorization negatives › student cannot create module

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/modules', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'M' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.modules.negative.spec.ts:6:23)

{"level":30,"time":1755735908826,"pid":21,"hostname":"a4bd45f09ad0","requestId":"80f5fce3-4d7c-42b9-b3db-ade94ad04e58","ms":1,"msg":"route_success"}
{"level":30,"time":1755735909225,"pid":21,"hostname":"a4bd45f09ad0","requestId":"c54083b9-c7e1-456c-b724-07e10800daed","ms":1,"msg":"route_success"}
FAIL tests/unit/db.rls.quizzes.negative.spec.ts
  ● Quizzes RLS/authorization negatives › student cannot create quiz

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quizzes', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'Q' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quizzes.negative.spec.ts:6:23)

PASS tests/unit/api.dashboard.dto.spec.ts
{"level":20,"time":1755735909639,"pid":21,"hostname":"a4bd45f09ad0","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/ports.messaging.contract.spec.ts
PASS tests/unit/db.rls.messages.readall.negative.spec.ts
PASS tests/unit/ui/SystemHealth.spec.tsx
{"level":30,"time":1755735910129,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d43e113f-1328-4c3a-b387-4424d6f10021","ms":1,"msg":"route_success"}
PASS tests/unit/lib.metrics.cardinality.spec.ts
PASS tests/unit/services.progress.spec.ts
{"level":30,"time":1755735910670,"pid":21,"hostname":"a4bd45f09ad0","lessonId":"11111111-1111-1111-1111-111111111111","userId":"test-student-id","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755735911112,"pid":21,"hostname":"a4bd45f09ad0","requestId":"61d4aa8f-90ba-40c0-969d-f75e1d27b9a5","ms":1,"msg":"route_success"}
PASS tests/unit/db.rls.files.finalize.negative.spec.ts
PASS tests/unit/api.parent.progress.ui.spec.tsx
PASS tests/unit/lib.csp.headers.spec.ts
PASS tests/unit/runtime.headers.vary.origin.spec.ts
PASS tests/unit/api.runtime.checkpoint.spec.ts
PASS tests/unit/api.runtime.jwks.rotation.positive.spec.ts
PASS tests/unit/db.rls.interactive_attempts.negative.spec.ts
{"level":30,"time":1755735912903,"pid":21,"hostname":"a4bd45f09ad0","requestId":"d2e180ef-f582-4966-8d7a-50a56ffa1f0a","ms":1,"msg":"route_success"}
PASS tests/unit/services.users.spec.ts
PASS tests/unit/db.rls.reports.negative.spec.ts
{"level":30,"time":1755735913811,"pid":21,"hostname":"a4bd45f09ad0","requestId":"4b91b7b3-923c-400e-96dc-4137d76ac08f","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.dashboard.parent.spec.ts
PASS tests/unit/future.analytics.spec.ts
PASS tests/unit/future.access-control.spec.ts
PASS tests/unit/schemas.assignment.extend.spec.ts
PASS tests/unit/api.runtime.asset-sign-url.spec.ts
PASS tests/unit/future.profile-avatar.spec.ts
PASS tests/unit/example.spec.ts
PASS tests/unit/api.events.spec.ts

Summary of all failing tests
FAIL unit/future.messaging.spec.ts
  ● Epic E: Messaging (MVP) › lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ● Epic E: Messaging (MVP) › marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ● Epic E: Messaging (MVP) › PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ● Epic E: Messaging (MVP) › messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL unit/api.runtime.v2.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.v2.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL unit/api.flags.providers.users.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.flags.providers.users.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

FAIL unit/future.notifications.spec.ts
  ● Epic F: Notifications (MVP) › marks all notifications as read

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/future.notifications.spec.ts:43:17)

FAIL unit/api.registry.mutations.ratelimit.spec.ts
  ● registry mutations rate-limit headers › courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ● registry mutations rate-limit headers › courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ● registry mutations rate-limit headers › courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ● registry mutations rate-limit headers › versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ● registry mutations rate-limit headers › versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

FAIL unit/api.runtime.auth.exchange.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.auth.exchange.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

FAIL unit/api.runtime.asset.sign-url.scope.spec.ts
  ● runtime asset sign-url scopes (smoke) › missing scope → 403/401

    TypeError: Failed to parse URL from [object Object]

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

    Cause:
    TypeError: Invalid URL

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

  ● runtime asset sign-url scope › valid scope and content-type → 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      49 |     const token = makeJwt(['files.write']);
      50 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 51 |     expect([200]).toContain(res.status);
         |                   ^
      52 |     const json = await res.json();
      53 |     expect(json.url).toBeTruthy();
      54 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:51:19)

  ● runtime asset sign-url scope › unsupported content type → 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      58 |     const token = makeJwt(['files.write']);
      59 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 60 |     expect(res.status).toBe(400);
         |                        ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:60:24)

FAIL unit/api.parent-links.spec.ts
  ● API /api/parent-links › GET unauth → 401; missing parent_id → 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL unit/api.runtime.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL unit/api.runtime.grade.idempotency.spec.ts
  ● runtime grade idempotency (smoke) › duplicate Idempotency-Key returns 200/201 or replay header

    TypeError: Failed to parse URL from [object Object]

      35 |
      36 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 37 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      38 | }
      39 |
      40 | describe('runtime grade idempotency', () => {

      at post (unit/api.runtime.grade.idempotency.spec.ts:37:10)
      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:15:43)

    Cause:
    TypeError: Invalid URL

      35 |
      36 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 37 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      38 | }
      39 |
      40 | describe('runtime grade idempotency', () => {

      at post (unit/api.runtime.grade.idempotency.spec.ts:37:10)
      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:15:43)

  ● runtime grade idempotency › duplicate grade request with same Idempotency-Key returns replayed 200

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      47 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'grade-dup-1' } as Record<string,string>;
      48 |     let res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
    > 49 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      50 |     res = await (GradePOST as any)(post('http://localhost/api/runtime/grade', { score: 1, max: 1, passed: true }, h));
      51 |     expect([200]).toContain(res.status);
      52 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.grade.idempotency.spec.ts:49:27)

FAIL unit/lib.serverFetch.spec.ts
  ● serverFetch utils › serverFetch builds absolute URL and propagates headers when given path

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://localhost:3333/api/ping"
    Received: "/api/ping"

      33 |       (process.env as any).PORT = '3333';
      34 |       await serverFetch('/api/ping', { headers: { 'x-request-id': 'in' } });
    > 35 |       expect(calls[0].url).toBe('http://localhost:3333/api/ping');
         |                            ^
      36 |       expect((calls[0].init.headers as Headers).get('x-request-id')).toBe('in');
      37 |     } finally {
      38 |       global.fetch = old;

      at Object.<anonymous> (unit/lib.serverFetch.spec.ts:35:28)

FAIL unit/api.runtime.outcomes.jwks.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.jwks.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

FAIL unit/future.files.spec.ts
  ● Epic H: Files and Media › issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ● Epic H: Files and Media › accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

FAIL unit/api.runtime.checkpoint.scopes.spec.ts
  ● runtime checkpoint scopes › save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

FAIL unit/api.messages.threads-and-messages.spec.ts
  ● messages threads and messages (TEST_MODE) › thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

FAIL unit/api.runtime.events.scopes.spec.ts
  ● runtime events scopes › course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL unit/api.files.download-url.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

FAIL unit/api.assignments.crud.spec.ts
  ● Assignments CRUD API › DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

FAIL unit/api.role.guard.matrix.extended.spec.ts (10.549 s)
  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL unit/api.providers.ratelimit.spec.ts
  ● providers create/update/delete rate-limit headers › POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ● providers create/update/delete rate-limit headers › PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ● providers create/update/delete rate-limit headers › DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

FAIL unit/api.admin.export.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.export.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

FAIL unit/api.runtime.outcomes.runtime-token.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.runtime-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

FAIL unit/middleware.cors.disallowed-origin.spec.ts
  ● middleware CSP connect-src allowlist propagation › includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

FAIL unit/server.scheduler.flags.spec.ts
  ● scheduler ensureJobsStarted flags › DUE_SOON_JOB=1 schedules due-soon job

    expect(received).toContain(expected) // indexOf

    Expected value: "assignment_due_soon"
    Received array: []

      26 |     mod.ensureJobsStarted();
      27 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 28 |     expect(calls).toContain('assignment_due_soon');
         |                   ^
      29 |   });
      30 |
      31 |   test('PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:28:19)

  ● scheduler ensureJobsStarted flags › PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "provider_health_refresh"
    Received array: []

      34 |     mod.ensureJobsStarted();
      35 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 36 |     expect(calls).toContain('provider_health_refresh');
         |                   ^
      37 |   });
      38 |
      39 |   test('REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:36:19)

  ● scheduler ensureJobsStarted flags › REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "refresh_progress_summary"
    Received array: []

      42 |     mod.ensureJobsStarted();
      43 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 44 |     expect(calls).toContain('refresh_progress_summary');
         |                   ^
      45 |   });
      46 |
      47 |   test('QUOTA_RECONCILE_JOB=1 schedules quota reconcile', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:44:19)

  ● scheduler ensureJobsStarted flags › QUOTA_RECONCILE_JOB=1 schedules quota reconcile

    expect(received).toContain(expected) // indexOf

    Expected value: "quota_reconcile"
    Received array: []

      50 |     mod.ensureJobsStarted();
      51 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 52 |     expect(calls).toContain('quota_reconcile');
         |                   ^
      53 |   });
      54 |
      55 |   test('BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:52:19)

  ● scheduler ensureJobsStarted flags › BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill

    expect(received).toContain(expected) // indexOf

    Expected value: "attachment_size_backfill"
    Received array: []

      58 |     mod.ensureJobsStarted();
      59 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 60 |     expect(calls).toContain('attachment_size_backfill');
         |                   ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:60:19)

FAIL unit/api.files.attachments.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.attachments.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

FAIL unit/api.files.finalize.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.finalize.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:2:1)

FAIL unit/lib.serverFetch.csrf-header.spec.ts
  ● serverFetch forwards x-csrf-token when cookie present › adds x-csrf-token header for unsafe method

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc123"
    Received: "cookie-csrf"

      45 |     await serverFetch('/api/messages', { method: 'POST' });
      46 |     const h = calls[0].init.headers as Headers;
    > 47 |     expect(h.get('x-csrf-token')).toBe('abc123');
         |                                   ^
      48 |   });
      49 | });
      50 |

      at Object.<anonymous> (unit/lib.serverFetch.csrf-header.spec.ts:47:35)

FAIL unit/api.runtime.grade.ratelimit.spec.ts
  ● runtime grade rate-limit headers › returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

FAIL unit/api.admin.audit-logs.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.admin.audit-logs.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

FAIL unit/api.providers.dto-and-ratelimit.spec.ts
  ● providers endpoints DTO + ratelimit headers › rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

FAIL unit/api.runtime.events.ratelimit.spec.ts
  ● runtime events rate-limit headers › returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

FAIL unit/lib.serverFetch.headers.spec.ts
  ● serverFetch headers and fetchJson › propagates x-request-id and x-test-auth and builds absolute URL

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      22 |   test('propagates x-request-id and x-test-auth and builds absolute URL', async () => {
      23 |     await serverFetch('/api/health');
    > 24 |     expect(fetchSpy).toHaveBeenCalledTimes(1);
         |                      ^
      25 |     const [url, init] = fetchSpy.mock.calls[0];
      26 |     expect(String(url)).toBe('http://localhost:3030/api/health');
      27 |     const hdrs = new Headers(init.headers);

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:24:22)

  ● serverFetch headers and fetchJson › does not attach x-csrf-token on GET even when cookie present

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))

      35 |     store.cookies.set('csrf_token', 'tok');
      36 |     await serverFetch('/api/health', { method: 'GET' });
    > 37 |     const [, init] = fetchSpy.mock.calls[0];
         |                      ^
      38 |     const hdrs = new Headers(init.headers);
      39 |     expect(hdrs.get('x-csrf-token')).toBeNull();
      40 |   });

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:37:22)

FAIL unit/api.files.roundtrip.spec.ts
  ● files round-trip › upload-url → PUT bytes → download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

FAIL unit/api.runtime.idempotency.spec.ts
  ● runtime progress idempotency › duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

FAIL unit/api.runtime.cors.headers.spec.ts
  ● runtime CORS headers for allowed origin › includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

FAIL unit/api.assignments.target.upsert.spec.ts
  ● assignments target upsert (EXTERNAL_COURSES=1) › POST upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 500]

      15 |     const body = { course_id: '00000000-0000-0000-0000-000000000001', title: 'A', target: { source: 'v2', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      16 |     const res = await (AssignPOST as any)(req('POST', 'http://localhost/api/assignments', body));
    > 17 |     expect([201, 500]).toContain(res.status); // 201 success; 500 if DTO mismatch in test harness
         |                        ^
      18 |   });
      19 |
      20 |   test('PATCH upserts assignment_targets when target provided', async () => {

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:17:24)

  ● assignments target upsert (EXTERNAL_COURSES=1) › PATCH upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      23 |     const body = { title: 'B', target: { source: 'v1', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      24 |     const res = await (AssignPATCH as any)(req('PATCH', 'http://localhost/api/assignments?id=00000000-0000-0000-0000-000000000001', body));
    > 25 |     expect([200, 500]).toContain(res.status);
         |                        ^
      26 |   });
      27 | });
      28 |

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:25:24)

FAIL unit/db.rls.negative.spec.ts
  ● DB RLS negative cases (policy guards) › student cannot read other students notifications

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/db.rls.negative.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ● DB RLS negative cases (policy guards) › non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ● DB RLS negative cases (policy guards) › student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

FAIL unit/middleware.security-headers.more.spec.ts
  ● middleware additional security headers › sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ● middleware additional security headers › sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL unit/api.runtime.outcomes.rate-limit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.outcomes.rate-limit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

FAIL unit/api.enrollments.spec.ts
  ● API /api/enrollments › POST unauth → 401; non-student → 403; student → 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth → 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

FAIL unit/api.providers.health.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.health.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

FAIL unit/api.notifications.rate-limit.spec.ts
  ● notifications rate-limit headers › GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

FAIL unit/api.assignments.post.csrf.spec.ts
  ● assignments POST CSRF double-submit › 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

FAIL unit/api.quizzes.ratelimit.spec.ts
  ● quizzes rate-limit headers on PATCH/DELETE › PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

FAIL unit/future.observability.logs.spec.ts
  ● observability logs (services) › dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ● observability logs (services) › progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

FAIL unit/api.progress.errors.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.errors.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

FAIL unit/api.events.behavior.spec.ts
  ● Events API behavior › test-mode: POST 201 and GET lists event; 401 unauth

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [201, 204]

      22 |     jest.spyOn(supa, 'getCurrentUserInRoute').mockResolvedValue({ id: 'u', user_metadata: { role: 'teacher' } } as any);
      23 |     res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'e1', meta: {} }));
    > 24 |     expect([201,204]).toContain(res.status); // test-mode -> 201
         |                       ^
      25 |     const list = await (EventsGET as any)(get('http://localhost/api/events'));
      26 |     expect(list.status).toBe(200);
      27 |   });

      at Object.<anonymous> (unit/api.events.behavior.spec.ts:24:23)

FAIL unit/api.teacher.grading-queue.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.teacher.grading-queue.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

FAIL unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ● withRouteTiming skips CSRF on /api/runtime/* › cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

FAIL unit/middleware.csrf-cookie.spec.ts
  ● middleware CSRF cookie issuance › sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL unit/api.files.content-type-default.spec.ts
  ● files default content_type › defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

FAIL unit/api.progress.access.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.progress.access.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

FAIL unit/api.runtime.teacher.outcomes.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.runtime.teacher.outcomes.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL unit/api.messages.read-all.spec.ts
  ● API /api/messages/threads/[id]/read-all › marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

FAIL unit/api.files.resolve.spec.ts
  ● API /api/files/resolve › test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

FAIL unit/middleware.security-headers.spec.ts
  ● middleware security headers › sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ● runtime outcomes JWKS rotation › refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

FAIL unit/api.admin.quotas.ratelimit.headers.spec.ts
  ● admin quotas rate-limit headers › 429 includes retry-after and rate-limit headers

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.headers.spec.ts:18:17)

FAIL unit/api.courses.transfer-owner.audit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.courses.transfer-owner.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

FAIL unit/api.health.requiredEnvs.spec.ts
  ● api.health requiredEnvs snapshot › includes Supabase keys and runtime keys when RUNTIME_API_V2=1

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      19 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_URL).toBe(true);
      20 |     expect(json.requiredEnvs.NEXT_PUBLIC_SUPABASE_ANON_KEY).toBe(true);
    > 21 |     expect(json.requiredEnvs.NEXT_RUNTIME_PUBLIC_KEY).toBe(true);
         |                                                       ^
      22 |     expect(json.requiredEnvs.NEXT_RUNTIME_PRIVATE_KEY).toBe(true);
      23 |     expect(json.requiredEnvs.NEXT_RUNTIME_KEY_ID).toBe(true);
      24 |   });

      at Object.<anonymous> (unit/api.health.requiredEnvs.spec.ts:21:55)

FAIL unit/db.rls.assignments.negative.spec.ts
  ● Assignments RLS/authorization negatives › student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

FAIL unit/api.providers.get.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.get.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

FAIL unit/api.headers.security.spec.ts
  ● security headers (CSP frame-ancestors + X-Frame-Options) › middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

FAIL unit/api.events.producers.spec.ts
  ● Event producers (TEST_MODE) › lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ● Event producers (TEST_MODE) › submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

FAIL unit/api.files.upload-url.quota.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.upload-url.quota.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

FAIL unit/api.reports.dto.spec.ts
  ● reports endpoints headers and DTO-like responses › GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

FAIL unit/api.notifications.patch.csrf.spec.ts
  ● notifications preferences PATCH respects CSRF double-submit › 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

FAIL unit/ui/TeacherAnnouncements.spec.tsx
  ● Teacher Announcements (labs) › renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL unit/api.user-profile.put.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user-profile.put.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

FAIL unit/ui/TeacherCourseInsightsAdvanced.spec.tsx
  ● Teacher Course Insights (Advanced) › renders table and totals with jitter

    TypeError: cookieStore.getAll is not a function

      15 |   const cookieStore = cookies();
      16 |   const incoming = headers();
    > 17 |   const cookieHeader = cookieStore.getAll().map(c => `${c.name}=${c.value}`).join("; ");
         |                                    ^
      18 |   const xTestAuth = incoming.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;
      19 |
      20 |   const baseHeaders: HeadersInit = {

      at TeacherCourseInsightsAdvancedPage (../apps/web/src/app/labs/teacher/course-insights-advanced/page.tsx:17:36)
      at Object.<anonymous> (unit/ui/TeacherCourseInsightsAdvanced.spec.tsx:27:55)

FAIL unit/api.files.download-url.dev-namespace.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL unit/api.providers.create.negatives.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.negatives.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

FAIL unit/api.providers.create.happy-path.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.providers.create.happy-path.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

FAIL unit/api.messages.post.ratelimit.spec.ts
  ● messages POST rate limit headers › returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

FAIL unit/api.providers.health.ratelimit.spec.ts
  ● providers health rate-limit headers › 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL unit/api.files.quota.enforcement.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.quota.enforcement.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL unit/api.enrollments.launch-token.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.enrollments.launch-token.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

FAIL unit/gateways/reports.gateway.spec.ts
  ● ReportsGateway › engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ● ReportsGateway › gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

FAIL unit/api.files.av-and-quota.negatives.spec.ts
  ● files AV stub and quota exceed › EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

FAIL unit/middleware.coep.flag.spec.ts
  ● middleware COEP flag › sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

FAIL unit/api.flags.spec.ts
  ● Feature flags API (test-mode) › GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL unit/api.runtime.jwks.rotation.spec.ts
  ● runtime JWKS rotation (kid refresh) › on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

FAIL unit/api.reports.activity-retention.spec.ts
  ● API /api/reports/activity & /api/reports/retention (TEST_MODE) › retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL unit/api.files.upload-url.spec.ts
  ● api.files.upload-url › returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

FAIL unit/api.courses.transfer-owner.ratelimit.spec.ts
  ● courses transfer-owner rate-limit headers › returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

FAIL unit/api.files.download-url.dev-namespace.guard.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.files.download-url.dev-namespace.guard.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

FAIL unit/api.files.upload-url.ratelimit.spec.ts
  ● files upload-url rate limit headers › 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

FAIL unit/api.attachments.delete.permissions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.attachments.delete.permissions.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

FAIL unit/lib.serverFetch.extend.spec.ts
  ● serverFetch extended › absolute URL passes through unchanged

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://example.com/api/x"
    Received: "http://web:3022http://example.com/api/x"

       9 |     try {
      10 |       await serverFetch('http://example.com/api/x');
    > 11 |       expect(calls[0].url).toBe('http://example.com/api/x');
         |                            ^
      12 |     } finally {
      13 |       global.fetch = old;
      14 |     }

      at Object.<anonymous> (unit/lib.serverFetch.extend.spec.ts:11:28)

FAIL unit/api.courses.transfer-owner.auth.spec.ts
  ● API /api/courses/[id]/transfer-owner auth › non-admin and non-owner → 403

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:14:17)

FAIL unit/api.user.role.audit.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/lib/supabaseServer' from 'unit/helpers/supabaseMock.ts'

    Require stack:
      unit/helpers/supabaseMock.ts
      unit/api.user.role.audit.spec.ts

      53 | // Re-export server helper so tests can spyOn this symbol uniformly via the supabaseMock module.
      54 | // This allows: jest.spyOn(supa, 'getRouteHandlerSupabase').mockReturnValue(mock)
    > 55 | export { getRouteHandlerSupabase } from '../../apps/web/src/lib/supabaseServer';
         | ^
      56 |
      57 |
      58 |

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/helpers/supabaseMock.ts:55:1)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

FAIL unit/lib.metrics.inflight.spec.ts
  ● metrics in-flight tracking › increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      21 |     incrInFlight(route);
      22 |     let s1 = snapshot();
    > 23 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      24 |     decrInFlight(route);
      25 |     decrInFlight(route);
      26 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:23:41)

FAIL unit/api.analytics.events.emit.spec.ts
  ● API /api/events (analytics ingestion) › teacher authed → 2xx

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 201]

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'teacher');
      16 |     const res = await (EventsPOST as any)(post('http://localhost/api/events', { event_type: 'x', entity_type: 'y', entity_id: 'z', meta: {} }));
    > 17 |     expect([200,201]).toContain(res.status);
         |                       ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.analytics.events.emit.spec.ts:17:23)

FAIL unit/ui/AdminReports.spec.tsx
  ● Admin Reports (dashboard) › renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

FAIL unit/api.admin.quotas.ratelimit.spec.ts
  ● admin quotas PATCH rate-limit headers › returns 429 and retry-after header when limited

    TypeError: supabase.from(...).upsert is not a function

      52 |   if (typeof body.max_bytes === 'number') row.max_bytes = body.max_bytes;
      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
    > 54 |   const { error } = await supabase.from('user_storage_quotas').upsert(row, { onConflict: 'user_id' } as any);
         |                                                                ^
      55 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      56 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });
      57 | });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:54:64)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

FAIL unit/gateways/enrollments.gateway.spec.ts
  ● EnrollmentsGateway.list › returns enrollments array

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "course_id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "course_id"
        ]
      }
    ]

      112 |     throw new Error(`${code}: ${message}`);
      113 |   }
    > 114 |   return schema.parse(json) as T;
          |                 ^
      115 | }
      116 |
      117 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at fetchJson (../apps/web/src/lib/serverFetch.ts:114:17)
      at Object.<anonymous> (unit/gateways/enrollments.gateway.spec.ts:27:18)

FAIL unit/db.rls.courses.negative.spec.ts
  ● Courses RLS/authorization negatives › student cannot create course

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/courses', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ title: 'X', description: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot delete course', async () => {

      at Object.<anonymous> (unit/db.rls.courses.negative.spec.ts:6:23)

FAIL unit/lib.runtimeAuth.scopes-aud.spec.ts
  ● runtimeAuth audience and scopes › rejects when aud mismatches allowed origin

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /workspace/tests/node_modules/jose/dist/webapi/index.js:1
    ({"Object.<anonymous>":function(module,exports,require,__dirname,__filename,jest){export { compactDecrypt } from './jwe/compact/decrypt.js';
                                                                                      ^^^^^^

    SyntaxError: Unexpected token 'export'

      10 |     // Mock getRequestOrigin to return allowed origin and jose verify to return payload with different aud
      11 |     jest.spyOn(require('../../apps/web/src/lib/cors'), 'getRequestOrigin').mockReturnValue('https://good.example' as any);
    > 12 |     jest.spyOn(require('jose') as any, 'jwtVerify').mockResolvedValue({ payload: { aud: 'https://bad.example', scopes: [] } });
         |                ^
      13 |     const out = verifyRuntimeAuthorization(req as any, [] as any) as any;
      14 |     expect(out).toBeTruthy();
      15 |   });

      at Runtime.createScriptFromCode (../node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (unit/lib.runtimeAuth.scopes-aud.spec.ts:12:16)

FAIL unit/lib.runtimeAuth.clockskew.spec.ts
  ● runtimeAuth clock skew tolerance › accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

FAIL unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ● runtime outcomes provider JWT iss/aud negatives › invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

FAIL unit/api.messages.threads.auth.spec.ts
  ● API /api/messages/threads auth › unauthenticated POST → 401

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 400

      12 |   test('unauthenticated POST → 401', async () => {
      13 |     const res = await (ThreadsPOST as any)(post('http://localhost/api/messages/threads', { participant_ids: [] }));
    > 14 |     expect(res.status).toBe(401);
         |                        ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/api.messages.threads.auth.spec.ts:14:24)

FAIL unit/ui/StudentProfile.spec.tsx
  ● Student Profile (labs) › renders email and role when authenticated

    Unable to find an element by: [data-testid="profile-email"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6 space-y-3"[39m
        [36m>[39m
          [36m<h1[39m
            [33mclass[39m=[32m"text-xl font-semibold"[39m
            [33mdata-testid[39m=[32m"profile-title"[39m
          [36m>[39m
            [0mStudent Profile[0m
          [36m</h1>[39m
          [36m<p[39m
            [33mclass[39m=[32m"text-gray-700"[39m
            [33mdata-testid[39m=[32m"signin-prompt"[39m
          [36m>[39m
            [0mYou are not signed in[0m
          [36m</p>[39m
          [36m<a[39m
            [33mclass[39m=[32m"underline"[39m
            [33mdata-testid[39m=[32m"signin-link"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mGo to login[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await StudentProfilePage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('profile-email')).toHaveTextContent('s@example.com');
         |                         ^
      18 |     expect(await screen.findByTestId('profile-role')).toHaveTextContent('student');
      19 |   });
      20 | });

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/StudentProfile.spec.tsx:17:25)

FAIL unit/ui/SystemAuthCheck.spec.tsx
  ● System Auth Check (labs) › renders email and role when authenticated

    TypeError: cookieStore.getAll is not a function

      14 |
      15 |   const cookieHeader = incomingHeaders.get("cookie") ?? cookieStore
    > 16 |     .getAll()
         |      ^
      17 |     .map((c) => `${c.name}=${c.value}`)
      18 |     .join("; ");
      19 |   const testAuthHeader = incomingHeaders.get("x-test-auth") ?? "";

      at AuthCheckPage (../apps/web/src/app/labs/system/auth-check/page.tsx:16:6)
      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:15:35)

FAIL unit/api.parent.progress.api.spec.ts
  ● API /api/parent/progress (TEST_MODE) › parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

FAIL unit/ui/ParentChildrenReport.spec.tsx
  ● Parent Children Report (labs) › renders total and items

    TypeError: c.getAll is not a function

       8 |   const h = headers();
       9 |   const c = cookies();
    > 10 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      11 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      12 |
      13 |   let rows: ParentLink[] = [];

      at ParentChildrenReportPage (../apps/web/src/app/labs/parent/children-report/page.tsx:10:45)
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:17:46)

FAIL unit/ui/SystemOkCard.spec.tsx
  ● System OK Card (labs) › renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

FAIL unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ● runtime outcomes strict iss/aud enforcement › issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

FAIL unit/ui/ParentChildren.spec.tsx
  ● Parent Children (labs) › renders list with one linked student

    TypeError: c.getAll is not a function

       9 | 	const h = headers();
      10 | 	const c = cookies();
    > 11 | 	const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                          ^
      12 | 	const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      13 |
      14 | 	let links: ParentLink[] = [];

      at ParentChildrenListPage (../apps/web/src/app/labs/parent/children/page.tsx:11:44)
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:15:44)

FAIL unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ● runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement › rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

FAIL unit/api.messages.read-all-thread.spec.ts
  ● messages read-all by thread id › student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

FAIL unit/lib.testMode.spec.ts
  ● testMode › isTestMode false otherwise

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: true

      22 |     delete (process.env as any).TEST_MODE;
      23 |     delete (process.env as any).PLAYWRIGHT;
    > 24 |     expect(isTestMode()).toBe(false);
         |                          ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/lib.testMode.spec.ts:24:26)

FAIL unit/gateways.registry.pagination.spec.ts
  ● RegistryGateway listCourses (test mode) › returns rows matching externalCourse schema and totalCount

    ZodError: [
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          0,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          1,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          2,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          3,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          4,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          5,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          6,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          7,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          8,
          "id"
        ]
      },
      {
        "validation": "uuid",
        "code": "invalid_string",
        "message": "Invalid uuid",
        "path": [
          9,
          "id"
        ]
      }
    ]

      13 |     expect(Array.isArray(rows)).toBe(true);
      14 |     expect(typeof totalCount).toBe('number');
    > 15 |     z.array(externalCourse).parse(rows);
         |                             ^
      16 |   });
      17 | });
      18 |

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodArray.parse (../node_modules/zod/v3/types.cjs:120:22)
      at Object.<anonymous> (unit/gateways.registry.pagination.spec.ts:15:29)

FAIL unit/api.messages.guard.spec.ts
  ● api.messages guard (MVP_PROD_GUARD) › guard enforced in production-like (non test-mode)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 501]

      11 |     const res = await (MessagesGET as any)(makeReq('http://localhost/api/messages?thread_id=th1', { 'x-test-auth': 'student' }));
      12 |     // In non test-mode, auth may fail or MVP guard may block; accept 401 or 501
    > 13 |     expect([401, 501]).toContain(res.status);
         |                        ^
      14 |   });
      15 | });
      16 |

      at Object.<anonymous> (unit/api.messages.guard.spec.ts:13:24)

FAIL unit/env.validation.spec.ts
  ● environment validation › prod with TEST_MODE=1 throws unless explicitly allowed

    expect(received).toThrow(expected)

    Expected pattern: /TEST_MODE must not be enabled/

    Received function did not throw

      12 |   test('prod with TEST_MODE=1 throws unless explicitly allowed', () => {
      13 |     process.env = { ...original, NODE_ENV: 'production', TEST_MODE: '1' } as any;
    > 14 |     expect(() => loadServerEnv()).toThrow(/TEST_MODE must not be enabled/);
         |                                   ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/env.validation.spec.ts:14:35)

FAIL unit/api.notifications.read-all.spec.ts
  ● notifications read-all › marks all read in test-mode

    TypeError: schema.safeParse is not a function

      18 |   const { requestId } = opts;
      19 |   const status = typeof opts.status === 'number' ? opts.status : 200;
    > 20 |   const parsed = (schema as any).safeParse(data);
         |                                  ^
      21 |   if (!parsed.success) {
      22 |     try { getRequestLogger(requestId).error({ issues: redactIssues(parsed.error.issues) }, 'dto_response_validation_failed'); } catch {}
      23 |     return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid response shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });

      at jsonDto (../apps/web/src/lib/jsonDto.ts:20:34)
      at PATCH (../apps/web/src/app/api/notifications/read-all/route.ts:14:19)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.notifications.read-all.spec.ts:13:17)

FAIL unit/db.rls.quiz-questions.negative.spec.ts
  ● Quiz questions RLS/authorization negatives › student cannot create quiz question

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quiz-questions', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ quiz_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', text: 'T' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quiz-questions.negative.spec.ts:6:23)

FAIL unit/db.rls.lessons.negative.spec.ts
  ● Lessons RLS/authorization negatives › student cannot create lesson

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/lessons', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'L', content: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.lessons.negative.spec.ts:6:23)

FAIL unit/db.rls.modules.negative.spec.ts
  ● Modules RLS/authorization negatives › student cannot create module

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/modules', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'M' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.modules.negative.spec.ts:6:23)

FAIL unit/db.rls.quizzes.negative.spec.ts
  ● Quizzes RLS/authorization negatives › student cannot create quiz

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quizzes', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'Q' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quizzes.negative.spec.ts:6:23)


Test Suites: 119 failed, 265 passed, 384 total
Tests:       142 failed, 1 skipped, 14 todo, 499 passed, 656 total
Snapshots:   0 total
Time:        213.056 s
Ran all test suites.
