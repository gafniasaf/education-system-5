{"level":30,"time":1755745432083,"pid":21,"hostname":"6d8b80affa0f","requestId":"7e94da3e-06ea-4f95-a28a-803aae5e46a9","ms":6,"msg":"route_success"}
{"level":30,"time":1755745432086,"pid":21,"hostname":"6d8b80affa0f","requestId":"7b748bef-13bc-4105-88c5-098dcf8b0538","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432097,"pid":21,"hostname":"6d8b80affa0f","requestId":"9bc94054-15c2-45df-9d14-e0645cafe56c","ms":11,"msg":"route_success"}
{"level":30,"time":1755745432104,"pid":21,"hostname":"6d8b80affa0f","requestId":"b1190ee7-33b0-41a6-8a22-1878eef80667","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432221,"pid":21,"hostname":"6d8b80affa0f","requestId":"27da08a6-d5fd-41ca-b641-e2ce27a67068","ms":1,"msg":"route_success"}
{"level":30,"time":1755745432222,"pid":21,"hostname":"6d8b80affa0f","requestId":"1d635638-e1f7-465a-8558-2b7f01a2adcc","ms":1,"msg":"route_success"}
{"level":30,"time":1755745432223,"pid":21,"hostname":"6d8b80affa0f","requestId":"a2aeb325-b720-4ed4-b45b-40bfe49c5c67","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432224,"pid":21,"hostname":"6d8b80affa0f","requestId":"5235720a-f28a-4c9c-806b-246cfd3281ad","ms":1,"msg":"route_success"}
{"level":30,"time":1755745432226,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e74273a-68b9-4b32-8002-a5b8dd91ec07","ms":2,"msg":"route_success"}
{"level":30,"time":1755745432227,"pid":21,"hostname":"6d8b80affa0f","requestId":"5c77eb8b-a37c-4e07-bd7d-fd869961524d","ms":1,"msg":"route_success"}
{"level":30,"time":1755745432230,"pid":21,"hostname":"6d8b80affa0f","requestId":"379a3fc5-1513-49f9-9e3a-533ef92110f8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432348,"pid":21,"hostname":"6d8b80affa0f","requestId":"1a1b298b-be57-4e10-8210-1cd871b100bf","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432349,"pid":21,"hostname":"6d8b80affa0f","requestId":"314b279f-d5a9-4878-b842-6cb5be0f72a2","ms":1,"msg":"route_success"}
{"level":50,"time":1755745432350,"pid":21,"hostname":"6d8b80affa0f","requestId":"58b120ec-cb67-4fe1-9225-53015693d8ca","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745432350,"pid":21,"hostname":"6d8b80affa0f","requestId":"4a8f5f78-d3dc-474b-a16a-7789eba575e6","ms":1,"msg":"route_success"}
{"level":30,"time":1755745432352,"pid":21,"hostname":"6d8b80affa0f","requestId":"9569cc77-a705-407d-ba48-dc537f2941f1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432353,"pid":21,"hostname":"6d8b80affa0f","requestId":"694a3040-6921-4d69-9c7b-7e8f65504395","ms":1,"msg":"route_success"}
FAIL tests/unit/future.messaging.spec.ts
  ● Epic E: Messaging (MVP) › lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ● Epic E: Messaging (MVP) › marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ● Epic E: Messaging (MVP) › PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ● Epic E: Messaging (MVP) › messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL tests/unit/api.runtime.v2.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL tests/unit/api.flags.providers.users.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

{"level":30,"time":1755745432357,"pid":21,"hostname":"6d8b80affa0f","requestId":"38ba28e2-d58b-42f6-a42d-075a71c56907","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432357,"pid":21,"hostname":"6d8b80affa0f","requestId":"d9a32e4a-1d56-4527-8088-e214bca73a41","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432358,"pid":21,"hostname":"6d8b80affa0f","requestId":"bb7969a8-b23f-4885-a51c-5413a62169be","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432359,"pid":21,"hostname":"6d8b80affa0f","requestId":"98d78d21-3469-4cb9-a8cd-439a50b2c07f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745432359,"pid":21,"hostname":"6d8b80affa0f","requestId":"e90e3dcd-4561-4687-ae1f-98c49e5c6111","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433933,"pid":21,"hostname":"6d8b80affa0f","requestId":"72bc1a04-aec2-414a-91d5-bdfcdb97d7fd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433934,"pid":21,"hostname":"6d8b80affa0f","requestId":"ed47f28e-15eb-44fb-a460-4900d6d0ecf4","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433936,"pid":21,"hostname":"6d8b80affa0f","requestId":"2743d7f5-5a40-46cc-8b78-49920846afd9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433936,"pid":21,"hostname":"6d8b80affa0f","requestId":"11ed5e64-c76b-4662-b9f2-31b498225e98","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433937,"pid":21,"hostname":"6d8b80affa0f","requestId":"a3f5f1a5-e016-43bf-9a33-2826af0e35ad","ms":1,"msg":"route_success"}
{"level":30,"time":1755745433938,"pid":21,"hostname":"6d8b80affa0f","requestId":"d0b10e9c-2d25-4dde-967e-8e7b20058e7a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745433940,"pid":21,"hostname":"6d8b80affa0f","requestId":"caefe25d-5408-4bb2-88e0-a15df05780ed","ms":1,"msg":"route_success"}
{"level":30,"time":1755745433940,"pid":21,"hostname":"6d8b80affa0f","requestId":"b7c58657-1f42-4b19-8f25-ce33ed050391","ms":0,"msg":"route_success"}
PASS tests/unit/api.reports.spec.ts
PASS tests/unit/lib.runtimeAuth.spec.ts
PASS tests/unit/api.pagination.headers.spec.ts
{"level":30,"time":1755745435625,"pid":21,"hostname":"6d8b80affa0f","requestId":"29784d89-3231-47c5-80c6-1b5343e228ca","ms":1,"msg":"route_success"}
{"level":30,"time":1755745435627,"pid":21,"hostname":"6d8b80affa0f","requestId":"aa541bca-5383-4e3d-87b6-6e8bd5301f3c","ms":1,"msg":"route_success"}
{"level":30,"time":1755745435628,"pid":21,"hostname":"6d8b80affa0f","requestId":"973e4f06-68da-4c61-a9b6-2b574a8df9fd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745435629,"pid":21,"hostname":"6d8b80affa0f","requestId":"c4069f3b-9f6b-4839-a950-e5d90d099d3c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745435630,"pid":21,"hostname":"6d8b80affa0f","requestId":"8c3d7ba0-881e-401b-b205-d2b2e58628a9","ms":1,"msg":"route_success"}
{"level":30,"time":1755745435630,"pid":21,"hostname":"6d8b80affa0f","requestId":"ab5dc4af-f600-4e3a-bffc-7a862d2334b1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745435631,"pid":21,"hostname":"6d8b80affa0f","requestId":"07953c97-86a2-43e8-bfbb-70edf0cfb1c3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745436096,"pid":21,"hostname":"6d8b80affa0f","requestId":"7c834bce-ea7f-49b0-a0a1-f3d763b7a2a1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745436097,"pid":21,"hostname":"6d8b80affa0f","requestId":"55f3a9ce-fb9e-455f-9e9f-b0bbb1b90fc3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745436097,"pid":21,"hostname":"6d8b80affa0f","requestId":"e7494bf2-d008-49a5-9574-0cc3f5a3edae","ms":0,"msg":"route_success"}
{"level":30,"time":1755745436098,"pid":21,"hostname":"6d8b80affa0f","requestId":"921fda50-ab23-4439-a325-85a8ff2658ef","ms":0,"msg":"route_success"}
{"level":30,"time":1755745436099,"pid":21,"hostname":"6d8b80affa0f","requestId":"a5f4117f-80b9-4155-8c01-120da23f87e3","ms":1,"msg":"route_success"}
{"level":30,"time":1755745436192,"pid":21,"hostname":"6d8b80affa0f","requestId":"d0daa8a0-ce87-4769-afbc-f92a999df7b3","ms":0,"msg":"route_success"}
PASS tests/unit/future.notifications.spec.ts
FAIL tests/unit/api.registry.mutations.ratelimit.spec.ts
  ● registry mutations rate-limit headers › courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ● registry mutations rate-limit headers › courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ● registry mutations rate-limit headers › courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ● registry mutations rate-limit headers › versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ● registry mutations rate-limit headers › versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

{"level":50,"time":1755745437336,"pid":21,"hostname":"6d8b80affa0f","requestId":"257c2f02-ccd5-4a18-9f0c-bd2ef2788319","ms":1,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755745437347,"pid":21,"hostname":"6d8b80affa0f","requestId":"0a17075e-c91a-40f0-9319-5b5294bea8af","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755745437347,"pid":21,"hostname":"6d8b80affa0f","requestId":"8f8382fb-8e36-4a89-8005-2b1858af7018","ms":0,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
{"level":50,"time":1755745437348,"pid":21,"hostname":"6d8b80affa0f","requestId":"bd3a39e8-a846-4eb8-b1f0-71f79167d851","ms":0,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755745437352,"pid":21,"hostname":"6d8b80affa0f","requestId":"d2ea786c-c1b5-4606-adb8-810d11568a65","ms":0,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":30,"time":1755745437769,"pid":21,"hostname":"6d8b80affa0f","requestId":"3c6e4016-dce7-4cf6-a8e9-b71e987864a6","ms":1,"msg":"route_success"}
{"level":30,"time":1755745437770,"pid":21,"hostname":"6d8b80affa0f","requestId":"681df53a-09ca-4f09-a7df-7553f16e7b83","ms":0,"msg":"route_success"}
{"level":30,"time":1755745437771,"pid":21,"hostname":"6d8b80affa0f","requestId":"98e553d4-7a41-4049-8f4d-272a35931cdc","ms":1,"msg":"route_success"}
{"level":30,"time":1755745437772,"pid":21,"hostname":"6d8b80affa0f","requestId":"56f908ca-463a-4c10-baab-a95c842b5269","ms":1,"msg":"route_success"}
{"level":30,"time":1755745437772,"pid":21,"hostname":"6d8b80affa0f","requestId":"1b8fc70c-c30c-4bc4-9be1-1f3880e1fa90","ms":0,"msg":"route_success"}
{"level":30,"time":1755745437773,"pid":21,"hostname":"6d8b80affa0f","requestId":"b0ffe8ad-0362-42a1-9726-cba81c6012b3","ms":1,"msg":"route_success"}
{"level":30,"time":1755745437773,"pid":21,"hostname":"6d8b80affa0f","requestId":"39f4d1e3-04f0-45ad-bd71-bdad71a6d40d","ms":0,"msg":"route_success"}
PASS tests/unit/api.quizzes.spec.ts
PASS tests/unit/api.quiz-attempts.spec.ts
FAIL tests/unit/api.runtime.auth.exchange.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

{"level":30,"time":1755745438253,"pid":21,"hostname":"6d8b80affa0f","requestId":"79ef8d75-9ec5-4118-88c4-244cc6b3633a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745438253,"pid":21,"hostname":"6d8b80affa0f","requestId":"8a1f5f1e-4166-4c4e-92ed-9ef95be90637","ms":0,"msg":"route_success"}
{"level":30,"time":1755745438254,"pid":21,"hostname":"6d8b80affa0f","requestId":"c1d0a662-ba54-4ee3-b3cc-ab51c20ba83a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745438255,"pid":21,"hostname":"6d8b80affa0f","requestId":"af34b5a0-3383-4b03-9149-413f8e2ea62b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745438255,"pid":21,"hostname":"6d8b80affa0f","requestId":"4472ba0d-595c-4747-b109-6291a33fed37","ms":0,"msg":"route_success"}
{"level":30,"time":1755745438256,"pid":21,"hostname":"6d8b80affa0f","requestId":"29c83917-22a7-477d-ba8b-8acf7015d20d","ms":1,"msg":"route_success"}
{"level":30,"time":1755745438256,"pid":21,"hostname":"6d8b80affa0f","requestId":"d4f26ea5-1eb9-4bcb-ab63-237e797e4164","ms":0,"msg":"route_success"}
{"level":30,"time":1755745438256,"pid":21,"hostname":"6d8b80affa0f","requestId":"155253b8-f94f-47f3-b63a-23729c8242a5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745438257,"pid":21,"hostname":"6d8b80affa0f","requestId":"acd1aafd-3cba-4513-970e-9ac6216b8cf9","ms":1,"msg":"route_success"}
{"level":30,"time":1755745440308,"pid":21,"hostname":"6d8b80affa0f","requestId":"a2272567-673f-4ae8-a20a-228808876a13","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440309,"pid":21,"hostname":"6d8b80affa0f","requestId":"3037ec97-2097-427d-8eb2-6131575ea932","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440310,"pid":21,"hostname":"6d8b80affa0f","requestId":"ec468090-127e-4703-a329-c436e899efac","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440310,"pid":21,"hostname":"6d8b80affa0f","requestId":"209f8096-a2e1-42d5-b299-9c053fb42f84","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440311,"pid":21,"hostname":"6d8b80affa0f","requestId":"f43db7b9-bc79-4f47-a5a9-1393dd79614e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745440311,"pid":21,"hostname":"6d8b80affa0f","requestId":"f2e2934a-53f5-4491-b0d0-2c14aaedad4a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440312,"pid":21,"hostname":"6d8b80affa0f","requestId":"194033ac-94ff-4213-a60e-666b69050bb1","ms":1,"msg":"route_success"}
{"level":30,"time":1755745440312,"pid":21,"hostname":"6d8b80affa0f","requestId":"37e8fdab-a8cc-43eb-a3ca-10b58fc794b1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745440313,"pid":21,"hostname":"6d8b80affa0f","requestId":"085fff86-8d0c-48bc-85ac-b0bc23b943c4","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.guard.matrix.spec.ts
PASS tests/unit/api.validation.bad-request.matrix.spec.ts
{"level":30,"time":1755745441380,"pid":21,"hostname":"6d8b80affa0f","requestId":"3191765d-0ec3-4dfe-8ecb-c2a0bce8c55a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745441381,"pid":21,"hostname":"6d8b80affa0f","requestId":"fdaae4f5-f785-4dc4-a3c3-abdde6dbd265","ms":1,"msg":"route_success"}
{"level":30,"time":1755745441382,"pid":21,"hostname":"6d8b80affa0f","requestId":"9295bac3-61c7-40bf-8612-f142a37d9a43","ms":1,"msg":"route_success"}
{"level":30,"time":1755745441382,"pid":21,"hostname":"6d8b80affa0f","requestId":"2b4f3e4e-b640-484f-b768-c3c5de50c346","ms":0,"msg":"route_success"}
{"level":30,"time":1755745441383,"pid":21,"hostname":"6d8b80affa0f","requestId":"85834ff5-a06d-43ba-94c2-b845e4879d79","ms":1,"msg":"route_success"}
{"level":30,"time":1755745441384,"pid":21,"hostname":"6d8b80affa0f","requestId":"ad6abdb7-fa81-463a-ab83-d1bbcef5d27d","ms":1,"msg":"route_success"}
{"level":30,"time":1755745441384,"pid":21,"hostname":"6d8b80affa0f","requestId":"29936360-cc18-4b16-9d08-e5f8313f9e16","ms":0,"msg":"route_success"}
{"level":30,"time":1755745441385,"pid":21,"hostname":"6d8b80affa0f","requestId":"a5ee69bc-5d52-4182-bba3-31f4d4a68b90","ms":0,"msg":"route_success"}
{"level":30,"time":1755745441385,"pid":21,"hostname":"6d8b80affa0f","requestId":"b4e4a980-9e5b-4128-8406-7a1b75072e93","ms":0,"msg":"route_success"}
{"level":30,"time":1755745441386,"pid":21,"hostname":"6d8b80affa0f","requestId":"0f4a54cd-bfcc-460d-a48d-2dc3cfc93036","ms":0,"msg":"route_success"}
PASS tests/unit/ui/NotificationsDropdownClient.spec.tsx
FAIL tests/unit/api.runtime.asset.sign-url.scope.spec.ts
  ● runtime asset sign-url scopes (smoke) › missing scope → 403/401

    TypeError: Failed to parse URL from [object Object]

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

    Cause:
    TypeError: Invalid URL

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

  ● runtime asset sign-url scope › valid scope and content-type → 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      49 |     const token = makeJwt(['files.write']);
      50 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 51 |     expect([200]).toContain(res.status);
         |                   ^
      52 |     const json = await res.json();
      53 |     expect(json.url).toBeTruthy();
      54 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:51:19)

  ● runtime asset sign-url scope › unsupported content type → 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      58 |     const token = makeJwt(['files.write']);
      59 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 60 |     expect(res.status).toBe(400);
         |                        ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:60:24)

{"level":30,"time":1755745444291,"pid":21,"hostname":"6d8b80affa0f","requestId":"32e73a66-1ef6-42f8-bede-fef48019de55","ms":18,"msg":"route_success"}
{"level":30,"time":1755745444304,"pid":21,"hostname":"6d8b80affa0f","requestId":"a4497047-4afc-4949-9e7a-b9a642210233","ms":12,"msg":"route_success"}
{"level":30,"time":1755745444318,"pid":21,"hostname":"6d8b80affa0f","requestId":"5a3de92e-f76e-4979-8b53-6c8af2992fd3","ms":10,"msg":"route_success"}
{"level":30,"time":1755745444696,"pid":21,"hostname":"6d8b80affa0f","requestId":"f9471dc9-2f88-4dd3-8de6-bc09b77bd496","ms":1,"msg":"route_success"}
{"level":30,"time":1755745444696,"pid":21,"hostname":"6d8b80affa0f","requestId":"150523dc-f983-41ab-b2db-847c13f2b771","ms":0,"msg":"route_success"}
{"level":30,"time":1755745444697,"pid":21,"hostname":"6d8b80affa0f","requestId":"e04e34f2-f1d1-4a80-acd4-2de2c504cfaf","ms":1,"msg":"route_success"}
{"level":30,"time":1755745444697,"pid":21,"hostname":"6d8b80affa0f","requestId":"f987d07e-ffa2-43ff-839f-d5d46e6f10c3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745444698,"pid":21,"hostname":"6d8b80affa0f","requestId":"01e2eeba-0e72-4720-915f-18dd4a9ebe8f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745444698,"pid":21,"hostname":"6d8b80affa0f","requestId":"0babdc6e-a3a1-4ffe-a63e-cf0db966aedc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745444699,"pid":21,"hostname":"6d8b80affa0f","requestId":"e58617c4-19b7-4ff9-a39b-a4ea950a1700","ms":1,"msg":"route_success"}
{"level":30,"time":1755745444699,"pid":21,"hostname":"6d8b80affa0f","requestId":"8a17da28-eee9-443c-8c52-baac7c2a57f4","ms":0,"msg":"route_success"}
{"level":30,"time":1755745444699,"pid":21,"hostname":"6d8b80affa0f","requestId":"4f6a5b02-bc48-480a-870d-03af1926cf33","ms":0,"msg":"route_success"}
FAIL tests/unit/api.parent-links.spec.ts
  ● API /api/parent-links › GET unauth → 401; missing parent_id → 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL tests/unit/api.runtime.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL tests/unit/lib.serverFetch.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/ping 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 http://localhost:3333http://example.com/api/secure 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/test 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch utils › serverFetch builds absolute URL and propagates headers when given path

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://localhost:3333/api/ping"
    Received: "/api/ping"

      33 |       (process.env as any).PORT = '3333';
      34 |       await serverFetch('/api/ping', { headers: { 'x-request-id': 'in' } });
    > 35 |       expect(calls[0].url).toBe('http://localhost:3333/api/ping');
         |                            ^
      36 |       expect((calls[0].init.headers as Headers).get('x-request-id')).toBe('in');
      37 |     } finally {
      38 |       global.fetch = old;

      at Object.<anonymous> (unit/lib.serverFetch.spec.ts:35:28)

FAIL tests/unit/api.runtime.outcomes.jwks.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

PASS tests/unit/middleware.headers-and-guards.spec.ts
FAIL tests/unit/api.submissions.rate-limit.spec.ts
  ● submissions rate limits and headers › POST student create returns 429 with standard headers when limited

    TypeError: Failed to parse URL from [object Object]

       5 | }), { virtual: true });
       6 |
    >  7 | function post(url: string, headers?: Record<string,string>, body?: any) { return new Request(url, { method: 'POST', headers: headers as any, body: JSON.stringify(body || {}) } as any); }
         |                                                                                  ^
       8 |
       9 | describe('submissions POST rate limit headers', () => {
      10 |   const orig = { ...process.env } as any;

      at post (unit/api.submissions.rate-limit.spec.ts:7:82)
      at Object.<anonymous> (unit/api.submissions.rate-limit.spec.ts:42:48)

    Cause:
    TypeError: Invalid URL

       5 | }), { virtual: true });
       6 |
    >  7 | function post(url: string, headers?: Record<string,string>, body?: any) { return new Request(url, { method: 'POST', headers: headers as any, body: JSON.stringify(body || {}) } as any); }
         |                                                                                  ^
       8 |
       9 | describe('submissions POST rate limit headers', () => {
      10 |   const orig = { ...process.env } as any;

      at post (unit/api.submissions.rate-limit.spec.ts:7:82)
      at Object.<anonymous> (unit/api.submissions.rate-limit.spec.ts:42:48)

{"level":30,"time":1755745446040,"pid":21,"hostname":"6d8b80affa0f","requestId":"8ca9421a-7736-4c53-835c-7fe9e36d32bb","ms":1,"msg":"route_success"}
{"level":30,"time":1755745446040,"pid":21,"hostname":"6d8b80affa0f","requestId":"1af1df51-1162-44ea-a421-e42a14350874","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446042,"pid":21,"hostname":"6d8b80affa0f","requestId":"e97a092c-c8c1-4724-873d-00526e93effa","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446430,"pid":21,"hostname":"6d8b80affa0f","requestId":"5e6365f9-7dd1-4273-a453-760873f40a1b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446431,"pid":21,"hostname":"6d8b80affa0f","requestId":"10543860-8b14-4caf-b80d-adb3b9328cde","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446431,"pid":21,"hostname":"6d8b80affa0f","requestId":"587f7fb1-bb7e-4b37-b755-35ca8146b6f6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446432,"pid":21,"hostname":"6d8b80affa0f","requestId":"61c2e2c2-766f-497d-890c-92e47aa1d650","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446432,"pid":21,"hostname":"6d8b80affa0f","requestId":"44904174-e7dc-4b2b-9774-c645b754fe8b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446433,"pid":21,"hostname":"6d8b80affa0f","requestId":"ea7025dd-f61a-4f9d-b6a2-b212a20b4b99","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446433,"pid":21,"hostname":"6d8b80affa0f","requestId":"5c872454-0ca8-4339-a1c9-85ac70aefd74","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446434,"pid":21,"hostname":"6d8b80affa0f","requestId":"61f43b66-74f8-4f2d-9804-61133056eba8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446434,"pid":21,"hostname":"6d8b80affa0f","requestId":"6a0db41f-c30c-4103-a164-e963a76cbac7","ms":0,"msg":"route_success"}
PASS tests/unit/api.announcements.spec.ts
FAIL tests/unit/future.files.spec.ts
  ● Epic H: Files and Media › issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ● Epic H: Files and Media › accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

{"level":50,"time":1755745446794,"pid":21,"hostname":"6d8b80affa0f","requestId":"8da08c4c-8d53-48dd-ade7-57796f0602ae","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745446794,"pid":21,"hostname":"6d8b80affa0f","requestId":"0c9fc481-3cf5-4200-9ea2-42304a1a2938","ms":1,"msg":"route_success"}
{"level":50,"time":1755745446797,"pid":21,"hostname":"6d8b80affa0f","requestId":"73d382c1-b570-43bc-9049-13228ceac05c","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745446797,"pid":21,"hostname":"6d8b80affa0f","requestId":"b059dd19-25cb-49fd-a7b4-4614163769ae","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446798,"pid":21,"hostname":"6d8b80affa0f","requestId":"6b6bfa18-abb0-4c7a-af40-37d533087680","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446806,"pid":21,"hostname":"6d8b80affa0f","requestId":"b2e04a77-1b3c-4df4-8a7d-3be81d2903fe","ms":0,"msg":"route_success"}
{"level":30,"time":1755745446807,"pid":21,"hostname":"6d8b80affa0f","requestId":"36369175-c242-4f78-b35e-ad773d6d103a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745447155,"pid":21,"hostname":"6d8b80affa0f","requestId":"af8d0c18-9764-45e1-893d-d4574b3f170d","ms":9,"msg":"route_success"}
{"level":30,"time":1755745447165,"pid":21,"hostname":"6d8b80affa0f","requestId":"a9ade861-7bf4-4f3d-81e8-bbcfeb43ac49","ms":5,"msg":"route_success"}
FAIL tests/unit/api.runtime.checkpoint.scopes.spec.ts
  ● runtime checkpoint scopes › save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

FAIL tests/unit/api.messages.threads-and-messages.spec.ts
  ● messages threads and messages (TEST_MODE) › thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

{"level":30,"time":1755745447483,"pid":21,"hostname":"6d8b80affa0f","requestId":"0620925f-fec7-40f6-8dcb-c279d11205f8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447484,"pid":21,"hostname":"6d8b80affa0f","requestId":"eb1eac2d-c4e6-4228-9d13-3cf347e88810","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447485,"pid":21,"hostname":"6d8b80affa0f","requestId":"8b01c2aa-62cc-4e6e-9ca0-eb3832c7cbff","ms":1,"msg":"route_success"}
{"level":30,"time":1755745447485,"pid":21,"hostname":"6d8b80affa0f","requestId":"69a765a4-50e8-4e03-8507-b52dda795d52","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447791,"pid":21,"hostname":"6d8b80affa0f","requestId":"8770e708-b4d1-495c-b57b-23aedd3a39fb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447792,"pid":21,"hostname":"6d8b80affa0f","requestId":"a2da4db6-2d84-4345-9a9d-549551238f09","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447793,"pid":21,"hostname":"6d8b80affa0f","requestId":"782b61f9-c5cc-4e58-a88b-482b086e6233","ms":1,"msg":"route_success"}
{"level":30,"time":1755745447793,"pid":21,"hostname":"6d8b80affa0f","requestId":"200e5ea2-60fd-492e-b90d-77721855aed0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447794,"pid":21,"hostname":"6d8b80affa0f","requestId":"5cd18b17-d9c0-4ef4-a597-651836b8b707","ms":0,"msg":"route_success"}
{"level":30,"time":1755745447794,"pid":21,"hostname":"6d8b80affa0f","requestId":"365d8521-e3be-4118-8b66-861da068a0cc","ms":0,"msg":"route_success"}
PASS tests/unit/api.registry.spec.ts
FAIL tests/unit/api.admin.governance.smoke.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.governance.smoke.spec.ts:1:1)

FAIL tests/unit/api.runtime.events.scopes.spec.ts
  ● runtime events scopes › course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL tests/unit/api.files.download-url.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

{"level":30,"time":1755745448233,"pid":21,"hostname":"6d8b80affa0f","requestId":"01b1a468-96dd-4255-82eb-e2a0d03c51a6","ms":7,"msg":"route_success"}
{"level":30,"time":1755745448239,"pid":21,"hostname":"6d8b80affa0f","requestId":"9cc148c7-728b-4ac7-9ca8-17401da0dd1a","ms":5,"msg":"route_success"}
{"level":30,"time":1755745449033,"pid":21,"hostname":"6d8b80affa0f","requestId":"020cb07f-81f8-4a84-b95f-7fe6c049c094","ms":0,"msg":"route_success"}
FAIL tests/unit/security.csrf.double-submit.spec.ts
  ● CSRF double-submit enforcement (wrapper-level) › messages POST with matching token allowed through wrapper (may still 401/429 deeper)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 401, 403, 429, 500]

      31 |     const headers: HeadersMap = { 'x-test-auth': 'student', 'content-type': 'application/json', 'x-csrf-token': 'abc', cookie: 'csrf_token=abc' };
      32 |     const res = await (MessagesPOST as any)(req('http://localhost/api/messages', { method: 'POST', headers, body: JSON.stringify({ thread_id: 't1', body: 'hi' }) }));
    > 33 |     expect([201,401,403,429,500]).toContain(res.status);
         |                                   ^
      34 |   });
      35 |
      36 |   test('assignments PATCH without token rejected when enabled', async () => {

      at Object.<anonymous> (unit/security.csrf.double-submit.spec.ts:33:35)

FAIL tests/unit/api.assignments.crud.spec.ts
  ● Assignments CRUD API › DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

{"level":30,"time":1755745449372,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745449373,"pid":21,"hostname":"6d8b80affa0f","requestId":"c17a2837-2546-4584-987a-d981adb033ab","ms":1,"msg":"route_success"}
{"level":30,"time":1755745449380,"pid":21,"hostname":"6d8b80affa0f","requestId":"7a1bd923-5cba-4be3-9091-0d125ab5fa23","ms":1,"msg":"route_success"}
{"level":30,"time":1755745449385,"pid":21,"hostname":"6d8b80affa0f","requestId":"fd5d8af5-6031-4677-8240-64e7e67813b9","ms":2,"msg":"route_success"}
{"level":30,"time":1755745449387,"pid":21,"hostname":"6d8b80affa0f","requestId":"5c33c177-ba44-4e0a-92ad-b95c9cf3cd6f","ms":2,"msg":"route_success"}
{"level":30,"time":1755745449389,"pid":21,"hostname":"6d8b80affa0f","requestId":"177d847c-5f87-4375-bbcd-c7d0472e5362","ms":0,"msg":"route_success"}
{"level":50,"time":1755745449390,"pid":21,"hostname":"6d8b80affa0f","requestId":"027a7630-8362-4fb3-905b-8fa4babc131e","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745449390,"pid":21,"hostname":"6d8b80affa0f","requestId":"eb7c2342-366c-48f2-a8b3-7980b91cf337","ms":1,"msg":"route_success"}
FAIL tests/unit/api.role.guard.matrix.extended.spec.ts (6.291 s)
  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL tests/unit/api.providers.ratelimit.spec.ts
  ● providers create/update/delete rate-limit headers › POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ● providers create/update/delete rate-limit headers › PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ● providers create/update/delete rate-limit headers › DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

{"level":50,"time":1755745456321,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e1f452f-2d62-4952-98ad-0de4cdc18fae","ms":1,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
{"level":50,"time":1755745456331,"pid":21,"hostname":"6d8b80affa0f","requestId":"53147535-8b94-47f6-b446-a378262a242e","ms":0,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":50,"time":1755745456332,"pid":21,"hostname":"6d8b80affa0f","requestId":"4889bb91-5a85-4052-85a2-244a7e871254","ms":0,"err":"supabase.from(...).delete is not a function","msg":"route_error"}
PASS tests/unit/apiHandler.csrf.spec.ts
PASS tests/unit/api.listing.headers.matrix.spec.ts
{"level":30,"time":1755745456771,"pid":21,"hostname":"6d8b80affa0f","requestId":"1e57ff0b-fb36-4597-9287-e290ce336e84","ms":1,"msg":"route_success"}
{"level":30,"time":1755745456772,"pid":21,"hostname":"6d8b80affa0f","requestId":"323d5ccb-54d7-45f9-821e-15f302751da4","ms":1,"msg":"route_success"}
{"level":30,"time":1755745456772,"pid":21,"hostname":"6d8b80affa0f","requestId":"bbe60901-e88b-41e8-ab0b-6796119f70e9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745456773,"pid":21,"hostname":"6d8b80affa0f","requestId":"45ca9080-00cc-47f0-934c-7b73a472d540","ms":0,"msg":"route_success"}
{"level":30,"time":1755745456773,"pid":21,"hostname":"6d8b80affa0f","requestId":"ee591701-9ccf-4487-a9d1-fa18af547d97","ms":0,"msg":"route_success"}
{"level":30,"time":1755745457259,"pid":21,"hostname":"6d8b80affa0f","requestId":"7c7bd8f9-b677-4d1b-9385-1e25012e50fd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745457259,"pid":21,"hostname":"6d8b80affa0f","requestId":"9f3ede7a-19cb-4fb6-8a30-2c6b18aabfa2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745457260,"pid":21,"hostname":"6d8b80affa0f","requestId":"ec6b7515-44bd-4c67-b3e6-ee40b40313c8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745457260,"pid":21,"hostname":"6d8b80affa0f","lessonId":"00000000-0000-0000-0000-00000000ab02","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745457261,"pid":21,"hostname":"6d8b80affa0f","requestId":"609a8f45-1943-41e1-a7f2-d939712f486b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745457261,"pid":21,"hostname":"6d8b80affa0f","requestId":"21f56a76-cf8b-4b79-97e8-14127d83978d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745457262,"pid":21,"hostname":"6d8b80affa0f","lessonId":"11111111-1111-1111-1111-111111111111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745457262,"pid":21,"hostname":"6d8b80affa0f","requestId":"0e0217a7-df72-45ab-89f1-9682edb7dbf4","ms":0,"msg":"route_success"}
PASS tests/unit/api.lessons.complete.spec.ts
PASS tests/unit/gateways/SubmissionsGateway.contract.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/submissions 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/submissions 6ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/services.quizAttempts.spec.ts
FAIL tests/unit/api.runtime.checkpoint.size-limit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.checkpoint.size-limit.spec.ts:1:1)

FAIL tests/unit/api.admin.export.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

PASS tests/unit/api.headers.common.matrix.spec.ts
FAIL tests/unit/api.runtime.outcomes.runtime-token.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

{"level":30,"time":1755745459345,"pid":21,"hostname":"6d8b80affa0f","requestId":"0dcbc10b-72e7-495a-b225-f2e39eebb1c5","ms":1,"msg":"route_success"}
{"level":30,"time":1755745459346,"pid":21,"hostname":"6d8b80affa0f","requestId":"ca959847-e92c-4896-8725-894fc9ca3cdc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459347,"pid":21,"hostname":"6d8b80affa0f","requestId":"cd7fce35-9d45-4f01-9dec-e038e570e9bc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459347,"pid":21,"hostname":"6d8b80affa0f","requestId":"f4d126db-2197-4118-9afc-c4a7cd8bd374","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459347,"pid":21,"hostname":"6d8b80affa0f","requestId":"973efd1e-0f3a-4ae8-8d79-c0c43e2adb5b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459348,"pid":21,"hostname":"6d8b80affa0f","requestId":"5a4aba32-2381-4896-94e2-4a78f200a6fa","ms":1,"msg":"route_success"}
{"level":30,"time":1755745459348,"pid":21,"hostname":"6d8b80affa0f","requestId":"3af0f06c-2765-461f-9897-64cc8f61a08d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459349,"pid":21,"hostname":"6d8b80affa0f","requestId":"85f38e92-385f-411e-9295-0e11a2d4d3b6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745459351,"pid":21,"hostname":"6d8b80affa0f","requestId":"ccc6a1aa-190d-4b8f-a969-2edb367ddbd6","ms":1,"msg":"route_success"}
FAIL tests/unit/middleware.cors.disallowed-origin.spec.ts
  ● middleware CSP connect-src allowlist propagation › includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

PASS tests/unit/testStore.edgecases.spec.ts
FAIL tests/unit/server.scheduler.flags.spec.ts
  ● scheduler ensureJobsStarted flags › DUE_SOON_JOB=1 schedules due-soon job

    expect(received).toContain(expected) // indexOf

    Expected value: "assignment_due_soon"
    Received array: []

      26 |     mod.ensureJobsStarted();
      27 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 28 |     expect(calls).toContain('assignment_due_soon');
         |                   ^
      29 |   });
      30 |
      31 |   test('PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:28:19)

  ● scheduler ensureJobsStarted flags › PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "provider_health_refresh"
    Received array: []

      34 |     mod.ensureJobsStarted();
      35 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 36 |     expect(calls).toContain('provider_health_refresh');
         |                   ^
      37 |   });
      38 |
      39 |   test('REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:36:19)

  ● scheduler ensureJobsStarted flags › REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "refresh_progress_summary"
    Received array: []

      42 |     mod.ensureJobsStarted();
      43 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 44 |     expect(calls).toContain('refresh_progress_summary');
         |                   ^
      45 |   });
      46 |
      47 |   test('QUOTA_RECONCILE_JOB=1 schedules quota reconcile', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:44:19)

  ● scheduler ensureJobsStarted flags › QUOTA_RECONCILE_JOB=1 schedules quota reconcile

    expect(received).toContain(expected) // indexOf

    Expected value: "quota_reconcile"
    Received array: []

      50 |     mod.ensureJobsStarted();
      51 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 52 |     expect(calls).toContain('quota_reconcile');
         |                   ^
      53 |   });
      54 |
      55 |   test('BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:52:19)

  ● scheduler ensureJobsStarted flags › BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill

    expect(received).toContain(expected) // indexOf

    Expected value: "attachment_size_backfill"
    Received array: []

      58 |     mod.ensureJobsStarted();
      59 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 60 |     expect(calls).toContain('attachment_size_backfill');
         |                   ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:60:19)

PASS tests/unit/api.files.upload-url.rate-quota-csrf.spec.ts
{"level":30,"time":1755745461694,"pid":21,"hostname":"6d8b80affa0f","requestId":"35e23e49-9453-4964-ac5d-02a13fb20cc6","ms":1,"msg":"route_success"}
{"level":30,"time":1755745461695,"pid":21,"hostname":"6d8b80affa0f","requestId":"bcb68341-e135-4daa-bc4b-0c352d119e63","ms":1,"msg":"route_success"}
{"level":30,"time":1755745461695,"pid":21,"hostname":"6d8b80affa0f","requestId":"c7b12299-663e-48ba-b0c2-df2b0e4ace4c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745462139,"pid":21,"hostname":"6d8b80affa0f","requestId":"fd216824-17b8-4019-ba08-5a2ea0caa034","ms":0,"msg":"route_success"}
{"level":30,"time":1755745462140,"pid":21,"hostname":"6d8b80affa0f","requestId":"55c07ced-981b-4d00-881f-3d7c952287fe","ms":1,"msg":"route_success"}
{"level":30,"time":1755745462140,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-test","ms":0,"msg":"route_success"}
{"level":30,"time":1755745462141,"pid":21,"hostname":"6d8b80affa0f","requestId":"fa6291f6-4679-4f67-8c8a-ae701d12e20a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745462141,"pid":21,"hostname":"6d8b80affa0f","requestId":"f2a3ae59-c2e4-4c00-bda7-2a464122c9f0","ms":0,"msg":"route_success"}
PASS tests/unit/api.courses.id.spec.ts
PASS tests/unit/services.submissions.queue.spec.ts
PASS tests/unit/lib.logger.redaction.spec.ts
PASS tests/unit/ui/GradeRowClient.spec.tsx
PASS tests/unit/api.runtime.asset.sign-url.ratelimit.spec.ts
FAIL tests/unit/api.files.attachments.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

{"level":30,"time":1755745463872,"pid":21,"hostname":"6d8b80affa0f","requestId":"5162f029-5d96-469b-8d92-c5399c05d2d2","ms":7,"msg":"route_success"}
{"level":30,"time":1755745463875,"pid":21,"hostname":"6d8b80affa0f","requestId":"0df42915-8545-4a3c-af50-8cd89f9a1515","ms":3,"msg":"route_success"}
{"level":30,"time":1755745464965,"pid":21,"hostname":"6d8b80affa0f","requestId":"4c3343de-7422-49b9-8442-a181e2c993e2","ms":15,"msg":"route_success"}
PASS tests/unit/api.runtime.rate-limit.spec.ts
FAIL tests/unit/api.launch-token.license.enforcement.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.launch-token.license.enforcement.spec.ts:1:1)

FAIL tests/unit/lib.serverFetch.csrf-header.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/messages 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch forwards x-csrf-token when cookie present › adds x-csrf-token header for unsafe method

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc123"
    Received: "cookie-csrf"

      45 |     await serverFetch('/api/messages', { method: 'POST' });
      46 |     const h = calls[0].init.headers as Headers;
    > 47 |     expect(h.get('x-csrf-token')).toBe('abc123');
         |                                   ^
      48 |   });
      49 | });
      50 |

      at Object.<anonymous> (unit/lib.serverFetch.csrf-header.spec.ts:47:35)

FAIL tests/unit/api.runtime.grade.ratelimit.spec.ts
  ● runtime grade rate-limit headers › returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

{"level":30,"time":1755745465941,"pid":21,"hostname":"6d8b80affa0f","requestId":"f28ff189-8358-4437-bbe5-a12c45a24777","ms":10,"msg":"route_success"}
{"level":30,"time":1755745466399,"pid":21,"hostname":"6d8b80affa0f","requestId":"a9e54ef2-230b-4574-a337-f6a1d9cc30f7","ms":0,"msg":"route_success"}
{"level":50,"time":1755745466400,"pid":21,"hostname":"6d8b80affa0f","requestId":"28847092-e619-4d5c-bac8-b83f41cba0e8","ms":0,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":50,"time":1755745466407,"pid":21,"hostname":"6d8b80affa0f","requestId":"5cda2bad-8739-41c7-b232-ca3b9ce766ca","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
FAIL tests/unit/api.courses.transfer-owner.auth.spec.ts
  ● courses transfer-owner auth and rate limit › student -> 403

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:15:17)

  ● courses transfer-owner auth and rate limit › rate limit includes standard headers when exceeded

    TypeError: supabase.from(...).update is not a function

      45 |   const { data, error } = await supabase
      46 |     .from('courses')
    > 47 |     .update({ teacher_id: newOwnerId })
         |      ^
      48 |     .eq('id', params.id)
      49 |     .select('id,teacher_id')
      50 |     .single();

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:47:6)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:23:5)

FAIL tests/unit/api.admin.audit-logs.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

FAIL tests/unit/api.providers.dto-and-ratelimit.spec.ts
  ● providers endpoints DTO + ratelimit headers › rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

{"level":30,"time":1755745466915,"pid":21,"hostname":"6d8b80affa0f","requestId":"9f6cadfb-4a7d-41b4-9aca-44429515f0f7","ms":0,"msg":"route_success"}
{"level":50,"time":1755745466917,"pid":21,"hostname":"6d8b80affa0f","requestId":"9ed6d9d2-6b16-4892-9464-763112e01719","ms":1,"err":"supabase.from(...).update is not a function","msg":"route_error"}
{"level":30,"time":1755745467303,"pid":21,"hostname":"6d8b80affa0f","requestId":"e2fa1d92-49e3-45cd-99c5-9a9d76517856","ms":9,"msg":"route_success"}
FAIL tests/unit/api.runtime.events.ratelimit.spec.ts
  ● runtime events rate-limit headers › returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

PASS tests/unit/api.quiz-questions.spec.ts
{"level":30,"time":1755745467615,"pid":21,"hostname":"6d8b80affa0f","requestId":"754440bd-a788-4934-83cf-a760af537525","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467616,"pid":21,"hostname":"6d8b80affa0f","requestId":"657d4faf-4dd2-4a8c-99a7-0256e3287464","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467616,"pid":21,"hostname":"6d8b80affa0f","requestId":"518c505b-eb2a-4a1f-a578-e642394d10aa","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467617,"pid":21,"hostname":"6d8b80affa0f","requestId":"049029fd-11be-4e00-8941-5ec86be227ac","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467617,"pid":21,"hostname":"6d8b80affa0f","requestId":"b8de68e8-a7ea-4c9b-a866-0236560b3b3a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467618,"pid":21,"hostname":"6d8b80affa0f","requestId":"1b9e96f6-4b84-4125-bdfa-2cf3db77a784","ms":1,"msg":"route_success"}
{"level":30,"time":1755745467942,"pid":21,"hostname":"6d8b80affa0f","requestId":"aa6f6bb3-f60b-46ce-855f-c1e24c5759b2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467942,"pid":21,"hostname":"6d8b80affa0f","requestId":"af47e5fb-1472-4082-ba9e-459e0a47bb84","ms":0,"msg":"route_success"}
{"level":30,"time":1755745467943,"pid":21,"hostname":"6d8b80affa0f","requestId":"846b4246-c109-4172-981a-8b2521ee316d","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.v2.security.spec.ts
FAIL tests/unit/lib.serverFetch.headers.spec.ts
  ● Console

    console.debug
      [serverFetch] 400 /api/x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch headers and fetchJson › propagates x-request-id and x-test-auth and builds absolute URL

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      22 |   test('propagates x-request-id and x-test-auth and builds absolute URL', async () => {
      23 |     await serverFetch('/api/health');
    > 24 |     expect(fetchSpy).toHaveBeenCalledTimes(1);
         |                      ^
      25 |     const [url, init] = fetchSpy.mock.calls[0];
      26 |     expect(String(url)).toBe('http://localhost:3030/api/health');
      27 |     const hdrs = new Headers(init.headers);

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:24:22)

  ● serverFetch headers and fetchJson › does not attach x-csrf-token on GET even when cookie present

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))

      35 |     store.cookies.set('csrf_token', 'tok');
      36 |     await serverFetch('/api/health', { method: 'GET' });
    > 37 |     const [, init] = fetchSpy.mock.calls[0];
         |                      ^
      38 |     const hdrs = new Headers(init.headers);
      39 |     expect(hdrs.get('x-csrf-token')).toBeNull();
      40 |   });

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:37:22)

PASS tests/unit/api.messages.csrf-double-submit.spec.ts
{"level":30,"time":1755745468248,"pid":21,"hostname":"6d8b80affa0f","requestId":"99ae0e35-a8cd-4e27-84b8-4000c1cb2d47","ms":1,"msg":"route_success"}
{"level":30,"time":1755745468681,"pid":21,"hostname":"6d8b80affa0f","requestId":"rid-rt","ms":0,"msg":"route_success"}
{"level":30,"time":1755745468707,"pid":21,"hostname":"6d8b80affa0f","requestId":"91840e78-b216-436f-883e-d25805168995","ms":0,"msg":"route_success"}
FAIL tests/unit/api.files.roundtrip.spec.ts
  ● files round-trip › upload-url → PUT bytes → download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

PASS tests/unit/api.quiz-choices.spec.ts
{"level":30,"time":1755745469168,"pid":21,"hostname":"6d8b80affa0f","requestId":"9548e284-eba6-44e6-a12e-8d1e26d79b57","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469169,"pid":21,"hostname":"6d8b80affa0f","requestId":"cd2bff01-1314-482e-bc59-e4d0a8464688","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469169,"pid":21,"hostname":"6d8b80affa0f","requestId":"649eb10e-7b04-4306-96e1-8cbdf6ca7064","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469170,"pid":21,"hostname":"6d8b80affa0f","requestId":"490c3be2-73ea-4099-be44-be893243a6ef","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469170,"pid":21,"hostname":"6d8b80affa0f","requestId":"44c38ac5-c4e0-4d58-a0ac-e172c1e914ec","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469171,"pid":21,"hostname":"6d8b80affa0f","requestId":"4cb141f4-d3a4-4d15-ab8b-28120cc8438a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745469462,"pid":21,"hostname":"6d8b80affa0f","requestId":"ca70034d-09df-476b-84a8-c409e0b490b1","ms":10,"msg":"route_success"}
FAIL tests/unit/api.runtime.idempotency.spec.ts
  ● runtime progress idempotency › duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

PASS tests/unit/api.notifications.read-all.csrf.spec.ts
FAIL tests/unit/middleware.env-assertions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/middleware.env-assertions.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 |
      3 | describe('middleware production env assertions and CSRF cookie', () => {
      4 |   const orig = { ...process.env } as any;

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/middleware.env-assertions.spec.ts:1:1)

{"level":30,"time":1755745469733,"pid":21,"hostname":"6d8b80affa0f","requestId":"d085e4c0-ddde-4ba1-8cd3-7dd612812499","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469734,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e197cf8-dd93-4210-9241-2bb1bfddbc33","ms":0,"msg":"route_success"}
{"level":30,"time":1755745469734,"pid":21,"hostname":"6d8b80affa0f","requestId":"e385f5cb-4c96-42dd-91a5-9c9fc1b75a4f","ms":1,"msg":"route_success"}
{"level":30,"time":1755745470101,"pid":21,"hostname":"6d8b80affa0f","requestId":"28495d1a-88d2-46be-a880-d3019a2a7c15","ms":1,"msg":"route_success"}
{"level":30,"time":1755745470101,"pid":21,"hostname":"6d8b80affa0f","requestId":"4937b605-ab3a-4a56-99ce-07844169f6a9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745470102,"pid":21,"hostname":"6d8b80affa0f","requestId":"xx","ms":0,"msg":"route_success"}
{"level":30,"time":1755745470102,"pid":21,"hostname":"6d8b80affa0f","requestId":"yy","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.negatives.spec.ts
FAIL tests/unit/api.runtime.cors.headers.spec.ts
  ● runtime CORS headers for allowed origin › includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

{"level":30,"time":1755745470415,"pid":21,"hostname":"6d8b80affa0f","requestId":"c71d6493-9871-4368-ab85-93cbaee33288","ms":8,"msg":"route_success"}
{"level":30,"time":1755745470778,"pid":21,"hostname":"6d8b80affa0f","requestId":"fbceb073-96d5-472a-910b-802e74c805f8","ms":1,"msg":"route_success"}
{"level":30,"time":1755745470778,"pid":21,"hostname":"6d8b80affa0f","requestId":"9dc007f5-97b8-4b88-ad08-0b8054b1ffa8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745470779,"pid":21,"hostname":"6d8b80affa0f","requestId":"2c937b61-29d1-4942-8d13-e3c308ae78e1","ms":1,"msg":"route_success"}
{"level":30,"time":1755745470779,"pid":21,"hostname":"6d8b80affa0f","requestId":"c02158d3-fc25-41a8-8403-49828f1f8ff8","ms":0,"msg":"route_success"}
PASS tests/unit/api.lessons.reorder.spec.ts
PASS tests/unit/api.notifications-preferences.spec.ts
{"level":30,"time":1755745471385,"pid":21,"hostname":"6d8b80affa0f","requestId":"05d25ebd-ceeb-485a-b690-0e408dac7f4f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745471386,"pid":21,"hostname":"6d8b80affa0f","requestId":"8b019283-d786-421f-919f-b879d805d159","ms":1,"msg":"route_success"}
{"level":30,"time":1755745471386,"pid":21,"hostname":"6d8b80affa0f","requestId":"540600c3-86d2-42ca-ba27-daa263b97cfd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745471387,"pid":21,"hostname":"6d8b80affa0f","requestId":"72e4d375-7478-4329-9b84-6f887fcf375b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745471733,"pid":21,"hostname":"6d8b80affa0f","requestId":"abf8928e-ca8d-4476-a37a-d7800720e064","ms":1,"msg":"route_success"}
{"level":30,"time":1755745471744,"pid":21,"hostname":"6d8b80affa0f","requestId":"d032e6db-d898-4ff0-ba6c-84a6b993de62","ms":1,"msg":"route_success"}
FAIL tests/unit/api.assignments.target.upsert.spec.ts
  ● assignments target upsert (EXTERNAL_COURSES=1) › POST upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 500]

      15 |     const body = { course_id: '00000000-0000-0000-0000-000000000001', title: 'A', target: { source: 'v2', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      16 |     const res = await (AssignPOST as any)(req('POST', 'http://localhost/api/assignments', body));
    > 17 |     expect([201, 500]).toContain(res.status); // 201 success; 500 if DTO mismatch in test harness
         |                        ^
      18 |   });
      19 |
      20 |   test('PATCH upserts assignment_targets when target provided', async () => {

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:17:24)

  ● assignments target upsert (EXTERNAL_COURSES=1) › PATCH upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      23 |     const body = { title: 'B', target: { source: 'v1', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      24 |     const res = await (AssignPATCH as any)(req('PATCH', 'http://localhost/api/assignments?id=00000000-0000-0000-0000-000000000001', body));
    > 25 |     expect([200, 500]).toContain(res.status);
         |                        ^
      26 |   });
      27 | });
      28 |

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:25:24)

FAIL tests/unit/db.rls.negative.spec.ts
  ● DB RLS negative cases (policy guards) › student cannot read other students notifications

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ● DB RLS negative cases (policy guards) › non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ● DB RLS negative cases (policy guards) › student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

{"level":50,"time":1755745472131,"pid":21,"hostname":"6d8b80affa0f","requestId":"344d8ee4-065b-48c3-92ec-1e195d11ce08","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755745472182,"pid":21,"hostname":"6d8b80affa0f","requestId":"0c2b6699-0037-4711-983c-3d848d58fcba","ms":1,"msg":"route_success"}
PASS tests/unit/api.modes.prod-guards.spec.ts
PASS tests/unit/api.notifications.spec.ts
{"level":30,"time":1755745472606,"pid":21,"hostname":"6d8b80affa0f","requestId":"27173e88-cf3f-41e0-a768-ef67e0b57457","ms":0,"msg":"route_success"}
{"level":30,"time":1755745472608,"pid":21,"hostname":"6d8b80affa0f","requestId":"30d505af-8c38-4e62-90ab-bbe16be744f5","ms":1,"msg":"route_success"}
{"level":30,"time":1755745472871,"pid":21,"hostname":"6d8b80affa0f","requestId":"8a615d5f-b1c7-41a9-876f-526f43b7a43e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745472872,"pid":21,"hostname":"6d8b80affa0f","requestId":"8a3de1ac-9d99-4ca8-b4b9-1b85ca7dbc75","ms":0,"msg":"route_success"}
{"level":30,"time":1755745472872,"pid":21,"hostname":"6d8b80affa0f","requestId":"15bcd366-e69d-4a15-8145-2d2ea931f338","ms":0,"msg":"route_success"}
{"level":30,"time":1755745472873,"pid":21,"hostname":"6d8b80affa0f","requestId":"b87f6f6b-caf1-430c-ab72-23e069f4cd2b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745472873,"pid":21,"hostname":"6d8b80affa0f","requestId":"98645acc-033a-469d-bcdb-f2eabf77b474","ms":0,"msg":"route_success"}
PASS tests/unit/api.modules.spec.ts
PASS tests/unit/api.csrf.double-submit.spec.ts
PASS tests/unit/api.messages.threads.ratelimit.headers.spec.ts
FAIL tests/unit/middleware.security-headers.more.spec.ts
  ● middleware additional security headers › sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ● middleware additional security headers › sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL tests/unit/api.runtime.outcomes.rate-limit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

{"level":30,"time":1755745473591,"pid":21,"hostname":"6d8b80affa0f","requestId":"72938bb8-7a46-41bb-a516-4642ff669acb","ms":1,"msg":"route_success"}
{"level":30,"time":1755745473591,"pid":21,"hostname":"6d8b80affa0f","requestId":"e8e62725-08ed-4c0d-8a6b-c94004737fc1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745473593,"pid":21,"hostname":"6d8b80affa0f","requestId":"9cf9931f-3ce3-49cf-a284-232aa78d7ed9","ms":1,"msg":"route_success"}
{"level":30,"time":1755745473593,"pid":21,"hostname":"6d8b80affa0f","requestId":"06387b4a-8d0b-4335-a3e4-fd0723f068e8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745475137,"pid":21,"hostname":"6d8b80affa0f","requestId":"6ffb1a50-198e-40be-aa9d-d6194fbfae8d","ms":1,"msg":"route_success"}
{"level":30,"time":1755745475138,"pid":21,"hostname":"6d8b80affa0f","requestId":"b7920fa0-f797-49e7-b5d4-6548517668c4","ms":1,"msg":"route_success"}
{"level":30,"time":1755745475138,"pid":21,"hostname":"6d8b80affa0f","requestId":"14e735f7-7d8e-4343-9a88-9adc0ed43514","ms":0,"msg":"route_success"}
{"level":30,"time":1755745475138,"pid":21,"hostname":"6d8b80affa0f","requestId":"1f7b7403-6a22-4313-b56e-15856b61f370","ms":0,"msg":"route_success"}
{"level":30,"time":1755745475145,"pid":21,"hostname":"6d8b80affa0f","requestId":"95c3aa43-de40-47f3-866e-2a66d6f880d8","ms":0,"msg":"route_success"}
PASS tests/unit/api.rls.governance.negative.spec.ts
FAIL tests/unit/api.enrollments.spec.ts
  ● API /api/enrollments › POST unauth → 401; non-student → 403; student → 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth → 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

PASS tests/unit/testStore.spec.ts
{"level":30,"time":1755745475557,"pid":21,"hostname":"6d8b80affa0f","requestId":"e8ab4acd-f2a6-49a2-986e-c79bf5dcc122","ms":1,"msg":"route_success"}
{"level":30,"time":1755745475557,"pid":21,"hostname":"6d8b80affa0f","requestId":"1ea2dd8e-6a3d-445b-9daf-1678963c2f69","ms":0,"msg":"route_success"}
{"level":30,"time":1755745475558,"pid":21,"hostname":"6d8b80affa0f","requestId":"aec41d43-87c8-4da1-b81a-a837ebcf564b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745475560,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-enr","ms":0,"msg":"route_success"}
{"level":30,"time":1755745475985,"pid":21,"hostname":"6d8b80affa0f","requestId":"82d7ee35-c52e-4b71-b421-75931e2de1da","ms":0,"msg":"route_success"}
PASS tests/unit/server.withRouteTiming.csrf.spec.ts
FAIL tests/unit/api.providers.health.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

PASS tests/unit/services.quizzes.spec.ts
FAIL tests/unit/api.notifications.rate-limit.spec.ts
  ● notifications rate-limit headers › GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

{"level":30,"time":1755745477256,"pid":21,"hostname":"6d8b80affa0f","requestId":"fb75cc0f-f478-4fa6-8c76-598012507d75","ms":0,"msg":"route_success"}
{"level":30,"time":1755745477259,"pid":21,"hostname":"6d8b80affa0f","requestId":"3ba6d87d-be5c-499e-b553-5ca719a90d87","ms":1,"msg":"route_success"}
{"level":30,"time":1755745477536,"pid":21,"hostname":"6d8b80affa0f","requestId":"762fddc0-a05f-4503-843d-241eede3108c","ms":0,"msg":"route_success"}
FAIL tests/unit/api.assignments.post.csrf.spec.ts
  ● assignments POST CSRF double-submit › 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

PASS tests/unit/services.dashboard.spec.ts
{"level":20,"time":1755745477750,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755745477752,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_student_widgets"}
{"level":50,"time":1755745478008,"pid":21,"hostname":"6d8b80affa0f","requestId":"56f8508c-7b4a-44a1-9019-891a255e53f2","ms":1,"err":"[\n  {\n    \"code\": \"too_small\",\n    \"minimum\": 3,\n    \"type\": \"string\",\n    \"inclusive\": true,\n    \"exact\": false,\n    \"message\": \"String must contain at least 3 character(s)\",\n    \"path\": [\n      \"title\"\n    ]\n  }\n]","msg":"route_error"}
{"level":30,"time":1755745478016,"pid":21,"hostname":"6d8b80affa0f","requestId":"fd939db6-0e00-42d1-a25c-3f4943076936","ms":0,"msg":"route_success"}
FAIL tests/unit/api.quizzes.ratelimit.spec.ts
  ● quizzes rate-limit headers on PATCH/DELETE › PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

FAIL tests/unit/future.observability.logs.spec.ts
  ● observability logs (services) › dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ● observability logs (services) › progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

PASS tests/unit/api.messages.threads.ratelimit.spec.ts
FAIL tests/unit/api.progress.errors.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

{"level":30,"time":1755745478465,"pid":21,"hostname":"6d8b80affa0f","requestId":"0d44bd1a-94dd-40d6-867f-272b0bfcbcdd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745478465,"pid":21,"hostname":"6d8b80affa0f","requestId":"9205e565-9706-45ee-b05d-0fa8e50bfcb9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745478466,"pid":21,"hostname":"6d8b80affa0f","requestId":"4fa02a17-a45e-43fe-b60b-bb592311a110","ms":0,"msg":"route_success"}
{"level":20,"time":1755745479028,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
{"level":20,"time":1755745479028,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/services.dashboard.needsGrading.spec.ts
PASS tests/unit/schemas.env.runtime-keys.required.spec.ts
PASS tests/unit/services.lessons.spec.ts
FAIL tests/unit/api.files.finalize.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:1:1)

{"level":30,"time":1755745479467,"pid":21,"hostname":"6d8b80affa0f","requestId":"9b303b76-a335-4ed9-aedb-e0dc46e23906","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.pagination.spec.ts
PASS tests/unit/api.events.behavior.spec.ts
{"level":30,"time":1755745480278,"pid":21,"hostname":"6d8b80affa0f","requestId":"af2f1fc4-9a91-4f47-b768-704b3702da8d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745480280,"pid":21,"hostname":"6d8b80affa0f","requestId":"db5fad74-77eb-4706-8f2f-23755c2e5ac6","ms":1,"msg":"route_success"}
{"level":30,"time":1755745480280,"pid":21,"hostname":"6d8b80affa0f","requestId":"c13e2341-915b-4827-be47-31fdc2035727","ms":0,"msg":"route_success"}
{"level":30,"time":1755745480280,"pid":21,"hostname":"6d8b80affa0f","requestId":"77c35c9b-b27b-4186-8603-cf1e29ee8cfb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745480657,"pid":21,"hostname":"6d8b80affa0f","requestId":"00dfc7c1-3c51-4c57-b5b0-ba1964336f39","ms":0,"msg":"route_success"}
{"level":30,"time":1755745480658,"pid":21,"hostname":"6d8b80affa0f","requestId":"b4f1a901-9775-4b8f-a71c-a71ec263f2b6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745480659,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-test","ms":0,"msg":"route_success"}
PASS tests/unit/api.courses.spec.ts
FAIL tests/unit/api.teacher.grading-queue.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

{"level":30,"time":1755745482262,"pid":21,"hostname":"6d8b80affa0f","requestId":"afcc53b4-73bb-4c73-818e-1938b2591ac6","ms":132,"msg":"route_success"}
{"level":30,"time":1755745482389,"pid":21,"hostname":"6d8b80affa0f","requestId":"dd8b5933-4a89-47a9-bae1-68f994c0ccf0","ms":100,"msg":"route_success"}
{"level":30,"time":1755745482395,"pid":21,"hostname":"6d8b80affa0f","requestId":"0caa39e9-76a6-4c1f-86a1-11898a03eb83","ms":6,"msg":"route_success"}
PASS tests/unit/api.runtime.asset.sign-url.spec.ts
PASS tests/unit/future.observability.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

{"level":30,"time":1755745482738,"pid":21,"hostname":"6d8b80affa0f","requestId":"up-123","ms":1,"msg":"route_success"}
{"level":50,"time":1755745482738,"pid":21,"hostname":"6d8b80affa0f","requestId":"d2a93aa9-f850-4157-954b-af3ce8e5d990","ms":0,"err":"boom","msg":"route_error"}
{"level":30,"time":1755745483197,"pid":21,"hostname":"6d8b80affa0f","requestId":"683621bb-0ae6-4f9d-af32-35b8d754c8ff","ms":1,"msg":"route_success"}
{"level":30,"time":1755745483205,"pid":21,"hostname":"6d8b80affa0f","requestId":"c73921e6-0ee7-48b1-b12e-e1a8cb84386d","ms":1,"msg":"route_success"}
PASS tests/unit/api.announcements.ratelimit.spec.ts
PASS tests/unit/api.requestId.headers.matrix.spec.ts
{"level":30,"time":1755745483985,"pid":21,"hostname":"6d8b80affa0f","requestId":"322d05d7-da39-478d-a1c2-85fc9c2a2be3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745483986,"pid":21,"hostname":"6d8b80affa0f","requestId":"c4e9ad03-bfb6-4e69-9eb2-dae27da8ce77","ms":0,"msg":"route_success"}
{"level":30,"time":1755745484532,"pid":21,"hostname":"6d8b80affa0f","requestId":"91b152f9-1a3e-41b9-8a18-dde19d8cfa51","ms":0,"msg":"route_success"}
{"level":30,"time":1755745484533,"pid":21,"hostname":"6d8b80affa0f","requestId":"be1c7e8f-d783-4129-89ac-21ad14de6587","ms":0,"msg":"route_success"}
PASS tests/unit/api.parent-links.headers.spec.ts
PASS tests/unit/gateways/health.gateway.spec.ts
PASS tests/unit/api.runtime.cors.spec.ts
{"level":30,"time":1755745485336,"pid":21,"hostname":"6d8b80affa0f","requestId":"25293f29-dc10-48ba-b089-22646e197119","ms":32,"msg":"route_success"}
PASS tests/unit/apiHandler.spec.ts
FAIL tests/unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ● withRouteTiming skips CSRF on /api/runtime/* › cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

{"level":30,"time":1755745485922,"pid":21,"hostname":"6d8b80affa0f","requestId":"100c8eef-a4b7-4fa7-97cf-35c198a1e34f","ms":1,"msg":"route_success"}
PASS tests/unit/services.announcements.spec.ts
PASS tests/unit/ui/SystemThroughputProfiler.spec.tsx
FAIL tests/unit/api.files.download-ownership.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-ownership.spec.ts:1:1)

FAIL tests/unit/middleware.csrf-cookie.spec.ts
  ● middleware CSRF cookie issuance › sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL tests/unit/api.files.content-type-default.spec.ts
  ● files default content_type › defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

{"level":30,"time":1755745488215,"pid":21,"hostname":"6d8b80affa0f","requestId":"147e03a8-dbd7-4206-b744-bf043d26d2f7","ms":1,"msg":"route_success"}
{"level":30,"time":1755745488216,"pid":21,"hostname":"6d8b80affa0f","requestId":"dea613fa-3047-4971-9b68-bb4bf1491a39","ms":1,"msg":"route_success"}
{"level":30,"time":1755745488216,"pid":21,"hostname":"6d8b80affa0f","requestId":"3b03fbbc-683c-4aa8-8a65-059c60a7f988","ms":0,"msg":"route_success"}
{"level":20,"time":1755745488767,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755745488768,"pid":21,"hostname":"6d8b80affa0f","requestId":"eb3be830-2fbe-41cc-b0c7-044da5e4041e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745488775,"pid":21,"hostname":"6d8b80affa0f","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745488775,"pid":21,"hostname":"6d8b80affa0f","requestId":"e101bf01-4fe8-4371-b55b-3b9fb6478a0e","ms":0,"msg":"route_success"}
PASS tests/unit/api.dto.enforced.on.success.spec.ts
FAIL tests/unit/api.progress.access.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

PASS tests/unit/schemas.quiz.spec.ts
FAIL tests/unit/security.headers-and-origin.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/security.headers-and-origin.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 | import { POST as MessagesPOST } from '../../apps/web/src/app/api/messages/route';
      3 |
      4 | function req(url: string, method = 'POST', headers?: Record<string,string>, body?: any) {

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/security.headers-and-origin.spec.ts:1:1)

PASS tests/unit/api.registry.rate-limit-and-auth.spec.ts
{"level":30,"time":1755745489756,"pid":21,"hostname":"6d8b80affa0f","requestId":"529d1f5b-c494-44bf-af23-84e2212e61a2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745489756,"pid":21,"hostname":"6d8b80affa0f","requestId":"e3568be3-bf9f-4d19-94eb-3d24eac327c5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745489757,"pid":21,"hostname":"6d8b80affa0f","requestId":"b0d30a7e-97e9-47e6-b015-cf526e3b4a77","ms":0,"msg":"route_success"}
PASS tests/unit/security.csrf.double-submit.more-routes.spec.ts
PASS tests/unit/schemas.dashboard.spec.ts
FAIL tests/unit/api.runtime.teacher.outcomes.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL tests/unit/api.messages.read-all.spec.ts
  ● API /api/messages/threads/[id]/read-all › marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

{"level":30,"time":1755745490747,"pid":21,"hostname":"6d8b80affa0f","requestId":"92e5f318-5f29-4d16-a5e6-784fbcda28f2","ms":0,"msg":"route_success"}
{"level":50,"time":1755745490748,"pid":21,"hostname":"6d8b80affa0f","requestId":"cd867126-fed4-4da7-a462-85ff938f6472","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745490748,"pid":21,"hostname":"6d8b80affa0f","requestId":"4be0c8bc-5919-4851-89f8-049439908637","ms":0,"msg":"route_success"}
{"level":30,"time":1755745491000,"pid":21,"hostname":"6d8b80affa0f","requestId":"52f0ee06-c971-4880-ba32-11651513de4e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745491000,"pid":21,"hostname":"6d8b80affa0f","requestId":"ac01b647-a6c2-4baf-96dd-6bf53fbf697a","ms":0,"msg":"route_success"}
{"level":50,"time":1755745491001,"pid":21,"hostname":"6d8b80affa0f","requestId":"a52432fd-46dc-4441-9f8c-5b7edff1691b","issues":[{"path":"abc.url","message":"Invalid url"},{"path":"x y.url","message":"Invalid url"},{"path":"z/1.url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745491001,"pid":21,"hostname":"6d8b80affa0f","requestId":"64914e09-64cd-4d3e-bf00-8b7105a8ad97","ms":0,"msg":"route_success"}
FAIL tests/unit/api.files.resolve.spec.ts
  ● API /api/files/resolve › test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

PASS tests/unit/api.lessons-complete.spec.ts
{"level":30,"time":1755745491351,"pid":21,"hostname":"6d8b80affa0f","requestId":"f6f2c9c3-2e86-4f1b-aaca-1f4f350d1a49","ms":1,"msg":"route_success"}
{"level":30,"time":1755745491351,"pid":21,"hostname":"6d8b80affa0f","requestId":"62ea4b18-74bb-4a81-8ef7-b6922be1a5b3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745491352,"pid":21,"hostname":"6d8b80affa0f","lessonId":"00000000-0000-0000-0000-000000000001","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745491352,"pid":21,"hostname":"6d8b80affa0f","requestId":"44a2b5ed-892d-453f-9c2b-328bf8f77caf","ms":1,"msg":"route_success"}
PASS tests/unit/lib.jwksCache.ttl.spec.ts
FAIL tests/unit/client.serverFetch.csrf.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/messages 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch CSRF header attachment › attaches x-csrf-token for unsafe methods when cookie present

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc"
    Received: null

      20 |       Object.defineProperty(global, 'document', { value: { cookie: 'csrf_token=abc' }, configurable: true });
      21 |       await serverFetch('/api/messages', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({}) });
    > 22 |       expect(captured && typeof captured.get === 'function' ? captured.get('x-csrf-token') : captured['x-csrf-token']).toBe('abc');
         |                                                                                                                        ^
      23 |     } finally {
      24 |       (global as any).fetch = origFetch;
      25 |     }

      at Object.<anonymous> (unit/client.serverFetch.csrf.spec.ts:22:120)

FAIL tests/unit/middleware.security-headers.spec.ts
  ● middleware security headers › sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL tests/unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ● runtime outcomes JWKS rotation › refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

{"level":30,"time":1755745492357,"pid":21,"hostname":"6d8b80affa0f","requestId":"9cffdaae-1527-4b84-ada6-c39869e711e2","ms":1,"msg":"route_success"}
{"level":50,"time":1755745492696,"pid":21,"hostname":"6d8b80affa0f","requestId":"68a27200-4800-40fb-89ad-e2c6144ea1c4","ms":0,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
FAIL tests/unit/api.admin.quotas.ratelimit.headers.spec.ts
  ● admin quotas rate-limit headers › 429 includes retry-after and rate-limit headers

    TypeError: supabase.from(...).insert is not a function

      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
      54 |   // Use insert with onConflict for broader mock compatibility
    > 55 |   const resp = await (supabase.from('user_storage_quotas') as any).insert(row, { onConflict: 'user_id' } as any).select?.()?.single?.();
         |                                                                    ^
      56 |   const error = (resp as any)?.error ?? null;
      57 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      58 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:55:68)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.headers.spec.ts:18:17)

FAIL tests/unit/api.courses.transfer-owner.audit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

PASS tests/unit/api.admin.quotas.auth.spec.ts
{"level":30,"time":1755745493258,"pid":21,"hostname":"6d8b80affa0f","requestId":"e38f1d0f-b964-4458-9ba1-50093c2898ec","ms":1,"msg":"route_success"}
{"level":30,"time":1755745493259,"pid":21,"hostname":"6d8b80affa0f","requestId":"a03af3cd-9a77-4710-85c6-fd1ead8ec7b7","ms":1,"msg":"route_success"}
{"level":30,"time":1755745493259,"pid":21,"hostname":"6d8b80affa0f","requestId":"9b0162ae-1e89-4a8d-b47b-3ebb18050f28","ms":0,"msg":"route_success"}
{"level":30,"time":1755745493259,"pid":21,"hostname":"6d8b80affa0f","requestId":"96920163-ed70-4da9-bd50-ca64d2d9d3f0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745493621,"pid":21,"hostname":"6d8b80affa0f","requestId":"be8a1366-b605-4ce9-9735-d6231d7ab986","ms":0,"msg":"route_success"}
{"level":30,"time":1755745493623,"pid":21,"hostname":"6d8b80affa0f","requestId":"90395d2f-0c4e-4246-89e4-79518ceea2ac","ms":0,"msg":"route_success"}
{"level":30,"time":1755745493624,"pid":21,"hostname":"6d8b80affa0f","requestId":"4292df4a-5ad9-4417-a2f7-4180e9007f16","ms":0,"msg":"route_success"}
FAIL tests/unit/db.rls.assignments.negative.spec.ts
  ● Assignments RLS/authorization negatives › student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

PASS tests/unit/api.admin.export.usage-deadletters.csv.spec.ts
FAIL tests/unit/api.providers.get.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

{"level":30,"time":1755745494462,"pid":21,"hostname":"6d8b80affa0f","requestId":"9f2dfeb6-4aa8-4bfe-a562-ce2385c1ff12","ms":1,"msg":"route_success"}
{"level":30,"time":1755745494463,"pid":21,"hostname":"6d8b80affa0f","requestId":"b6fbb520-bab9-44c6-9c69-818fb68f2c01","ms":0,"msg":"route_success"}
{"level":30,"time":1755745494464,"pid":21,"hostname":"6d8b80affa0f","requestId":"f31299da-16b5-4b3e-ad78-a1369932c260","ms":1,"msg":"route_success"}
PASS tests/unit/runtimeAuth.verify.spec.ts
PASS tests/unit/api.quiz-choices.dto.spec.ts
{"level":30,"time":1755745495199,"pid":21,"hostname":"6d8b80affa0f","requestId":"40794c3a-6b34-4306-a85a-a6fcfa560bdb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745495200,"pid":21,"hostname":"6d8b80affa0f","requestId":"67b7d9a5-8f98-47af-88f6-f5994a2eec36","ms":0,"msg":"route_success"}
{"level":30,"time":1755745495579,"pid":21,"hostname":"6d8b80affa0f","requestId":"bbbc44fa-40c6-4a07-b48a-2300cbffa00f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745495580,"pid":21,"hostname":"6d8b80affa0f","requestId":"hdr-1","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.guards-and-headers.spec.ts
FAIL tests/unit/api.headers.security.spec.ts
  ● security headers (CSP frame-ancestors + X-Frame-Options) › middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

PASS tests/unit/api.quiz-questions.dto.spec.ts
{"level":30,"time":1755745495960,"pid":21,"hostname":"6d8b80affa0f","requestId":"398fa8a2-5867-4a7b-9f38-8e068a5b84fd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745495961,"pid":21,"hostname":"6d8b80affa0f","requestId":"41abebd5-06d5-4a39-ba9b-bd9294a575f2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745496269,"pid":21,"hostname":"6d8b80affa0f","requestId":"e52aaf39-21b6-4b94-b871-0c023bcc1fb7","ms":0,"msg":"route_success"}
{"level":30,"time":1755745496270,"pid":21,"hostname":"6d8b80affa0f","requestId":"f3798353-a729-464b-a5fe-8d15c438b035","ms":1,"msg":"route_success"}
PASS tests/unit/api.notifications.prefs.dto.spec.ts
FAIL tests/unit/api.files.upload-put.avscan.spec.ts
  ● files upload PUT test-mode AV scan › rejects EICAR test string

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 401, 403]

      13 |     const eicar = 'X5O!P%25@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
      14 |     const res = await (UploadPut as any)(put(url, headers, eicar));
    > 15 |     expect([400,401,403]).toContain(res.status);
         |                           ^
      16 |   });
      17 |
      18 |   test('accepts small benign text', async () => {

      at Object.<anonymous> (unit/api.files.upload-put.avscan.spec.ts:15:27)

  ● files upload PUT test-mode AV scan › accepts small benign text

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401, 403]

      21 |     const url = 'http://localhost/api/files/upload-url?owner_type=user&owner_id=22222222-2222-2222-2222-222222222222&content_type=text/plain';
      22 |     const res = await (UploadPut as any)(put(url, headers, 'hello'));
    > 23 |     expect([200,401,403]).toContain(res.status);
         |                           ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.files.upload-put.avscan.spec.ts:23:27)

{"level":50,"time":1755745496573,"pid":21,"hostname":"6d8b80affa0f","requestId":"2d038f8d-36ee-4a24-acc7-b13f4f7e4fed","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745496573,"pid":21,"hostname":"6d8b80affa0f","requestId":"eb7342b7-3607-4b30-9ced-00e720522d27","ms":0,"msg":"route_success"}
{"level":50,"time":1755745496575,"pid":21,"hostname":"6d8b80affa0f","requestId":"102f1e09-2ab8-4469-bd6d-d4f8041d92d9","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745496575,"pid":21,"hostname":"6d8b80affa0f","requestId":"bd8022bb-aa9f-443a-9cea-091eec49f322","ms":0,"msg":"route_success"}
PASS tests/unit/api.health.spec.ts
FAIL tests/unit/api.events.producers.spec.ts
  ● Event producers (TEST_MODE) › lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ● Event producers (TEST_MODE) › submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

{"level":30,"time":1755745497062,"pid":21,"hostname":"6d8b80affa0f","lessonId":"aaaaaaaa-aaaa-aaaa-aaaa-000000000111","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745497400,"pid":21,"hostname":"6d8b80affa0f","requestId":"4d74b6a0-e643-4ceb-89a7-430c9de8ee43","ms":0,"msg":"route_success"}
PASS tests/unit/lib.cors.preflight.spec.ts
PASS tests/unit/api.csrf.double-submit.negatives.spec.ts
FAIL tests/unit/api.files.upload-url.quota.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

PASS tests/unit/apiHandler.ratelimit.spec.ts
FAIL tests/unit/api.reports.dto.spec.ts
  ● reports endpoints headers and DTO-like responses › GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

{"level":30,"time":1755745498516,"pid":21,"hostname":"6d8b80affa0f","requestId":"d702ff3e-7b4e-4d3c-bc72-9fa31bbc3e6b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745498521,"pid":21,"hostname":"6d8b80affa0f","requestId":"8402663a-6429-4f8a-b544-f67110a1fff7","ms":1,"msg":"route_success"}
{"level":30,"time":1755745498859,"pid":21,"hostname":"6d8b80affa0f","requestId":"900724d2-bdfc-4d57-8382-28a38a3a8548","ms":1,"msg":"route_success"}
FAIL tests/unit/api.notifications.patch.csrf.spec.ts
  ● notifications preferences PATCH respects CSRF double-submit › 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

PASS tests/unit/api.submissions.csrf.negatives.spec.ts
FAIL tests/unit/ui/TeacherAnnouncements.spec.tsx
  ● Teacher Announcements (labs) › renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL tests/unit/api.user-profile.put.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

PASS tests/unit/ui/TeacherCourseInsightsAdvanced.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/courses 2ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/courses 2ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/lessons?course_id=00000000-0000-0000-0000-0000000000c1 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/lessons?course_id=00000000-0000-0000-0000-0000000000c1 4ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/api.notifications-preferences.rate-limit.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL tests/unit/api.providers.create.negatives.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

{"level":30,"time":1755745501440,"pid":21,"hostname":"6d8b80affa0f","requestId":"2cf18b99-a1f7-4182-8961-fcdf06aff085","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.announcement.spec.ts
FAIL tests/unit/rate-limit.headers.spec.ts
  ● rate limit headers on 429 › messages POST returns standard headers when throttled

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 401, 403, 429, 500]

      23 |       expect(last.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     } else {
    > 25 |       expect([201,401,403,429,500]).toContain(last.status);
         |                                     ^
      26 |     }
      27 |   });
      28 | });

      at Object.<anonymous> (unit/rate-limit.headers.spec.ts:25:37)

{"level":30,"time":1755745502688,"pid":21,"hostname":"6d8b80affa0f","requestId":"cc5cd321-003b-451e-8bef-1dbc39c40e3d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502688,"pid":21,"hostname":"6d8b80affa0f","requestId":"4a6647f4-d9fe-45ce-8e01-94b0fbdf3d83","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502689,"pid":21,"hostname":"6d8b80affa0f","requestId":"90479650-bebd-411d-b391-05ff380a03dd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502689,"pid":21,"hostname":"6d8b80affa0f","requestId":"22800990-f7fb-4a6d-85c4-b5c5d12e9c18","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502689,"pid":21,"hostname":"6d8b80affa0f","requestId":"6b75d72f-6c8f-416c-9186-d5ead9f4a19b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502689,"pid":21,"hostname":"6d8b80affa0f","requestId":"e0cc0ccb-8b1c-4161-a4b4-3c2093be163f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502689,"pid":21,"hostname":"6d8b80affa0f","requestId":"58dd9ed5-a6d8-44c1-8c71-af7c24b846d2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502690,"pid":21,"hostname":"6d8b80affa0f","requestId":"2e4c7ab4-d0d4-4e90-83dc-e6337762cc84","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502690,"pid":21,"hostname":"6d8b80affa0f","requestId":"8a98605d-1658-457f-b1f9-0ff03ac3beed","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502690,"pid":21,"hostname":"6d8b80affa0f","requestId":"47d049a7-eba7-448b-9c23-bff69624a260","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502690,"pid":21,"hostname":"6d8b80affa0f","requestId":"9979802f-ad22-44c4-bd34-5b388192f4aa","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502690,"pid":21,"hostname":"6d8b80affa0f","requestId":"8626b4ed-5b10-4447-84af-0d748e8f5f14","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"e8045fe3-c642-47f1-bbe2-d7f346e7d58b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"6b08b1a4-2284-4209-a73e-800df971d832","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"7903d692-7e4c-4028-97a5-2c439b361e77","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"242c2197-ba82-44a0-a996-7c9a3a14e8b7","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"eeebdfdd-afad-4537-b23e-c55d4b8206a2","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502691,"pid":21,"hostname":"6d8b80affa0f","requestId":"ce176b37-d125-4c66-95ba-fabd940ec86d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502692,"pid":21,"hostname":"6d8b80affa0f","requestId":"db3b1bf7-67a7-4286-ad90-f4b6d0ac7b9e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502692,"pid":21,"hostname":"6d8b80affa0f","requestId":"3ce5a41a-9732-4fe9-bb4a-3dc60bb9d9e8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502692,"pid":21,"hostname":"6d8b80affa0f","requestId":"440b63e4-68c8-499b-a539-20c52e9612b6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502692,"pid":21,"hostname":"6d8b80affa0f","requestId":"f6d2b207-d0b0-4191-91b0-7a284dfd50dc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502693,"pid":21,"hostname":"6d8b80affa0f","requestId":"e9074f9f-989f-4e67-a263-a3a709239011","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502693,"pid":21,"hostname":"6d8b80affa0f","requestId":"aa5bef11-9f7b-407b-8cdd-625e2ca25309","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502693,"pid":21,"hostname":"6d8b80affa0f","requestId":"dcd98972-de08-4bb6-8cad-ffa85e6130a5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"b8ae209d-ccf6-46e9-ab45-c896c8863a82","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"af5b29f3-46c3-4022-a9f1-271a45944922","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"6d91cc2e-6b9f-46dc-8c48-0f91bae3f5c0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"7352adb4-d788-4f4e-8ed9-3295194cc87a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"41b94d79-bca8-4785-bc5e-bfbd487e50ac","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"fd1a7c41-441a-4c25-ab81-6f2242efdf9c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502694,"pid":21,"hostname":"6d8b80affa0f","requestId":"36e18a79-9e1f-488a-bb60-aa7e5a2b145f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502695,"pid":21,"hostname":"6d8b80affa0f","requestId":"a337b90f-fbdc-4d1e-8c8c-11b082f3364e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502695,"pid":21,"hostname":"6d8b80affa0f","requestId":"72b4504a-9bd7-41fe-90d0-726a0c310f0e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502695,"pid":21,"hostname":"6d8b80affa0f","requestId":"a0f2425a-80d3-445c-979d-e72e4e9f8c32","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502695,"pid":21,"hostname":"6d8b80affa0f","requestId":"04463e7c-bf6c-4186-9cdf-cf3ed113d04b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502696,"pid":21,"hostname":"6d8b80affa0f","requestId":"c54443de-f524-4cfa-9cf0-99e6ec98fcbd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502696,"pid":21,"hostname":"6d8b80affa0f","requestId":"8e69beaf-8f08-418c-b48d-402ed43f936e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502696,"pid":21,"hostname":"6d8b80affa0f","requestId":"6de47455-a431-4e74-be4e-372be5539e71","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502697,"pid":21,"hostname":"6d8b80affa0f","requestId":"8797cb26-f40a-44b6-9e48-91f7257681d4","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502697,"pid":21,"hostname":"6d8b80affa0f","requestId":"993df1be-85c7-4759-b0c3-69c3c7e9063a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502697,"pid":21,"hostname":"6d8b80affa0f","requestId":"cf5d8db1-88c8-42e5-aa02-c0df5400bd8d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502697,"pid":21,"hostname":"6d8b80affa0f","requestId":"79b11e09-e0e3-4004-945b-13a4acfdf632","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502698,"pid":21,"hostname":"6d8b80affa0f","requestId":"5b2e3ca9-ccd4-429e-99f2-6ac12487e614","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502698,"pid":21,"hostname":"6d8b80affa0f","requestId":"8381c456-9435-452b-bfcb-3bf701197590","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502698,"pid":21,"hostname":"6d8b80affa0f","requestId":"f146d760-6d26-4cf9-9fa8-677cf26afb8a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502698,"pid":21,"hostname":"6d8b80affa0f","requestId":"082427f5-aaaa-4b6e-ab88-8f3a0edfcc95","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502698,"pid":21,"hostname":"6d8b80affa0f","requestId":"053633ca-1e7e-426d-b164-ff631ddda6df","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502699,"pid":21,"hostname":"6d8b80affa0f","requestId":"5758000f-46cb-4dcd-804f-5f4e619452e3","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502699,"pid":21,"hostname":"6d8b80affa0f","requestId":"6dc01b3d-d606-490b-bc5f-d56b3f9325c3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502699,"pid":21,"hostname":"6d8b80affa0f","requestId":"a13b901e-6c8f-4a13-8ee3-76644840014b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502699,"pid":21,"hostname":"6d8b80affa0f","requestId":"d8d696a5-3e6f-4cbc-ba33-cb28ef3b42ad","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502699,"pid":21,"hostname":"6d8b80affa0f","requestId":"8510c134-f061-4325-9ee7-164ffd7dff13","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"bd199037-6e70-4753-a449-f9e0233c290c","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"a878b22e-6c1a-442c-8209-ceff73f7eded","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"5c3cb134-5b42-43d5-abd8-8f2b9709852b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"9df8434d-02f2-4715-ac20-aa1df365e6fe","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"3849bbc3-b814-4700-8b3c-3a01bf029f8a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"4fe90c95-3d09-46df-a0ac-c1358df3bb42","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"06e26a6c-7a44-43d7-9387-1ad747dab1de","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"b68871e6-504d-4a18-a107-3bcad756bc3e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"aef49390-8139-49a2-bd5b-addefe4b4387","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502700,"pid":21,"hostname":"6d8b80affa0f","requestId":"918a3697-b10d-405d-bc13-d12754536e3a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"3bc79c46-7dc1-4380-b20c-3d650289e670","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"8fc1ca0c-e92f-452c-a6bb-ac7c756b91cb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"f3fa1f16-ee72-4ad3-8da5-5a2d9f4b7ae0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"c61b757a-9fef-4512-a3bc-d6a247e77a7d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"bc594172-0cc3-4d25-b60e-e197bc77454d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502701,"pid":21,"hostname":"6d8b80affa0f","requestId":"2f5debda-42ab-4efd-b501-2c59f4f8c4fb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502702,"pid":21,"hostname":"6d8b80affa0f","requestId":"9ee3a3dd-407b-41ce-8272-69491352227f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502702,"pid":21,"hostname":"6d8b80affa0f","requestId":"89cb3a8d-ad9a-4fa6-a881-e73a37584142","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502702,"pid":21,"hostname":"6d8b80affa0f","requestId":"059f0e7b-2723-4d1c-9d3a-cbec737a3806","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"5d47113c-790e-4001-b089-98b96fd2d3fd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"144e13f0-291e-4e1b-8344-d707a717e3b3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"c2f5153c-ec0e-4318-83fe-dc77c24e5dec","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"b0d7c950-e972-4343-8195-d238b2fb1d3a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"30569ea1-dfde-4ba2-a7ca-583093cd375b","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"20399ce3-4a6a-4d94-9d68-d4d4ddf23f1a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"e547a655-a542-4a8a-8b59-7322c02043a8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745502703,"pid":21,"hostname":"6d8b80affa0f","requestId":"9b8a4b12-eba0-4cf4-84ce-f8c605f2cef5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745503019,"pid":21,"hostname":"6d8b80affa0f","requestId":"585e88d2-f33f-4073-b7c6-1630bde6729d","ms":0,"msg":"route_success"}
PASS tests/unit/withRouteTiming.global-rate-limit.spec.ts
FAIL tests/unit/api.providers.create.happy-path.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

PASS tests/unit/ui/SystemDiagnosticsSuite.spec.tsx
PASS tests/unit/ui/StudentStudyDigest.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/enrollments 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/api.progress.student-map.spec.ts
{"level":30,"time":1755745505096,"pid":21,"hostname":"6d8b80affa0f","requestId":"9db132fe-d7c1-4537-b371-fc89d7fc4f8e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745505097,"pid":21,"hostname":"6d8b80affa0f","requestId":"rid-1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745505098,"pid":21,"hostname":"6d8b80affa0f","requestId":"5594e605-d328-4ef9-a7ae-1f4f23ef7791","ms":1,"msg":"route_success"}
{"level":30,"time":1755745505766,"pid":21,"hostname":"6d8b80affa0f","requestId":"3f1668bf-b2b7-4594-a6d2-f3e4391cff61","ms":1,"msg":"route_success"}
FAIL tests/unit/api.messages.post.ratelimit.spec.ts
  ● messages POST rate limit headers › returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

PASS tests/unit/server.withRouteTiming.ratelimit.spec.ts
{"level":30,"time":1755745506020,"pid":21,"hostname":"6d8b80affa0f","requestId":"ab2dc33c-2a54-4120-a4e0-323aceb1c925","ms":0,"msg":"route_success"}
{"level":30,"time":1755745506405,"pid":21,"hostname":"6d8b80affa0f","requestId":"4e325ca2-1114-4b72-99d4-0b8fa4ec58fc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745506406,"pid":21,"hostname":"6d8b80affa0f","requestId":"fc9f81ad-612c-4129-b5d5-ee1bfdbfe219","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.access.spec.ts
FAIL tests/unit/api.providers.health.ratelimit.spec.ts
  ● providers health rate-limit headers › 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL tests/unit/api.files.quota.enforcement.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL tests/unit/api.enrollments.launch-token.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

{"level":50,"time":1755745506713,"pid":21,"hostname":"6d8b80affa0f","requestId":"d63a27eb-11a8-486a-924e-cd9f2ea24112","ms":1,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755745507653,"pid":21,"hostname":"6d8b80affa0f","requestId":"822bc626-b331-4897-a807-1e556dd0991b","ms":0,"msg":"route_success"}
{"level":50,"time":1755745507653,"pid":21,"hostname":"6d8b80affa0f","requestId":"d16dead4-83ea-43e9-bab8-d83f74c20d80","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/server.withRouteTiming.metrics.spec.ts
PASS tests/unit/apiHandler.requestId.spec.ts
PASS tests/unit/services.assignments.spec.ts
FAIL tests/unit/gateways/reports.gateway.spec.ts
  ● ReportsGateway › engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ● ReportsGateway › gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

PASS tests/unit/services.messaging.spec.ts
PASS tests/unit/ui/StudentLearningOverviewAdvanced.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/enrollments 5ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/ui/StudentLearningOverviewDetailed.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/enrollments 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 404 /api/enrollments 4ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/api.registry.versions.rate-limit.spec.ts
{"level":30,"time":1755745510234,"pid":21,"hostname":"6d8b80affa0f","requestId":"96150c45-1d16-460d-8d84-1f138ba9f236","ms":0,"msg":"route_success"}
{"level":30,"time":1755745510234,"pid":21,"hostname":"6d8b80affa0f","requestId":"dc48db7c-52c3-4f5e-96a5-32621ef6d181","ms":0,"msg":"route_success"}
{"level":30,"time":1755745510580,"pid":21,"hostname":"6d8b80affa0f","requestId":"a42e5da3-8ec6-418f-97cb-9a5579ba7501","ms":0,"msg":"route_success"}
PASS tests/unit/api.problem-envelope.matrix.spec.ts
FAIL tests/unit/api.files.av-and-quota.negatives.spec.ts
  ● files AV stub and quota exceed › EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

{"level":30,"time":1755745510894,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e83d516-709a-4a35-ac27-7989f9ed5ed8","ms":0,"msg":"route_success"}
{"level":50,"time":1755745510895,"pid":21,"hostname":"6d8b80affa0f","requestId":"bea48d4e-5fdd-49ee-8aae-d986185caebc","issues":[{"path":"url","message":"Invalid url"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745510895,"pid":21,"hostname":"6d8b80affa0f","requestId":"41165117-229a-481f-87f5-f9170bc01df6","ms":1,"msg":"route_success"}
{"level":30,"time":1755745511264,"pid":21,"hostname":"6d8b80affa0f","requestId":"d8491d1e-1793-4c5d-b737-b41f7f58d90d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745511265,"pid":21,"hostname":"6d8b80affa0f","requestId":"af4cda58-d763-4213-a679-785b6ff0d760","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.scoping.spec.ts
PASS tests/unit/api.runtime.checkpoint.preflight.spec.ts
PASS tests/unit/api.messages.threads.spec.ts
{"level":30,"time":1755745512335,"pid":21,"hostname":"6d8b80affa0f","requestId":"2ed40ac4-6022-44da-b2e1-635d30d1b829","ms":1,"msg":"route_success"}
{"level":30,"time":1755745512336,"pid":21,"hostname":"6d8b80affa0f","requestId":"640dad60-783c-4052-a4ba-8e9511e1363f","ms":1,"msg":"route_success"}
{"level":30,"time":1755745512337,"pid":21,"hostname":"6d8b80affa0f","requestId":"ee013a54-d6ed-4c53-be20-e900fa2762dd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745512681,"pid":21,"hostname":"6d8b80affa0f","requestId":"90eb402a-d023-4036-9f5f-45a120f46ffb","ms":0,"msg":"route_success"}
{"level":30,"time":1755745512682,"pid":21,"hostname":"6d8b80affa0f","requestId":"10c81a8d-d0cd-41c7-8cbf-bff358ea2aa5","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.ratelimit.headers.spec.ts
FAIL tests/unit/middleware.coep.flag.spec.ts
  ● middleware COEP flag › sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

PASS tests/unit/api.admin.metrics.spec.ts
{"level":30,"time":1755745513102,"pid":21,"hostname":"6d8b80affa0f","requestId":"ea44d168-12dd-4357-911e-7f2793368e0b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745513102,"pid":21,"hostname":"6d8b80affa0f","requestId":"18a6fb09-af44-4092-86cb-37aa09f5b1a0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745513103,"pid":21,"hostname":"6d8b80affa0f","requestId":"51d49686-9be4-4490-a390-921d3bca7c89","ms":1,"msg":"route_success"}
PASS tests/unit/services.submissions.queue.edges.spec.ts
PASS tests/unit/api.runtime.auth.exchange.edgecases.spec.ts
{"level":30,"time":1755745513806,"pid":21,"hostname":"6d8b80affa0f","requestId":"767d2638-7a11-446c-9f3c-3bdd000db867","ms":1,"msg":"route_success"}
{"level":30,"time":1755745513829,"pid":21,"hostname":"6d8b80affa0f","requestId":"bfc04fbf-9399-403c-b504-179af2095dd6","ms":23,"msg":"route_success"}
{"level":30,"time":1755745514524,"pid":21,"hostname":"6d8b80affa0f","requestId":"255c7f79-28d7-41b4-a055-f9cdc295c28a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745514524,"pid":21,"hostname":"6d8b80affa0f","requestId":"1da6a364-188e-446a-b15f-2141ab6b61f7","ms":0,"msg":"route_success"}
{"level":30,"time":1755745514525,"pid":21,"hostname":"6d8b80affa0f","requestId":"35def0e3-fc44-48a1-af84-a79fafdfd3ec","ms":0,"msg":"route_success"}
{"level":50,"time":1755745514525,"pid":21,"hostname":"6d8b80affa0f","requestId":"55d22414-28b9-49f0-9b75-0c69b051b9d3","issues":[{"path":"key","message":"Expected boolean, received string"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745514525,"pid":21,"hostname":"6d8b80affa0f","requestId":"1bd849c9-3d0f-46a2-be2b-43ae45da828d","ms":0,"msg":"route_success"}
FAIL tests/unit/api.flags.spec.ts
  ● Feature flags API (test-mode) › GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL tests/unit/api.runtime.jwks.rotation.spec.ts
  ● runtime JWKS rotation (kid refresh) › on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

{"level":30,"time":1755745514849,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e529b88-34cf-41c3-a2c0-a33ffb7dfa8d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745515342,"pid":21,"hostname":"6d8b80affa0f","requestId":"a5de2427-f02b-48a5-9700-7c95b4bfb30d","ms":0,"msg":"route_success"}
{"level":30,"time":1755745515343,"pid":21,"hostname":"6d8b80affa0f","requestId":"0138c6f0-23aa-4e0c-b0f3-36ec923d6f3f","ms":0,"msg":"route_success"}
{"level":50,"time":1755745515343,"pid":21,"hostname":"6d8b80affa0f","requestId":"e0955db9-c4f8-43e2-ba11-6a65c76bd63c","ms":0,"err":"supabase.from(...).select(...).order is not a function","msg":"route_error"}
FAIL tests/unit/api.reports.activity-retention.spec.ts
  ● API /api/reports/activity & /api/reports/retention (TEST_MODE) › retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL tests/unit/api.files.upload-url.spec.ts
  ● api.files.upload-url › returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

{"level":30,"time":1755745515654,"pid":21,"hostname":"6d8b80affa0f","requestId":"a724be15-e928-45e8-aa76-2eecac6c95bd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745515655,"pid":21,"hostname":"6d8b80affa0f","requestId":"8ea8f40f-a422-4ce0-9693-cb8c6757adb3","ms":0,"msg":"route_success"}
{"level":30,"time":1755745515911,"pid":21,"hostname":"6d8b80affa0f","requestId":"f2ac7b4f-89c1-42e7-9279-e66104e9eb5c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745515912,"pid":21,"hostname":"6d8b80affa0f","requestId":"f5eaf3a7-6403-4aba-b180-7905e4dc123d","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.auth.aud-and-scopes.spec.ts
FAIL tests/unit/api.courses.transfer-owner.ratelimit.spec.ts
  ● courses transfer-owner rate-limit headers › returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

{"level":50,"time":1755745516146,"pid":21,"hostname":"6d8b80affa0f","requestId":"a39f67a3-4f01-4ce6-9273-ea4520ed720a","ms":0,"err":"supabase.from(...).select(...).eq is not a function","msg":"route_error"}
{"level":30,"time":1755745516527,"pid":21,"hostname":"6d8b80affa0f","requestId":"8f41511b-75f1-44d3-9b92-04550f12a306","ms":0,"msg":"route_success"}
PASS tests/unit/api.assignments.delete.ratelimit.spec.ts
FAIL tests/unit/api.user.role.auth.spec.ts
  ● user role update auth › admin -> 200 or 500 (service error tolerated)

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      16 |   test('admin -> 200 or 500 (service error tolerated)', async () => {
      17 |     const res = await (RolePATCH as any)(patch('http://localhost/api/user/role', { 'x-test-auth': 'admin' }, { userId: '11111111-1111-1111-1111-111111111111', role: 'teacher' }));
    > 18 |     expect([200,500]).toContain(res.status);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.user.role.auth.spec.ts:18:23)

{"level":30,"time":1755745516807,"pid":21,"hostname":"6d8b80affa0f","requestId":"76ae91a9-a9d4-4744-b5b2-3e784ab7d3c4","ms":1,"msg":"route_success"}
{"level":30,"time":1755745516808,"pid":21,"hostname":"6d8b80affa0f","requestId":"e80e652a-8412-4b46-902f-bab1ef9c3f8a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745516808,"pid":21,"hostname":"6d8b80affa0f","requestId":"a8756fc0-4af0-4ad8-ad04-714f495b89d6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745517090,"pid":21,"hostname":"6d8b80affa0f","requestId":"d9751e8e-06f4-4907-85c7-15e197093e15","ms":0,"msg":"route_success"}
{"level":30,"time":1755745517090,"pid":21,"hostname":"6d8b80affa0f","requestId":"4eed978f-b353-49a0-8595-d7eaf3352dca","ms":0,"msg":"route_success"}
PASS tests/unit/api.providers.health.rate-limit.spec.ts
PASS tests/unit/api.progress.rls.negatives.spec.ts
FAIL tests/unit/api.files.download-url.dev-namespace.guard.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

{"level":30,"time":1755745517338,"pid":21,"hostname":"6d8b80affa0f","requestId":"82925569-8972-476a-9c66-b8094db2d12e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745517339,"pid":21,"hostname":"6d8b80affa0f","requestId":"cd847b08-a8eb-4bae-81e3-a5f929e54bb5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745517919,"pid":21,"hostname":"6d8b80affa0f","requestId":"c18f3302-3fd1-4e90-a17d-292c9ea64daa","ms":1,"msg":"route_success"}
{"level":30,"time":1755745517927,"pid":21,"hostname":"6d8b80affa0f","requestId":"15515df7-e55f-4458-a7d2-8662407c9ce1","ms":1,"msg":"route_success"}
PASS tests/unit/api.parent-links.ratelimit.spec.ts
FAIL tests/unit/api.files.upload-url.ratelimit.spec.ts
  ● files upload-url rate limit headers › 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

PASS tests/unit/ui/ParentAnnouncementsLab.spec.tsx
FAIL tests/unit/api.attachments.delete.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

{"level":30,"time":1755745518195,"pid":21,"hostname":"6d8b80affa0f","requestId":"29321626-3c6b-49d1-93ae-69c8c51fae65","ms":0,"msg":"route_success"}
FAIL tests/unit/lib.serverFetch.extend.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 http://web:3022http://example.com/api/x 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/demo 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● serverFetch extended › absolute URL passes through unchanged

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://example.com/api/x"
    Received: "http://web:3022http://example.com/api/x"

       9 |     try {
      10 |       await serverFetch('http://example.com/api/x');
    > 11 |       expect(calls[0].url).toBe('http://example.com/api/x');
         |                            ^
      12 |     } finally {
      13 |       global.fetch = old;
      14 |     }

      at Object.<anonymous> (unit/lib.serverFetch.extend.spec.ts:11:28)

PASS tests/unit/ui/StudentLearningOverview.spec.tsx
PASS tests/unit/api.runtime.grade.idempotency.spec.ts
FAIL tests/unit/api.user.role.audit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

{"level":30,"time":1755745519077,"pid":21,"hostname":"6d8b80affa0f","requestId":"b15768d9-3064-44fa-b5a1-dbd9b51d9ca1","ms":11,"msg":"route_success"}
{"level":30,"time":1755745519081,"pid":21,"hostname":"6d8b80affa0f","requestId":"b91e290b-a05b-495b-9367-6fc06d713d97","ms":4,"msg":"route_success"}
PASS tests/unit/schemas.message.spec.ts
PASS tests/unit/api.registry.courses.rate-limit.spec.ts
{"level":30,"time":1755745520030,"pid":21,"hostname":"6d8b80affa0f","requestId":"ebf41c66-2d06-45c5-8f76-b2e0538b6954","ms":1,"msg":"route_success"}
{"level":30,"time":1755745520030,"pid":21,"hostname":"6d8b80affa0f","requestId":"ff6065f1-4094-44d1-a611-d48b5288d8e9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745520383,"pid":21,"hostname":"6d8b80affa0f","requestId":"c8758606-7642-4345-9345-a3743af299db","ms":1,"msg":"route_success"}
{"level":30,"time":1755745520384,"pid":21,"hostname":"6d8b80affa0f","requestId":"203e36d5-6751-4993-998b-1bad0681e08d","ms":1,"msg":"route_success"}
PASS tests/unit/api.progress.per-student.spec.ts
PASS tests/unit/server.withRouteTiming.csrf-double-submit.spec.ts
PASS tests/unit/api.runtime.context.roles.spec.ts
{"level":30,"time":1755745520898,"pid":21,"hostname":"6d8b80affa0f","requestId":"b82877ac-e8cc-462e-8cd1-815edbf28c2a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745520907,"pid":21,"hostname":"6d8b80affa0f","requestId":"f6a68405-1e91-47a8-bf25-99865baa74d4","ms":9,"msg":"route_success"}
PASS tests/unit/schemas.submission.spec.ts
FAIL tests/unit/api.files.download-dev-namespace.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-dev-namespace.spec.ts:1:1)

PASS tests/unit/api.runtime.progress.idempotency.spec.ts
{"level":30,"time":1755745521612,"pid":21,"hostname":"6d8b80affa0f","requestId":"090d3ae8-9795-416d-b1f9-1429bae44011","ms":5,"msg":"route_success"}
{"level":30,"time":1755745521615,"pid":21,"hostname":"6d8b80affa0f","requestId":"200f0c14-c20f-4fed-87ba-7b12fb3eb14b","ms":3,"msg":"route_success"}
{"level":30,"time":1755745521835,"pid":21,"hostname":"6d8b80affa0f","requestId":"fc13a69f-7b47-4d24-a541-5db9f0366190","ms":1,"msg":"route_success"}
FAIL tests/unit/lib.metrics.inflight.spec.ts
  ● metrics in-flight tracking › increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      21 |     incrInFlight(route);
      22 |     let s1 = snapshot();
    > 23 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      24 |     decrInFlight(route);
      25 |     decrInFlight(route);
      26 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:23:41)

PASS tests/unit/api.lessons.spec.ts
{"level":30,"time":1755745522107,"pid":21,"hostname":"6d8b80affa0f","requestId":"aaaa80f6-e630-4e6e-bb5e-d1ea3a5c7f70","ms":0,"msg":"route_success"}
{"level":30,"time":1755745522503,"pid":21,"hostname":"6d8b80affa0f","requestId":"48d74098-0332-4c36-9e5f-916fffcc3c93","ms":0,"msg":"route_success"}
{"level":30,"time":1755745522503,"pid":21,"hostname":"6d8b80affa0f","requestId":"1063bb0b-12dc-470a-80f4-1cb3f860b833","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.list.rate-limit.spec.ts
PASS tests/unit/api.role.access.matrix.spec.ts
{"level":20,"time":1755745523141,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_student_widgets"}
{"level":30,"time":1755745523141,"pid":21,"hostname":"6d8b80affa0f","requestId":"1ffcc88e-797d-4044-812d-61bbc6d46449","ms":1,"msg":"route_success"}
{"level":20,"time":1755745523142,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755745523154,"pid":21,"hostname":"6d8b80affa0f","requestId":"9bca47b2-93c3-4349-862e-3f2886345c8e","ms":12,"msg":"route_success"}
{"level":30,"time":1755745523155,"pid":21,"hostname":"6d8b80affa0f","requestId":"01097190-facc-428f-90cb-26ec207dff53","ms":1,"msg":"route_success"}
{"level":30,"time":1755745523155,"pid":21,"hostname":"6d8b80affa0f","requestId":"efb0e4fe-c73b-4716-bad9-b57427b1525a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523156,"pid":21,"hostname":"6d8b80affa0f","requestId":"feb9e7ba-d156-4d07-85e4-7a459b37abf5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523156,"pid":21,"hostname":"6d8b80affa0f","requestId":"26fe1ef3-5673-4534-9734-44dc56d3fc17","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523157,"pid":21,"hostname":"6d8b80affa0f","requestId":"3048feb4-0091-4b18-9592-5ab1cb9fb7d4","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523157,"pid":21,"hostname":"6d8b80affa0f","requestId":"ddd09669-7cb0-416c-ac45-a861d8b98029","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523404,"pid":21,"hostname":"6d8b80affa0f","requestId":"1e39dd85-21cc-41cd-ba6e-582c69f3c5ea","ms":1,"msg":"route_success"}
{"level":30,"time":1755745523404,"pid":21,"hostname":"6d8b80affa0f","requestId":"a094c9d3-67e0-47ae-9351-7cf2d89cdba4","ms":0,"msg":"route_success"}
{"level":30,"time":1755745523405,"pid":21,"hostname":"6d8b80affa0f","requestId":"d0420b8f-db7f-4643-a714-e1862565cc6f","ms":0,"msg":"route_success"}
PASS tests/unit/api.admin.dlq.auth.spec.ts
PASS tests/unit/api.assignments.delete.ratelimit.headers.spec.ts
{"level":50,"time":1755745523731,"pid":21,"hostname":"6d8b80affa0f","requestId":"4c01c6c3-f804-4557-be0a-13ee91781a7d","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745523731,"pid":21,"hostname":"6d8b80affa0f","requestId":"2f7866fb-5357-4c50-87e1-683a4f3974b2","ms":1,"msg":"route_success"}
{"level":50,"time":1755745523731,"pid":21,"hostname":"6d8b80affa0f","requestId":"6d0445b7-285e-4a4a-8345-62783dc8d397","issues":[{"path":"id","message":"Required"},{"path":"course_id","message":"Required"},{"path":"title","message":"Required"},{"path":"created_at","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745523731,"pid":21,"hostname":"6d8b80affa0f","requestId":"7d012c3e-dcf7-43d6-b712-0ca185773ea0","ms":0,"msg":"route_success"}
{"level":30,"time":1755745524146,"pid":21,"hostname":"6d8b80affa0f","requestId":"e9d819d7-7020-44b5-bb16-f0a2638ae2c2","ms":1,"msg":"route_success"}
{"level":30,"time":1755745524146,"pid":21,"hostname":"6d8b80affa0f","requestId":"076039f8-94df-49bf-a031-b30bc5392383","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.list.ratelimit.spec.ts
FAIL tests/unit/api.reports.engagement.csv-json.spec.ts
  ● reports engagement CSV/JSON › CSV returns text/csv when requested

    expect(received).toMatch(expected)

    Expected pattern: /text\/csv/
    Received string:  "application/json"

      16 |     expect([200,401,403]).toContain(res.status);
      17 |     if (res.status === 200) {
    > 18 |       expect(res.headers.get('content-type') || '').toMatch(/text\/csv/);
         |                                                     ^
      19 |     }
      20 |   });
      21 | });

      at Object.<anonymous> (unit/api.reports.engagement.csv-json.spec.ts:18:53)

{"level":30,"time":1755745524441,"pid":21,"hostname":"6d8b80affa0f","requestId":"f85fb219-270f-4e39-bfa1-c539605b44a9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745524442,"pid":21,"hostname":"6d8b80affa0f","requestId":"9b56359d-e1aa-4805-b08b-a69b0ba06eee","ms":0,"msg":"route_success"}
{"level":30,"time":1755745524814,"pid":21,"hostname":"6d8b80affa0f","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745524814,"pid":21,"hostname":"6d8b80affa0f","requestId":"b8ac4cc9-3b02-47c5-bc7d-9057ae96888e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745524814,"pid":21,"hostname":"6d8b80affa0f","lessonId":"00000000-0000-0000-0000-00000000aa11","userId":"22222222-2222-2222-2222-222222222222","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745524814,"pid":21,"hostname":"6d8b80affa0f","requestId":"eb48820b-2f71-4a94-bdfc-4bc0dc9a01a3","ms":0,"msg":"route_success"}
PASS tests/unit/api.lessons.complete.idempotent.spec.ts
PASS tests/unit/api.files.download-url.disposition.spec.ts
{"level":30,"time":1755745525195,"pid":21,"hostname":"6d8b80affa0f","requestId":"07a50d65-02b8-48c8-ae3c-c2a90cffa30a","ms":0,"msg":"route_success"}
PASS tests/unit/services.modules.spec.ts
PASS tests/unit/ui/SystemPercentileTrends.spec.tsx
PASS tests/unit/schemas.lesson.spec.ts
PASS tests/unit/api.messages.patch.ratelimit.spec.ts
{"level":30,"time":1755745527888,"pid":21,"hostname":"6d8b80affa0f","requestId":"acece6ba-30f2-4622-9b43-2768658c4d12","ms":1,"msg":"route_success"}
{"level":30,"time":1755745528342,"pid":21,"hostname":"6d8b80affa0f","requestId":"39915028-d86c-4e99-8973-ae38277b148c","ms":1,"msg":"route_success"}
{"level":30,"time":1755745528342,"pid":21,"hostname":"6d8b80affa0f","requestId":"94f67bf7-c926-4610-a02c-9c7024d2d54a","ms":0,"msg":"route_success"}
PASS tests/unit/api.analytics.events.emit.spec.ts
FAIL tests/unit/ui/AdminReports.spec.tsx
  ● Admin Reports (dashboard) › renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

PASS tests/unit/api.user-profile.spec.ts
{"level":30,"time":1755745529979,"pid":21,"hostname":"6d8b80affa0f","requestId":"2e36263a-feec-4266-868c-42ec6aef3ba6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745529980,"pid":21,"hostname":"6d8b80affa0f","requestId":"4802f888-cc57-454c-bd7d-e306d760e79c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745529981,"pid":21,"hostname":"6d8b80affa0f","requestId":"88265082-a465-456a-b4f7-7e02a3abcf5e","ms":1,"msg":"route_success"}
{"level":30,"time":1755745530533,"pid":21,"hostname":"6d8b80affa0f","requestId":"ba89ef34-052c-4ae6-8478-55dc0feb5cae","ms":1,"msg":"route_success"}
{"level":30,"time":1755745530533,"pid":21,"hostname":"6d8b80affa0f","requestId":"4d079594-8017-43ae-89a8-5ce299e54fc7","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.announcements.negative.spec.ts
PASS tests/unit/api.internal.metrics.token.spec.ts
{"level":30,"time":1755745531214,"pid":21,"hostname":"6d8b80affa0f","requestId":"b314f875-a01e-4207-8229-0f86b5d1cd01","ms":1,"msg":"route_success"}
{"level":30,"time":1755745531214,"pid":21,"hostname":"6d8b80affa0f","requestId":"658a56a4-9106-4c6b-a9f5-30133f805508","ms":0,"msg":"route_success"}
{"level":30,"time":1755745531659,"pid":21,"hostname":"6d8b80affa0f","requestId":"73e0a3bf-382e-4cf9-81c1-4256c0aa8d36","ms":0,"msg":"route_success"}
{"level":30,"time":1755745531660,"pid":21,"hostname":"6d8b80affa0f","requestId":"04c42a09-01d2-487a-bcfe-b6f857ecb02a","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.parent-links.negative.spec.ts
PASS tests/unit/api.modules.delete.ratelimit.spec.ts
{"level":30,"time":1755745532237,"pid":21,"hostname":"6d8b80affa0f","requestId":"5954c168-8a63-4341-8e82-ff8b88a6747e","ms":1,"msg":"route_success"}
{"level":50,"time":1755745532816,"pid":21,"hostname":"6d8b80affa0f","requestId":"2abc5ce2-93a1-4a74-b43c-d3f07283c357","ms":1,"err":"supabase.from(...).insert is not a function","msg":"route_error"}
FAIL tests/unit/api.admin.quotas.ratelimit.spec.ts
  ● admin quotas PATCH rate-limit headers › returns 429 and retry-after header when limited

    TypeError: supabase.from(...).insert is not a function

      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
      54 |   // Use insert with onConflict for broader mock compatibility
    > 55 |   const resp = await (supabase.from('user_storage_quotas') as any).insert(row, { onConflict: 'user_id' } as any).select?.()?.single?.();
         |                                                                    ^
      56 |   const error = (resp as any)?.error ?? null;
      57 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      58 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:55:68)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

PASS tests/unit/gateways/enrollments.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/enrollments 1ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /api/enrollments 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

FAIL tests/unit/db.rls.courses.negative.spec.ts
  ● Courses RLS/authorization negatives › student cannot create course

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/courses', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ title: 'X', description: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot delete course', async () => {

      at Object.<anonymous> (unit/db.rls.courses.negative.spec.ts:6:23)

{"level":30,"time":1755745533753,"pid":21,"hostname":"6d8b80affa0f","requestId":"7aea2491-9d03-42db-8b72-05c8774d2d71","ms":1,"msg":"route_success"}
{"level":30,"time":1755745533762,"pid":21,"hostname":"6d8b80affa0f","requestId":"078e3ce2-3af2-4884-a85a-f114e247441b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745534022,"pid":21,"hostname":"6d8b80affa0f","requestId":"1983ee30-d23c-4706-b571-55c7ceeaedb6","ms":0,"msg":"route_success"}
PASS tests/unit/api.providers.health.ratelimit.headers.spec.ts
PASS tests/unit/schemas.assignment.spec.ts
PASS tests/unit/api.submissions.list.pagination.spec.ts
{"level":30,"time":1755745534506,"pid":21,"hostname":"6d8b80affa0f","requestId":"fecbeb51-e2f1-43f1-bf3b-fe96eae05789","ms":0,"msg":"route_success"}
{"level":30,"time":1755745534800,"pid":21,"hostname":"6d8b80affa0f","requestId":"7b178355-4c26-42d5-8ba0-34f35f43ccaf","ms":1,"msg":"route_success"}
PASS tests/unit/api.runtime.checkpoint.roundtrip.spec.ts
PASS tests/unit/logger.redaction.spec.ts
PASS tests/unit/api.submissions.grade.spec.ts
PASS tests/unit/ui/StudentUpcomingLessons.spec.tsx
{"level":30,"time":1755745535250,"pid":21,"hostname":"6d8b80affa0f","requestId":"d544663e-2501-4de0-a4d3-a3c9680e8e77","ms":0,"msg":"route_success"}
{"level":30,"time":1755745535251,"pid":21,"hostname":"6d8b80affa0f","requestId":"bafadbb3-ebf1-4a94-a22e-21b512081338","ms":0,"msg":"route_success"}
{"level":30,"time":1755745535251,"pid":21,"hostname":"6d8b80affa0f","requestId":"11564fa6-34b0-4c49-8fa6-32dc736c5a8f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745535644,"pid":21,"hostname":"6d8b80affa0f","requestId":"ccf0001b-e259-4c94-aa2e-5701dced2c46","ms":0,"msg":"route_success"}
{"level":30,"time":1755745535645,"pid":21,"hostname":"6d8b80affa0f","requestId":"19da807d-8ca8-49ec-9af7-2b8ddddb914d","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.auth.spec.ts
PASS tests/unit/ui/SystemObserver.spec.tsx
FAIL tests/unit/lib.runtimeAuth.scopes-aud.spec.ts
  ● runtimeAuth audience and scopes › rejects when aud mismatches allowed origin

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /workspace/tests/node_modules/jose/dist/webapi/index.js:1
    ({"Object.<anonymous>":function(module,exports,require,__dirname,__filename,jest){export { compactDecrypt } from './jwe/compact/decrypt.js';
                                                                                      ^^^^^^

    SyntaxError: Unexpected token 'export'

      10 |     // Mock getRequestOrigin to return allowed origin and jose verify to return payload with different aud
      11 |     jest.spyOn(require('../../apps/web/src/lib/cors'), 'getRequestOrigin').mockReturnValue('https://good.example' as any);
    > 12 |     jest.spyOn(require('jose') as any, 'jwtVerify').mockResolvedValue({ payload: { aud: 'https://bad.example', scopes: [] } });
         |                ^
      13 |     const out = verifyRuntimeAuthorization(req as any, [] as any) as any;
      14 |     expect(out).toBeTruthy();
      15 |   });

      at Runtime.createScriptFromCode (../node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (unit/lib.runtimeAuth.scopes-aud.spec.ts:12:16)

PASS tests/unit/ui/SystemHealthHistory.spec.tsx
FAIL tests/unit/lib.runtimeAuth.clockskew.spec.ts
  ● runtimeAuth clock skew tolerance › accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

PASS tests/unit/ui/TeacherCourseInsights.spec.tsx
PASS tests/unit/db.rls.submissions.negative.spec.ts
{"level":30,"time":1755745537583,"pid":21,"hostname":"6d8b80affa0f","requestId":"fdf7eb1a-562f-4537-bfb4-cd281c1de49f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745537584,"pid":21,"hostname":"6d8b80affa0f","requestId":"02c56e40-838f-443c-b6b7-ce369788544f","ms":1,"msg":"route_success"}
{"level":30,"time":1755745537913,"pid":21,"hostname":"6d8b80affa0f","requestId":"69da9473-2f4b-46b3-8aca-ef7569fa5264","ms":1,"msg":"route_success"}
{"level":30,"time":1755745537913,"pid":21,"hostname":"6d8b80affa0f","requestId":"7ff24cf2-f7d5-4e3c-804b-55ed1eb849fc","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.prefs.auth.spec.ts
PASS tests/unit/lib.rateLimit.redis-fallback.spec.ts
PASS tests/unit/api.runtime.idempotency.progress.spec.ts
{"level":30,"time":1755745538392,"pid":21,"hostname":"6d8b80affa0f","requestId":"f8c70239-c72d-438f-a411-055a8a6df727","ms":16,"msg":"route_success"}
{"level":30,"time":1755745538402,"pid":21,"hostname":"6d8b80affa0f","requestId":"4f5e67a0-ba72-492b-9a94-eb38802fc95e","ms":9,"msg":"route_success"}
{"level":30,"time":1755745538877,"pid":21,"hostname":"6d8b80affa0f","requestId":"e001dee5-bf17-44f4-ac9a-2dacbb24066f","ms":1,"msg":"route_success"}
FAIL tests/unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ● runtime outcomes provider JWT iss/aud negatives › invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

PASS tests/unit/ui/SystemRequestId.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/health 3ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/ui/SystemLatencySampler.spec.tsx
PASS tests/unit/lib.csp.frame-src-allow.spec.ts
PASS tests/unit/db.rls.quiz-attempts.negative.spec.ts
{"level":30,"time":1755745540418,"pid":21,"hostname":"6d8b80affa0f","requestId":"789fdb72-de43-478a-adc7-39686e50ccf4","ms":0,"msg":"route_success"}
{"level":30,"time":1755745540419,"pid":21,"hostname":"6d8b80affa0f","requestId":"cb2be4d3-d305-475e-9a0c-04c333772e09","ms":0,"msg":"route_success"}
{"level":30,"time":1755745540781,"pid":21,"hostname":"6d8b80affa0f","requestId":"1ba2e331-31bb-4bfd-9220-3356bd3cebb0","ms":1,"msg":"route_success"}
{"level":30,"time":1755745540781,"pid":21,"hostname":"6d8b80affa0f","requestId":"60ccbe6b-452e-49ca-aca1-8542d8511d62","ms":0,"msg":"route_success"}
PASS tests/unit/api.registry.licenses.auth.spec.ts
PASS tests/unit/api.dashboard.spec.ts
{"level":30,"time":1755745541159,"pid":21,"hostname":"6d8b80affa0f","requestId":"f9188a50-ecae-4c2b-9499-1a65a486cf1c","ms":1,"msg":"route_success"}
{"level":20,"time":1755745541160,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755745541160,"pid":21,"hostname":"6d8b80affa0f","requestId":"7d2bd262-f06b-4b8b-9637-1c73115bc21e","ms":0,"msg":"route_success"}
{"level":30,"time":1755745541528,"pid":21,"hostname":"6d8b80affa0f","requestId":"3b31b0c7-1a7b-4a54-8ba2-8db559e6cf6c","ms":2,"msg":"route_success"}
{"level":30,"time":1755745541529,"pid":21,"hostname":"6d8b80affa0f","requestId":"31a18c70-5c50-4e4c-9c35-e6ec5af6b96f","ms":1,"msg":"route_success"}
PASS tests/unit/api.submissions.grade.validation.spec.ts
FAIL tests/unit/api.messages.threads.auth.spec.ts
  ● API /api/messages/threads auth › unauthenticated POST → 401

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 400

      12 |   test('unauthenticated POST → 401', async () => {
      13 |     const res = await (ThreadsPOST as any)(post('http://localhost/api/messages/threads', { participant_ids: [] }));
    > 14 |     expect(res.status).toBe(401);
         |                        ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/api.messages.threads.auth.spec.ts:14:24)

{"level":30,"time":1755745541851,"pid":21,"hostname":"6d8b80affa0f","requestId":"d4986a2e-2592-47c2-8da7-1a6e7b9b5a67","ms":1,"msg":"route_success"}
{"level":30,"time":1755745541852,"pid":21,"hostname":"6d8b80affa0f","requestId":"ab425d3c-d287-4b0d-aaad-5857082b37dc","ms":0,"msg":"route_success"}
{"level":30,"time":1755745542209,"pid":21,"hostname":"6d8b80affa0f","requestId":"e74fecf3-f6ae-4635-b2d2-afced826fcfd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745542210,"pid":21,"hostname":"6d8b80affa0f","requestId":"2af6fecb-7d84-4ab2-8a57-c79e9de7a3e8","ms":1,"msg":"route_success"}
PASS tests/unit/db.rls.messages.negative.spec.ts
PASS tests/unit/api.problem.envelope.codes.spec.ts
{"level":30,"time":1755745542550,"pid":21,"hostname":"6d8b80affa0f","requestId":"ae9a6e74-7115-4741-be1f-f0631c3c6562","ms":0,"msg":"route_success"}
PASS tests/unit/ui/SystemUptimeTile.spec.tsx
PASS tests/unit/schemas.files.spec.ts
PASS tests/unit/api.messages.patch-negatives.spec.ts
{"level":30,"time":1755745543590,"pid":21,"hostname":"6d8b80affa0f","requestId":"m-p1","ms":1,"msg":"route_success"}
{"level":30,"time":1755745543590,"pid":21,"hostname":"6d8b80affa0f","requestId":"1769ad37-9d5e-4b30-878c-0b61d98cc1b5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745543861,"pid":21,"hostname":"6d8b80affa0f","requestId":"e4c2ef9e-0c4b-4685-8020-0262c672de7c","ms":1,"msg":"route_success"}
PASS tests/unit/api.reports.grade-distribution.empty.spec.ts
PASS tests/unit/lib.serverFetch.baseurl.spec.ts
PASS tests/unit/ui/StudentProfile.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/user/profile 2ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/modules.update.spec.ts
PASS tests/unit/services.assignments.producer.spec.ts
PASS tests/unit/api.reports.engagement.headers.spec.ts
PASS tests/unit/ui/StudentPlanner.spec.tsx
{"level":30,"time":1755745545358,"pid":21,"hostname":"6d8b80affa0f","requestId":"ab59cf93-a714-41ec-b641-051b2a2a0f11","ms":1,"msg":"route_success"}
PASS tests/unit/server.scheduler.spec.ts
PASS tests/unit/ui/SystemRoleBadge.spec.tsx
PASS tests/unit/api.user.profile.auth.spec.ts
{"level":30,"time":1755745547310,"pid":21,"hostname":"6d8b80affa0f","requestId":"e26bbb09-61dd-4e14-a798-bf85760494ea","ms":0,"msg":"route_success"}
{"level":30,"time":1755745547310,"pid":21,"hostname":"6d8b80affa0f","requestId":"74188911-0cb5-4554-a01b-f46ee78fef7e","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.outcomes.preflight.spec.ts
FAIL tests/unit/ui/SystemAuthCheck.spec.tsx
  ● Console

    console.debug
      [serverFetch] 404 /api/user/profile 4ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

  ● System Auth Check (labs) › renders email and role when authenticated

    expect(element).toHaveTextContent()

    Expected element to have text content:
      t@example.com
    Received:
      s@example.com

      15 |     const ui = await AuthCheckPage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('auth-email')).toHaveTextContent('t@example.com');
         |                                                     ^
      18 |     expect(await screen.findByTestId('auth-role')).toHaveTextContent('teacher');
      19 |   });
      20 | });

      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:17:53)

PASS tests/unit/api.pagination.params.spec.ts
{"level":30,"time":1755745549378,"pid":21,"hostname":"6d8b80affa0f","requestId":"56325b33-e7ad-4c06-a8e2-ae3fbe4f8125","ms":1,"msg":"route_success"}
{"level":30,"time":1755745549755,"pid":21,"hostname":"6d8b80affa0f","requestId":"9da9d47b-7ad9-4556-bbdd-c051a11cde5b","ms":1,"msg":"route_success"}
{"level":30,"time":1755745549728,"pid":21,"hostname":"6d8b80affa0f","requestId":"12f98941-b097-4e03-b638-1ba3e2a5d658","ms":-28,"msg":"route_success"}
FAIL tests/unit/api.parent.progress.api.spec.ts
  ● API /api/parent/progress (TEST_MODE) › parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

PASS tests/unit/api.files.upload-url.content-type.spec.ts
{"level":30,"time":1755745549995,"pid":21,"hostname":"6d8b80affa0f","requestId":"25221cba-6968-4112-93f6-e34b93537d03","ms":1,"msg":"route_success"}
FAIL tests/unit/ui/ParentChildrenReport.spec.tsx
  ● Parent Children Report (labs) › renders total and items

    Unable to find an element by: [data-testid="children-total"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<a[39m
            [33mclass[39m=[32m"text-blue-600 underline"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mSign in[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      17 |     const ui = await ParentChildrenReportPage();
      18 |     render(ui);
    > 19 |     expect(await screen.findByTestId('children-total')).toHaveTextContent('1');
         |                         ^
      20 |   });
      21 | });
      22 |

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:19:25)

PASS tests/unit/services.notifications.spec.ts
FAIL tests/unit/ui/SystemOkCard.spec.tsx
  ● System OK Card (labs) › renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

PASS tests/unit/api.reports.grade-distribution.headers.spec.ts
PASS tests/unit/lib.logger.redaction.extended.spec.ts
{"level":30,"time":1755745552961,"pid":21,"hostname":"6d8b80affa0f","requestId":"6055f87e-eea3-4a13-90e9-e55735e82eac","ms":0,"msg":"route_success"}
PASS tests/unit/services.submissions.spec.ts
PASS tests/unit/api.runtime.asset.sign-url.preflight.spec.ts
PASS tests/unit/gateways/announcements.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/announcements 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/sdk.fetchJson.spec.ts
  ● Console

    console.debug
      [serverFetch] 400 /x 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

    console.debug
      [serverFetch] 200 /y 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/schemas.progress.spec.ts
FAIL tests/unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ● runtime outcomes strict iss/aud enforcement › issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

{"level":30,"time":1755745554055,"pid":21,"hostname":"6d8b80affa0f","requestId":"36468634-4870-4749-b827-8108de3a24e6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745554352,"pid":21,"hostname":"6d8b80affa0f","requestId":"n1","ms":0,"msg":"route_success"}
PASS tests/unit/api.notifications.guard.spec.ts
PASS tests/unit/ui/TeacherCourseCardsWithCounts.spec.tsx
PASS tests/unit/api.runtime.events.preflight.spec.ts
PASS tests/unit/api.health.requiredEnvs.spec.ts
PASS tests/unit/api.routeTiming.spec.ts
{"level":30,"time":1755745555252,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-1","ms":1,"msg":"route_success"}
{"level":50,"time":1755745555252,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-2","ms":0,"err":"boom","msg":"route_error"}
PASS tests/unit/ui/TeacherPrintPages.spec.tsx
PASS tests/unit/api.runtime.grade.cors.preflight.spec.ts
PASS tests/unit/ui/NotificationsInboxPage.spec.tsx
PASS tests/unit/ui/DropdownMenu.spec.tsx
PASS tests/unit/api.submissions.get-required.spec.ts
{"level":30,"time":1755745557080,"pid":21,"hostname":"6d8b80affa0f","requestId":"d6a63c7a-6108-4ece-866f-39e196833695","ms":1,"msg":"route_success"}
{"level":30,"time":1755745557080,"pid":21,"hostname":"6d8b80affa0f","requestId":"f9d1898c-ffa3-462e-aff6-2cf52b2a71e8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745557590,"pid":21,"hostname":"6d8b80affa0f","requestId":"13b022f6-68b6-4de3-b471-c2d18224aef8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745557591,"pid":21,"hostname":"6d8b80affa0f","requestId":"0a423ceb-b4be-444b-9a30-79f853cd79d9","ms":1,"msg":"route_success"}
PASS tests/unit/api.internal.metrics.auth.spec.ts
FAIL tests/unit/ui/ParentChildren.spec.tsx
  ● Parent Children (labs) › renders list with one linked student

    Unable to find an element by: [data-testid="children-list"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<a[39m
            [33mclass[39m=[32m"text-blue-600 underline"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mSign in[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await ParentChildrenListPage();
      16 |     render(ui);
    > 17 |     await screen.findByTestId('children-list');
         |                  ^
      18 |   });
      19 | });
      20 |

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:17:18)

PASS tests/unit/api.messages.list.pagination.params.spec.ts
{"level":30,"time":1755745560294,"pid":21,"hostname":"6d8b80affa0f","requestId":"2b25951a-67ca-4840-981a-6afadde61bcd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745560840,"pid":21,"hostname":"6d8b80affa0f","requestId":"7fd6bd5a-4e48-4d48-9b77-2ddcc11778c7","ms":0,"msg":"route_success"}
PASS tests/unit/api.files.upload-url.allowed-mime.spec.ts
PASS tests/unit/api.runtime.context.dto-requestid.spec.ts
{"level":30,"time":1755745561383,"pid":21,"hostname":"6d8b80affa0f","requestId":"e4aa7274-d8c5-446e-b3a6-86b628c2d011","ms":0,"msg":"route_success"}
{"level":30,"time":1755745561720,"pid":21,"hostname":"6d8b80affa0f","requestId":"358b661c-9874-4b76-bab9-db48dc371f3d","ms":1,"msg":"route_success"}
PASS tests/unit/api.internal.metrics.content-type.spec.ts
FAIL tests/unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ● runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement › rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

{"level":30,"time":1755745562110,"pid":21,"hostname":"6d8b80affa0f","requestId":"158c67b4-4aca-40fb-b399-9cad7f9370c6","ms":2,"msg":"route_success"}
{"level":30,"time":1755745562916,"pid":21,"hostname":"6d8b80affa0f","requestId":"6e6e58c5-9dcb-4ce3-b871-10e33987a0da","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.threads.pagination.params.spec.ts
FAIL tests/unit/middleware.coep.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/middleware.coep.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 |
      3 | describe('COEP header behavior', () => {
      4 |   const orig = { ...process.env } as any;

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/middleware.coep.spec.ts:1:1)

PASS tests/unit/api.reports.csv.content-type.spec.ts
{"level":30,"time":1755745563413,"pid":21,"hostname":"6d8b80affa0f","requestId":"07d4703a-5224-496e-92ea-7b01ab105788","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.quiz.extend2.spec.ts
PASS tests/unit/ui/TeacherAnalyticsLab.spec.tsx
PASS tests/unit/api.runtime.context.audience.spec.ts
{"level":30,"time":1755745564771,"pid":21,"hostname":"6d8b80affa0f","requestId":"23bcc060-72eb-4108-a63b-8523bf71317e","ms":23,"msg":"route_success"}
{"level":20,"time":1755745565319,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
{"level":30,"time":1755745565319,"pid":21,"hostname":"6d8b80affa0f","requestId":"rq-99","ms":1,"msg":"route_success"}
PASS tests/unit/api.dashboard.teacher-kpis.spec.ts
PASS tests/unit/api.providers.list.dto.spec.ts
{"level":30,"time":1755745565963,"pid":21,"hostname":"6d8b80affa0f","requestId":"d3532c56-83f5-46b9-b65d-151588f54c04","ms":0,"msg":"route_success"}
PASS tests/unit/services.parentLinks.spec.ts
PASS tests/unit/schemas.strictness.spec.ts
PASS tests/unit/schemas.auth.spec.ts
PASS tests/unit/api.reports.export.headers.spec.ts
{"level":30,"time":1755745567311,"pid":21,"hostname":"6d8b80affa0f","requestId":"838a6abb-d6b7-4d96-8045-3438f9bb6593","ms":0,"msg":"route_success"}
{"level":30,"time":1755745567837,"pid":21,"hostname":"6d8b80affa0f","requestId":"pid-1","ms":0,"msg":"route_success"}
{"level":30,"time":1755745567838,"pid":21,"hostname":"6d8b80affa0f","requestId":"pid-1","ms":0,"msg":"route_success"}
PASS tests/unit/api.progress.request-id.spec.ts
PASS tests/unit/ui/DarkModeToggle.spec.tsx
PASS tests/unit/api.user.role.headers.spec.ts
{"level":30,"time":1755745568653,"pid":21,"hostname":"6d8b80affa0f","requestId":"e14abdaa-3c66-4db1-94c3-fb50b02a36f9","ms":0,"msg":"route_success"}
{"level":30,"time":1755745569113,"pid":21,"hostname":"6d8b80affa0f","requestId":"5d1d27bf-7e00-49fc-8732-c066687f9397","ms":1,"msg":"route_success"}
{"level":30,"time":1755745569114,"pid":21,"hostname":"6d8b80affa0f","requestId":"082b6816-a1c7-4b15-8802-563a4485e7ee","ms":1,"msg":"route_success"}
PASS tests/unit/api.files.download-url.spec.ts
FAIL tests/unit/api.messages.read-all-thread.spec.ts
  ● messages read-all by thread id › student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

{"level":50,"time":1755745569719,"pid":21,"hostname":"6d8b80affa0f","requestId":"5d1cf39d-e8af-4ff7-8d50-1135830697ed","issues":[{"path":"updated","message":"Required"}],"msg":"dto_response_validation_failed"}
{"level":30,"time":1755745569719,"pid":21,"hostname":"6d8b80affa0f","requestId":"0e9a4438-01ef-49ab-bc9b-e8df76192966","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.parentLink.spec.ts
PASS tests/unit/lib.testMode.spec.ts
PASS tests/unit/gateways.registry.pagination.spec.ts
PASS tests/unit/api.assignments.patch-missing-id.spec.ts
{"level":30,"time":1755745570926,"pid":21,"hostname":"6d8b80affa0f","requestId":"a-p1","ms":1,"msg":"route_success"}
{"level":30,"time":1755745571271,"pid":21,"hostname":"6d8b80affa0f","requestId":"5239d992-c81f-4509-a82e-90a57df91f8a","ms":1,"msg":"route_success"}
PASS tests/unit/api.user.profile.headers.spec.ts
PASS tests/unit/api.providers.health.summaries.auth.spec.ts
{"level":30,"time":1755745571697,"pid":21,"hostname":"6d8b80affa0f","requestId":"e1df63cc-6f56-44b1-9be9-a785a59fd7ab","ms":0,"msg":"route_success"}
{"level":30,"time":1755745571698,"pid":21,"hostname":"6d8b80affa0f","requestId":"48edf4a3-127f-4635-bcd2-f76e5fc0d5a7","ms":0,"msg":"route_success"}
{"level":30,"time":1755745572110,"pid":21,"hostname":"6d8b80affa0f","requestId":"db1dd49d-8040-4ada-a0ad-d818aca70fd2","ms":1,"msg":"route_success"}
PASS tests/unit/api.progress.teacher-counts.spec.ts
PASS tests/unit/schemas.event.spec.ts
PASS tests/unit/api.messages.guard.spec.ts
{"level":30,"time":1755745572722,"pid":21,"hostname":"6d8b80affa0f","requestId":"4f3c9bc9-c4ae-454e-9d93-f2787b0d094f","ms":1,"msg":"route_success"}
{"level":30,"time":1755745573225,"pid":21,"hostname":"6d8b80affa0f","requestId":"2558c188-2eb1-45a7-b22c-53bd00e1094d","ms":1,"msg":"route_success"}
PASS tests/unit/api.submissions.list.total-count.spec.ts
PASS tests/unit/ui/telemetry.spec.tsx
PASS tests/unit/api.assignments.list.total-count.spec.ts
{"level":30,"time":1755745573833,"pid":21,"hostname":"6d8b80affa0f","requestId":"2c1825c8-dc82-41b3-bb56-6c0cfdd1678f","ms":0,"msg":"route_success"}
{"level":30,"time":1755745574175,"pid":21,"hostname":"6d8b80affa0f","requestId":"m1","ms":0,"msg":"route_success"}
PASS tests/unit/api.messages.missing-thread.spec.ts
PASS tests/unit/api.messages.list.total-count.spec.ts
{"level":30,"time":1755745574707,"pid":21,"hostname":"6d8b80affa0f","requestId":"989f0b8f-f53a-4634-b050-820d06f1a076","ms":0,"msg":"route_success"}
{"level":30,"time":1755745575324,"pid":21,"hostname":"6d8b80affa0f","requestId":"5e3e4034-9821-4e98-b00c-bf7ea06590f7","ms":1,"msg":"route_success"}
PASS tests/unit/api.registry.versions.dto.spec.ts
PASS tests/unit/api.assignments.list.spec.ts
{"level":30,"time":1755745575891,"pid":21,"hostname":"6d8b80affa0f","requestId":"e9fef7e5-42a2-454e-b7d1-63b8a4569845","ms":0,"msg":"route_success"}
{"level":30,"time":1755745575892,"pid":21,"hostname":"6d8b80affa0f","requestId":"22d8b9b1-3495-4d4a-98fb-52e5d89b1f8c","ms":0,"msg":"route_success"}
{"level":30,"time":1755745576526,"pid":21,"hostname":"6d8b80affa0f","requestId":"ecd56d26-7f01-4e82-b96f-f9bdf5e297ed","ms":0,"msg":"route_success"}
{"level":30,"time":1755745576527,"pid":21,"hostname":"6d8b80affa0f","requestId":"c8786e40-ae83-40da-8101-e23d379cf9fd","ms":0,"msg":"route_success"}
PASS tests/unit/api.teacher.grading-queue.auth.spec.ts
PASS tests/unit/api.admin.metrics.auth.spec.ts
{"level":30,"time":1755745577100,"pid":21,"hostname":"6d8b80affa0f","requestId":"95519ace-3aa1-413a-83a7-efb25621eda8","ms":0,"msg":"route_success"}
{"level":30,"time":1755745577101,"pid":21,"hostname":"6d8b80affa0f","requestId":"5c458521-02ea-4c81-a6f7-6d7923a472e6","ms":0,"msg":"route_success"}
{"level":30,"time":1755745577552,"pid":21,"hostname":"6d8b80affa0f","requestId":"c915e9df-b2b0-489f-9af8-9b6005b96ce9","ms":1,"msg":"route_success"}
{"level":30,"time":1755745577552,"pid":21,"hostname":"6d8b80affa0f","requestId":"8df7829b-e1c5-4f46-b794-84592b62fff4","ms":0,"msg":"route_success"}
PASS tests/unit/api.admin.export.auth.spec.ts
PASS tests/unit/api.quizzes.list.total-count.spec.ts
{"level":30,"time":1755745577959,"pid":21,"hostname":"6d8b80affa0f","requestId":"4eaf4a1a-7c50-4068-9fbe-3723b69a0390","ms":0,"msg":"route_success"}
{"level":30,"time":1755745578277,"pid":21,"hostname":"6d8b80affa0f","requestId":"439d6b39-814d-4e82-85a6-8b9ea4af392b","ms":0,"msg":"route_success"}
PASS tests/unit/api.modules.list.total-count.spec.ts
PASS tests/unit/db.rls.registry.negative.spec.ts
{"level":30,"time":1755745578550,"pid":21,"hostname":"6d8b80affa0f","requestId":"6a8fbbc9-ca7b-4f90-87e4-561e686ac13a","ms":0,"msg":"route_success"}
{"level":30,"time":1755745578835,"pid":21,"hostname":"6d8b80affa0f","requestId":"e58fdceb-3365-445c-a68b-d8673c524f72","ms":1,"msg":"route_success"}
PASS tests/unit/api.admin.usage.shape.spec.ts
PASS tests/unit/gateways.messages.port-flag.spec.ts
PASS tests/unit/api.registry.versions.approve-disable.spec.ts
{"level":30,"time":1755745579382,"pid":21,"hostname":"6d8b80affa0f","requestId":"189b3c3b-f181-4f03-b46b-a7a8f975182a","ms":1,"msg":"route_success"}
PASS tests/unit/api.lessons.list.total-count.spec.ts
PASS tests/unit/api.admin.metrics.text.spec.ts
{"level":30,"time":1755745579902,"pid":21,"hostname":"6d8b80affa0f","requestId":"c5d23ce9-0e12-4066-86b7-25bf45504cc1","ms":1,"msg":"route_success"}
{"level":30,"time":1755745580253,"pid":21,"hostname":"6d8b80affa0f","requestId":"ap-eb","ms":1,"msg":"route_success"}
PASS tests/unit/api.assignments.patch-empty-body.spec.ts
FAIL tests/unit/env.validation.spec.ts
  ● environment validation › prod with TEST_MODE=1 throws unless explicitly allowed

    expect(received).toThrow(expected)

    Expected pattern: /TEST_MODE must not be enabled/

    Received function did not throw

      12 |   test('prod with TEST_MODE=1 throws unless explicitly allowed', () => {
      13 |     process.env = { ...original, NODE_ENV: 'production', TEST_MODE: '1' } as any;
    > 14 |     expect(() => loadServerEnv()).toThrow(/TEST_MODE must not be enabled/);
         |                                   ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/env.validation.spec.ts:14:35)

PASS tests/unit/api.admin.audit-logs.auth.spec.ts
{"level":30,"time":1755745580656,"pid":21,"hostname":"6d8b80affa0f","requestId":"b9aedec2-5d1d-44a4-96ce-e8f5fd950d48","ms":1,"msg":"route_success"}
{"level":30,"time":1755745580657,"pid":21,"hostname":"6d8b80affa0f","requestId":"6dc4c02e-2944-4e29-8fbc-25ae98df3d3a","ms":0,"msg":"route_success"}
PASS tests/unit/schemas.env.numeric-bounds.spec.ts
PASS tests/unit/lib.paginate.edgecases.spec.ts
PASS tests/unit/lib.zodQuery.spec.ts
PASS tests/unit/api.notifications.read-all.spec.ts
{"level":30,"time":1755745581361,"pid":21,"hostname":"6d8b80affa0f","requestId":"1c2cc670-ed3b-4967-943d-56850600e36a","ms":1,"msg":"route_success"}
{"level":30,"time":1755745581725,"pid":21,"hostname":"6d8b80affa0f","requestId":"8dbda840-b89e-4752-a34c-f299cc3fa725","ms":0,"msg":"route_success"}
PASS tests/unit/api.admin.dlq.admin.patch.spec.ts
PASS tests/unit/ui/SettingsPage.spec.tsx
PASS tests/unit/schemas.enrollment.spec.ts
PASS tests/unit/lib.rateLimit.spec.ts
PASS tests/unit/services.courses.spec.ts
PASS tests/unit/api.request-id.on.error.spec.ts
PASS tests/unit/lib.idempotency.ttl.spec.ts
{"level":30,"time":1755745582712,"pid":21,"hostname":"6d8b80affa0f","requestId":"4ad60701-e05c-4350-985a-0cba351574a3","ms":1,"msg":"route_success"}
{"level":30,"time":1755745583053,"pid":21,"hostname":"6d8b80affa0f","requestId":"5a4374ed-381a-4bce-a2ab-e03d4711d51c","ms":1,"msg":"route_success"}
PASS tests/unit/api.enrollments.list.total-count.spec.ts
PASS tests/unit/api.assignments.query-strict.spec.ts
{"level":30,"time":1755745583327,"pid":21,"hostname":"6d8b80affa0f","requestId":"bd52aa03-da32-4b43-be63-aa2764a0ac79","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.env.spec.ts
PASS tests/unit/api.notifications.list.total-count.spec.ts
PASS tests/unit/ui/TeacherCoursesGrid.spec.tsx
{"level":30,"time":1755745583899,"pid":21,"hostname":"6d8b80affa0f","requestId":"46c45138-f87d-49e4-b7b2-ce06d8327212","ms":1,"msg":"route_success"}
{"level":30,"time":1755745584582,"pid":21,"hostname":"6d8b80affa0f","requestId":"648a9e52-9824-4c52-a154-d137a0d89f1b","ms":1,"msg":"route_success"}
PASS tests/unit/api.request-id.on.success.spec.ts
PASS tests/unit/gateways/users.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/user/role 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

PASS tests/unit/schemas.problem.spec.ts
PASS tests/unit/db.rls.notifications.negative.spec.ts
{"level":30,"time":1755745585678,"pid":21,"hostname":"6d8b80affa0f","requestId":"2fe3931a-d45a-48ba-b6ad-aa0210b5a9c5","ms":0,"msg":"route_success"}
{"level":30,"time":1755745586089,"pid":21,"hostname":"6d8b80affa0f","requestId":"43aea85f-ac54-4015-a5ec-547805bb2ecd","ms":1,"msg":"route_success"}
{"level":30,"time":1755745586089,"pid":21,"hostname":"6d8b80affa0f","requestId":"dda42169-2062-46dd-bbf8-98383875b67f","ms":0,"msg":"route_success"}
PASS tests/unit/api.auth.logout.spec.ts
PASS tests/unit/ui/StudentEnrollmentsGrid.spec.tsx
PASS tests/unit/services.files.signing.spec.ts
PASS tests/unit/api.ready.payload.spec.ts
PASS tests/unit/db.rls.quiz-choices.negative.spec.ts
{"level":30,"time":1755745586825,"pid":21,"hostname":"6d8b80affa0f","requestId":"884a5efe-bdec-4a67-8162-fe52b2257b47","ms":1,"msg":"route_success"}
PASS tests/unit/gateways/flags.gateway.spec.ts
  ● Console

    console.debug
      [serverFetch] 200 /api/flags 0ms

      at serverFetch (../apps/web/src/lib/serverFetch.ts:90:13)

FAIL tests/unit/db.rls.quiz-questions.negative.spec.ts
  ● Quiz questions RLS/authorization negatives › student cannot create quiz question

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quiz-questions', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ quiz_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', text: 'T' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quiz-questions.negative.spec.ts:6:23)

{"level":30,"time":1755745587300,"pid":21,"hostname":"6d8b80affa0f","requestId":"88755c3b-cb32-4519-9d11-9e810977680f","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.notification.spec.ts
PASS tests/unit/gateways.registry.filters.spec.ts
PASS tests/unit/schemas.course.spec.ts
PASS tests/unit/db.rls.providers.negative.spec.ts
{"level":30,"time":1755745588524,"pid":21,"hostname":"6d8b80affa0f","requestId":"527859ec-a0c4-46c3-bf98-025a2dc09cdd","ms":0,"msg":"route_success"}
{"level":30,"time":1755745588964,"pid":21,"hostname":"6d8b80affa0f","requestId":"765d4ef0-20bc-4a7c-a87c-a2a26748c9fc","ms":1,"msg":"route_success"}
FAIL tests/unit/db.rls.lessons.negative.spec.ts
  ● Lessons RLS/authorization negatives › student cannot create lesson

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/lessons', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'L', content: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.lessons.negative.spec.ts:6:23)

PASS tests/unit/api.health.payload.spec.ts
PASS tests/unit/api.runtime.gating.spec.ts
{"level":30,"time":1755745589593,"pid":21,"hostname":"6d8b80affa0f","requestId":"ddfd4070-5e68-4171-9b48-b8e3dea50adc","ms":1,"msg":"route_success"}
{"level":30,"time":1755745589907,"pid":21,"hostname":"6d8b80affa0f","requestId":"627ad406-c7dd-46f6-99ec-e85ddebf4836","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.enrollments.negative.spec.ts
PASS tests/unit/schemas.quiz.extend.spec.ts
FAIL tests/unit/db.rls.modules.negative.spec.ts
  ● Modules RLS/authorization negatives › student cannot create module

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/modules', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'M' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.modules.negative.spec.ts:6:23)

{"level":30,"time":1755745590446,"pid":21,"hostname":"6d8b80affa0f","requestId":"034996e5-7116-4396-a38e-d69fb1ea1f49","ms":1,"msg":"route_success"}
{"level":30,"time":1755745590738,"pid":21,"hostname":"6d8b80affa0f","requestId":"735a91f1-6b99-442c-a983-34fc6ad6482a","ms":1,"msg":"route_success"}
FAIL tests/unit/db.rls.quizzes.negative.spec.ts
  ● Quizzes RLS/authorization negatives › student cannot create quiz

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quizzes', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'Q' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quizzes.negative.spec.ts:6:23)

PASS tests/unit/api.dashboard.dto.spec.ts
{"level":20,"time":1755745591000,"pid":21,"hostname":"6d8b80affa0f","ms":0,"msg":"dash_teacher_widgets"}
PASS tests/unit/ports.messaging.contract.spec.ts
PASS tests/unit/db.rls.messages.readall.negative.spec.ts
PASS tests/unit/ui/SystemHealth.spec.tsx
{"level":30,"time":1755745591400,"pid":21,"hostname":"6d8b80affa0f","requestId":"270e626c-6c02-4165-b860-6f25bfc87704","ms":1,"msg":"route_success"}
PASS tests/unit/lib.metrics.cardinality.spec.ts
PASS tests/unit/services.progress.spec.ts
{"level":30,"time":1755745591798,"pid":21,"hostname":"6d8b80affa0f","lessonId":"11111111-1111-1111-1111-111111111111","userId":"test-student-id","ms":0,"msg":"progress_marked"}
{"level":30,"time":1755745592063,"pid":21,"hostname":"6d8b80affa0f","requestId":"f98beb7d-d67f-4ce7-b0f4-de972c104670","ms":0,"msg":"route_success"}
PASS tests/unit/db.rls.files.finalize.negative.spec.ts
PASS tests/unit/api.parent.progress.ui.spec.tsx
PASS tests/unit/api.notifications.read-all.auth.spec.ts
PASS tests/unit/lib.csp.headers.spec.ts
{"level":30,"time":1755745592660,"pid":21,"hostname":"6d8b80affa0f","requestId":"dbeddc77-3964-4357-8e68-532ff554ddd8","ms":1,"msg":"route_success"}
PASS tests/unit/runtime.headers.vary.origin.spec.ts
PASS tests/unit/api.admin.usage.auth.spec.ts
PASS tests/unit/api.runtime.checkpoint.spec.ts
{"level":30,"time":1755745593309,"pid":21,"hostname":"6d8b80affa0f","requestId":"24ec7cce-4024-411f-8b56-da908526bb79","ms":0,"msg":"route_success"}
PASS tests/unit/api.runtime.jwks.rotation.positive.spec.ts
PASS tests/unit/db.rls.interactive_attempts.negative.spec.ts
{"level":30,"time":1755745593673,"pid":21,"hostname":"6d8b80affa0f","requestId":"1717d113-8a25-474f-8a4a-7a68f3ea2a29","ms":0,"msg":"route_success"}
PASS tests/unit/services.users.spec.ts
PASS tests/unit/db.rls.reports.negative.spec.ts
{"level":30,"time":1755745594562,"pid":21,"hostname":"6d8b80affa0f","requestId":"d2da0b73-2c58-4572-80cc-dabdfc3203c3","ms":1,"msg":"route_success"}
PASS tests/unit/schemas.dashboard.parent.spec.ts
PASS tests/unit/future.analytics.spec.ts
PASS tests/unit/future.access-control.spec.ts
PASS tests/unit/schemas.assignment.extend.spec.ts
PASS tests/unit/api.runtime.asset-sign-url.spec.ts
PASS tests/unit/future.profile-avatar.spec.ts
PASS tests/unit/example.spec.ts
PASS tests/unit/api.events.spec.ts

Summary of all failing tests
FAIL unit/future.messaging.spec.ts
  ● Epic E: Messaging (MVP) › lists only threads for the current user with unread counts

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      32 |     const rows = await res.json();
      33 |     expect(Array.isArray(rows)).toBe(true);
    > 34 |     expect(rows.every((r: any) => typeof r.unread === 'number')).toBe(true);
         |                                                                  ^
      35 |   });
      36 |
      37 |   test('sends a message into a thread and fans out notifications to participants', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:34:66)

  ● Epic E: Messaging (MVP) › marks message as read for the current user and updates unread badge

    TypeError: Cannot read properties of undefined (reading 'unread')

      78 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      79 |     const list = await listRes.json();
    > 80 |     expect(list[0].unread).toBe(0);
         |                    ^
      81 |   });
      82 |   test('enforces permissions: unauthenticated yields 401', async () => {
      83 |     // clear test auth

      at Object.<anonymous> (unit/future.messaging.spec.ts:80:20)

  ● Epic E: Messaging (MVP) › PATCH /api/messages/threads/[id]/read-all zeroes unread for current user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      107 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      108 |     const patch = await readAll.PATCH(new Request(`http://localhost/api/messages/threads/${thread.id}/read-all`, { method: 'PATCH', headers: { 'x-test-auth': 'student' } }) as any, { params: { id: thread.id } } as any);
    > 109 |     expect(patch.status).toBe(200);
          |                          ^
      110 |     const listRes = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      111 |     const list = await listRes.json();
      112 |     expect(list[0].unread).toBe(0);

      at Object.<anonymous> (unit/future.messaging.spec.ts:109:26)

  ● Epic E: Messaging (MVP) › messages list sorted by created_at and unread increments after new message

    TypeError: Cannot read properties of undefined (reading 'unread')

      138 |     const listThreads = await threads.GET(new Request('http://localhost/api/messages/threads', { headers: { 'x-test-auth': 'student' } }) as any);
      139 |     const ts = await listThreads.json();
    > 140 |     expect(ts[0].unread).toBeGreaterThan(0);
          |                  ^
      141 |   });
      142 |
      143 |   test('PATCH /api/messages without id returns 400 and unknown id returns 404', async () => {

      at Object.<anonymous> (unit/future.messaging.spec.ts:140:18)

FAIL unit/api.runtime.v2.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.v2.spec.ts:3:1)

FAIL unit/api.flags.providers.users.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.flags.providers.users.spec.ts:6:1)

FAIL unit/api.registry.mutations.ratelimit.spec.ts
  ● registry mutations rate-limit headers › courses POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      106 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      107 |   const supabase = getRouteHandlerSupabase();
    > 108 |   const { data, error } = await supabase.from("external_courses").insert(parsed.data as any).select().single();
          |                                                                   ^
      109 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      110 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.create', entity_type: 'external_course', entity_id: (data as any).id, details: parsed.data }); } catch {}
      111 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/courses/route.ts:108:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:16:17)

  ● registry mutations rate-limit headers › courses PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from("external_courses").update(parsed.data.data as any).eq("id", parsed.data.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      142 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.update', entity_type: 'external_course', entity_id: parsed.data.id, details: parsed.data.data }); } catch {}
      143 |   try { return jsonDto(externalCourse.parse(data as any), externalCourse as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid external course shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/courses/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:25:17)

  ● registry mutations rate-limit headers › courses DELETE returns 429 headers when limited

    TypeError: supabase.from(...).delete is not a function

      167 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      168 |   const supabase = getRouteHandlerSupabase();
    > 169 |   const { data, error } = await supabase.from("external_courses").delete().eq("id", q.id).select().single();
          |                                                                         ^
      170 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      171 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.external.delete', entity_type: 'external_course', entity_id: q.id, details: {} }); } catch {}
      172 |   const { jsonDto } = await import('@/lib/jsonDto');

      at DELETE (../apps/web/src/app/api/registry/courses/route.ts:169:73)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:34:17)

  ● registry mutations rate-limit headers › versions POST returns 429 headers when limited

    TypeError: supabase.from(...).insert is not a function

      77 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      78 |   const supabase = getRouteHandlerSupabase();
    > 79 |   const { data, error } = await supabase.from("course_versions").insert(parsed.data as any).select().single();
         |                                                                  ^
      80 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      81 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.create', entity_type: 'course_version', entity_id: (data as any).id, details: parsed.data }); } catch {}
      82 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 201 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at POST (../apps/web/src/app/api/registry/versions/route.ts:79:66)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:43:17)

  ● registry mutations rate-limit headers › versions PATCH returns 429 headers when limited

    TypeError: supabase.from(...).update is not a function

      108 |   if (!parsed.success) return NextResponse.json({ error: { code: "BAD_REQUEST", message: parsed.error.message }, requestId }, { status: 400, headers: { "x-request-id": requestId } });
      109 |   const supabase = getRouteHandlerSupabase();
    > 110 |   const { data, error } = await supabase.from("course_versions").update(parsed.data as any).eq("id", q.id).select().single();
          |                                                                  ^
      111 |   if (error) return NextResponse.json({ error: { code: "DB_ERROR", message: error.message }, requestId }, { status: 500, headers: { "x-request-id": requestId } });
      112 |   try { await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'registry.version.update', entity_type: 'course_version', entity_id: q.id, details: parsed.data }); } catch {}
      113 |   try { return jsonDto(courseVersion.parse(data as any), courseVersion as any, { requestId, status: 200 }); } catch { return NextResponse.json({ error: { code: 'INTERNAL', message: 'Invalid course version shape' }, requestId }, { status: 500, headers: { 'x-request-id': requestId } }); }

      at PATCH (../apps/web/src/app/api/registry/versions/route.ts:110:66)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.registry.mutations.ratelimit.spec.ts:52:17)

FAIL unit/api.runtime.auth.exchange.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.auth.exchange.spec.ts:2:1)

FAIL unit/api.runtime.asset.sign-url.scope.spec.ts
  ● runtime asset sign-url scopes (smoke) › missing scope → 403/401

    TypeError: Failed to parse URL from [object Object]

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

    Cause:
    TypeError: Invalid URL

      32 |
      33 | function post(url: string, body: any, headers?: Record<string,string>) {
    > 34 |   return new Request(url, { method: 'POST', headers: { 'content-type': 'application/json', origin: 'https://provider.example', referer: 'https://provider.example/x', ...(headers||{}) } as any, body: JSON.stringify(body) } as any);
         |          ^
      35 | }
      36 |
      37 | describe('runtime asset sign-url scope', () => {

      at post (unit/api.runtime.asset.sign-url.scope.spec.ts:34:10)
      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:13:44)

  ● runtime asset sign-url scope › valid scope and content-type → 200 with url/key

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200]

      49 |     const token = makeJwt(['files.write']);
      50 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'image/png' }, { authorization: `Bearer ${token}` }));
    > 51 |     expect([200]).toContain(res.status);
         |                   ^
      52 |     const json = await res.json();
      53 |     expect(json.url).toBeTruthy();
      54 |     expect(json.key).toMatch(/runtime\//);

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:51:19)

  ● runtime asset sign-url scope › unsupported content type → 400

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      58 |     const token = makeJwt(['files.write']);
      59 |     const res = await (AssetSignPOST as any)(post('http://localhost/api/runtime/asset/sign-url', { content_type: 'application/x-foo' }, { authorization: `Bearer ${token}` }));
    > 60 |     expect(res.status).toBe(400);
         |                        ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/api.runtime.asset.sign-url.scope.spec.ts:60:24)

FAIL unit/api.parent-links.spec.ts
  ● API /api/parent-links › GET unauth → 401; missing parent_id → 400; non-admin self allowed; non-self forbidden

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 204]

      58 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      59 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=test-parent-id'));
    > 60 |     expect([200, 204]).toContain(res.status);
         |                        ^
      61 |     // parent non-self forbidden
      62 |     res = await (PLGet as any)(makeGet('http://localhost/api/parent-links?parent_id=other-parent-id'));
      63 |     expect(res.status).toBe(403);

      at Object.<anonymous> (unit/api.parent-links.spec.ts:60:24)

FAIL unit/api.runtime.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.spec.ts:5:1)

FAIL unit/lib.serverFetch.spec.ts
  ● serverFetch utils › serverFetch builds absolute URL and propagates headers when given path

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://localhost:3333/api/ping"
    Received: "/api/ping"

      33 |       (process.env as any).PORT = '3333';
      34 |       await serverFetch('/api/ping', { headers: { 'x-request-id': 'in' } });
    > 35 |       expect(calls[0].url).toBe('http://localhost:3333/api/ping');
         |                            ^
      36 |       expect((calls[0].init.headers as Headers).get('x-request-id')).toBe('in');
      37 |     } finally {
      38 |       global.fetch = old;

      at Object.<anonymous> (unit/lib.serverFetch.spec.ts:35:28)

FAIL unit/api.runtime.outcomes.jwks.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.spec.ts:2:1)

FAIL unit/api.submissions.rate-limit.spec.ts
  ● submissions rate limits and headers › POST student create returns 429 with standard headers when limited

    TypeError: Failed to parse URL from [object Object]

       5 | }), { virtual: true });
       6 |
    >  7 | function post(url: string, headers?: Record<string,string>, body?: any) { return new Request(url, { method: 'POST', headers: headers as any, body: JSON.stringify(body || {}) } as any); }
         |                                                                                  ^
       8 |
       9 | describe('submissions POST rate limit headers', () => {
      10 |   const orig = { ...process.env } as any;

      at post (unit/api.submissions.rate-limit.spec.ts:7:82)
      at Object.<anonymous> (unit/api.submissions.rate-limit.spec.ts:42:48)

    Cause:
    TypeError: Invalid URL

       5 | }), { virtual: true });
       6 |
    >  7 | function post(url: string, headers?: Record<string,string>, body?: any) { return new Request(url, { method: 'POST', headers: headers as any, body: JSON.stringify(body || {}) } as any); }
         |                                                                                  ^
       8 |
       9 | describe('submissions POST rate limit headers', () => {
      10 |   const orig = { ...process.env } as any;

      at post (unit/api.submissions.rate-limit.spec.ts:7:82)
      at Object.<anonymous> (unit/api.submissions.rate-limit.spec.ts:42:48)

FAIL unit/future.files.spec.ts
  ● Epic H: Files and Media › issues an upload URL for a given owner and content type

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       6 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
       7 |     const res = await mod.POST(new Request('http://localhost/api/files/upload-url', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'teacher' }, body: JSON.stringify({ owner_type: 'assignment', owner_id: 'a1', content_type: 'text/plain' }) }) as any);
    >  8 |     expect(res.status).toBe(200);
         |                        ^
       9 |     const json = await res.json();
      10 |     expect(json.url).toContain('/api/files/upload-url');
      11 |   });

      at Object.<anonymous> (unit/future.files.spec.ts:8:24)

  ● Epic H: Files and Media › accepts PUT upload and returns a public download URL, then serves bytes

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      17 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'teacher');
      18 |     const res = await mod.PUT(new Request('http://localhost/api/files/upload-url?owner_type=assignment&owner_id=a1&content_type=text/plain', { method: 'PUT', headers: { 'x-test-auth': 'teacher' }, body: new TextEncoder().encode('hello') }) as any);
    > 19 |     expect(res.status).toBe(200);
         |                        ^
      20 |     const { id, url } = await res.json();
      21 |     expect(id).toBeTruthy();
      22 |     const dl = await import('../../apps/web/src/app/api/files/download-url/route');

      at Object.<anonymous> (unit/future.files.spec.ts:19:24)

FAIL unit/api.runtime.checkpoint.scopes.spec.ts
  ● runtime checkpoint scopes › save requires progress.write; load requires progress.read

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      35 |     token = makeJwt(['progress.write']);
      36 |     res = await (SavePOST as any)(post('http://localhost/api/runtime/checkpoint/save', { key: 'k', state: { a: 1 } }, { authorization: `Bearer ${token}` }));
    > 37 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      38 |     // Load without scope -> 403
      39 |     token = makeJwt([]);
      40 |     res = await (LoadGET as any)(get('http://localhost/api/runtime/checkpoint/load?key=k', { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.checkpoint.scopes.spec.ts:37:27)

FAIL unit/api.messages.threads-and-messages.spec.ts
  ● messages threads and messages (TEST_MODE) › thread create has unique participants; unread counts adjust with read

    expect(received).toContain(expected) // indexOf

    Expected value: undefined
    Received array: [0, 1]

      30 |     const teacherThreads = await listTeacherThreads.json();
      31 |     const tRow = teacherThreads.find((x: any) => x.id === thread.id);
    > 32 |     expect([0,1]).toContain(tRow.unread);
         |                   ^
      33 |
      34 |     // mark student's message read as teacher
      35 |     const msgsList = await (MessagesGET as any)(getUrl(`http://localhost/api/messages?thread_id=${thread.id}`, { 'x-test-auth': 'teacher' }));

      at Object.<anonymous> (unit/api.messages.threads-and-messages.spec.ts:32:19)

FAIL unit/api.admin.governance.smoke.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.governance.smoke.spec.ts:1:1)

FAIL unit/api.runtime.events.scopes.spec.ts
  ● runtime events scopes › course.progress requires progress.write; course.attempt.completed requires attempts.write

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      31 |     token = makeJwt(['progress.write']);
      32 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 33 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      34 |     // Missing attempts.write for attempt.completed -> 403
      35 |     token = makeJwt([]);
      36 |     res = await (EventsPOST as any)(post('http://localhost/api/runtime/events', { type: 'course.attempt.completed', score: 1, max: 1, passed: true }, { authorization: `Bearer ${token}` }));

      at Object.<anonymous> (unit/api.runtime.events.scopes.spec.ts:33:27)

FAIL unit/api.files.download-url.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.permissions.spec.ts:2:1)

FAIL unit/security.csrf.double-submit.spec.ts
  ● CSRF double-submit enforcement (wrapper-level) › messages POST with matching token allowed through wrapper (may still 401/429 deeper)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 401, 403, 429, 500]

      31 |     const headers: HeadersMap = { 'x-test-auth': 'student', 'content-type': 'application/json', 'x-csrf-token': 'abc', cookie: 'csrf_token=abc' };
      32 |     const res = await (MessagesPOST as any)(req('http://localhost/api/messages', { method: 'POST', headers, body: JSON.stringify({ thread_id: 't1', body: 'hi' }) }));
    > 33 |     expect([201,401,403,429,500]).toContain(res.status);
         |                                   ^
      34 |   });
      35 |
      36 |   test('assignments PATCH without token rejected when enabled', async () => {

      at Object.<anonymous> (unit/security.csrf.double-submit.spec.ts:33:35)

FAIL unit/api.assignments.crud.spec.ts
  ● Assignments CRUD API › DELETE role checks

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      43 |     expect(res.status).toBe(403);
      44 |     res = await (AssignDELETE as any)(makeDelete('http://localhost/api/assignments?id=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', { 'x-test-auth': 'teacher' }));
    > 45 |     expect(res.status).toBe(200);
         |                        ^
      46 |   });
      47 | });
      48 |

      at Object.<anonymous> (unit/api.assignments.crud.spec.ts:45:24)

FAIL unit/api.role.guard.matrix.extended.spec.ts (6.291 s)
  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/audit-logs',
  url: 'http://localhost/api/admin/audit-logs',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/export',
  url: 'http://localhost/api/admin/export',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/metrics',
  url: 'http://localhost/api/admin/metrics',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'admin/quotas',
  url: 'http://localhost/api/admin/quotas',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'users',
  url: 'http://localhost/api/users',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'providers/health',
  url: 'http://localhost/api/providers/health',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'student'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'teacher'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'parent'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

  ● admin/registry/users role guard matrix › {
  name: 'registry/courses',
  url: 'http://localhost/api/registry/courses',
  handler: [AsyncFunction (anonymous)],
  role: 'admin'
} as %s

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.role.guard.matrix.extended.spec.ts:28:46
      at unit/api.role.guard.matrix.extended.spec.ts:28:46

FAIL unit/api.providers.ratelimit.spec.ts
  ● providers create/update/delete rate-limit headers › POST returns 429 with standard headers when limited

    TypeError: supabase.from(...).insert is not a function

      69 |   }
      70 |   const supabase = getRouteHandlerSupabase();
    > 71 |   const { data, error } = await supabase.from('course_providers').insert({ name, jwks_url, domain }).select().single();
         |                                                                   ^
      72 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      73 |   try {
      74 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.create', entity_type: 'provider', entity_id: (data as any).id, details: { name, domain } });

      at POST (../apps/web/src/app/api/providers/route.ts:71:67)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:17:17)

  ● providers create/update/delete rate-limit headers › PATCH returns 429 with standard headers when limited

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:27:17)

  ● providers create/update/delete rate-limit headers › DELETE returns 429 with standard headers when limited

    TypeError: supabase.from(...).delete is not a function

      174 |   try { q = parseQuery(req, idSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      175 |   const supabase = getRouteHandlerSupabase();
    > 176 |   const { error } = await supabase.from('course_providers').delete().eq('id', q.id);
          |                                                                   ^
      177 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      178 |   try {
      179 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.delete', entity_type: 'provider', entity_id: q.id, details: {} });

      at DELETE (../apps/web/src/app/api/providers/route.ts:176:67)
      at Object.DELETE (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.ratelimit.spec.ts:36:17)

FAIL unit/api.runtime.checkpoint.size-limit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.checkpoint.size-limit.spec.ts:1:1)

FAIL unit/api.admin.export.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.export.spec.ts:3:1)

FAIL unit/api.runtime.outcomes.runtime-token.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.runtime-token.spec.ts:2:1)

FAIL unit/middleware.cors.disallowed-origin.spec.ts
  ● middleware CSP connect-src allowlist propagation › includes origins from RUNTIME_CORS_ALLOW in CSP via guard path

    expect(received).toMatch(expected)

    Expected pattern: /connect-src [^;]*https:\/\/api\.provider1/
    Received string:  ""

      33 |     const res: any = await (middleware as any)(makeReq('http://localhost/api/health'));
      34 |     const csp = res.headers.get('Content-Security-Policy') || '';
    > 35 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider1/);
         |                 ^
      36 |     expect(csp).toMatch(/connect-src [^;]*https:\/\/api\.provider2/);
      37 |   });
      38 | });

      at Object.<anonymous> (unit/middleware.cors.disallowed-origin.spec.ts:35:17)

FAIL unit/server.scheduler.flags.spec.ts
  ● scheduler ensureJobsStarted flags › DUE_SOON_JOB=1 schedules due-soon job

    expect(received).toContain(expected) // indexOf

    Expected value: "assignment_due_soon"
    Received array: []

      26 |     mod.ensureJobsStarted();
      27 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 28 |     expect(calls).toContain('assignment_due_soon');
         |                   ^
      29 |   });
      30 |
      31 |   test('PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:28:19)

  ● scheduler ensureJobsStarted flags › PROVIDER_HEALTH_REFRESH_JOB=1 schedules provider health refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "provider_health_refresh"
    Received array: []

      34 |     mod.ensureJobsStarted();
      35 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 36 |     expect(calls).toContain('provider_health_refresh');
         |                   ^
      37 |   });
      38 |
      39 |   test('REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:36:19)

  ● scheduler ensureJobsStarted flags › REFRESH_PROGRESS_SUMMARY_JOB=1 schedules progress mv refresh

    expect(received).toContain(expected) // indexOf

    Expected value: "refresh_progress_summary"
    Received array: []

      42 |     mod.ensureJobsStarted();
      43 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 44 |     expect(calls).toContain('refresh_progress_summary');
         |                   ^
      45 |   });
      46 |
      47 |   test('QUOTA_RECONCILE_JOB=1 schedules quota reconcile', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:44:19)

  ● scheduler ensureJobsStarted flags › QUOTA_RECONCILE_JOB=1 schedules quota reconcile

    expect(received).toContain(expected) // indexOf

    Expected value: "quota_reconcile"
    Received array: []

      50 |     mod.ensureJobsStarted();
      51 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 52 |     expect(calls).toContain('quota_reconcile');
         |                   ^
      53 |   });
      54 |
      55 |   test('BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill', async () => {

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:52:19)

  ● scheduler ensureJobsStarted flags › BACKFILL_ATTACHMENT_SIZES_JOB=1 schedules backfill

    expect(received).toContain(expected) // indexOf

    Expected value: "attachment_size_backfill"
    Received array: []

      58 |     mod.ensureJobsStarted();
      59 |     const calls = (scheduleJob as jest.Mock).mock.calls.map((c: any[]) => c[0]);
    > 60 |     expect(calls).toContain('attachment_size_backfill');
         |                   ^
      61 |   });
      62 | });
      63 |

      at Object.<anonymous> (unit/server.scheduler.flags.spec.ts:60:19)

FAIL unit/api.files.attachments.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.attachments.spec.ts:3:1)

FAIL unit/api.launch-token.license.enforcement.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.launch-token.license.enforcement.spec.ts:1:1)

FAIL unit/lib.serverFetch.csrf-header.spec.ts
  ● serverFetch forwards x-csrf-token when cookie present › adds x-csrf-token header for unsafe method

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc123"
    Received: "cookie-csrf"

      45 |     await serverFetch('/api/messages', { method: 'POST' });
      46 |     const h = calls[0].init.headers as Headers;
    > 47 |     expect(h.get('x-csrf-token')).toBe('abc123');
         |                                   ^
      48 |   });
      49 | });
      50 |

      at Object.<anonymous> (unit/lib.serverFetch.csrf-header.spec.ts:47:35)

FAIL unit/api.runtime.grade.ratelimit.spec.ts
  ● runtime grade rate-limit headers › returns 201 first, then 429 with standard headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      25 |     const h = { authorization: `Bearer ${token}` };
      26 |     let res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true }, h));
    > 27 |     expect([200,201]).toContain(res.status);
         |                       ^
      28 |     res = await (GradePOST as any)(post({ runtimeAttemptId: 'ra2', score: 1, max: 1, passed: true }, h));
      29 |     expect(res.status).toBe(429);
      30 |     expect(res.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.runtime.grade.ratelimit.spec.ts:27:23)

FAIL unit/api.courses.transfer-owner.auth.spec.ts
  ● courses transfer-owner auth and rate limit › student -> 403

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:15:17)

  ● courses transfer-owner auth and rate limit › rate limit includes standard headers when exceeded

    TypeError: supabase.from(...).update is not a function

      45 |   const { data, error } = await supabase
      46 |     .from('courses')
    > 47 |     .update({ teacher_id: newOwnerId })
         |      ^
      48 |     .eq('id', params.id)
      49 |     .select('id,teacher_id')
      50 |     .single();

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:47:6)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.auth.spec.ts:23:5)

FAIL unit/api.admin.audit-logs.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.admin.audit-logs.spec.ts:3:1)

FAIL unit/api.providers.dto-and-ratelimit.spec.ts
  ● providers endpoints DTO + ratelimit headers › rate limit headers present when throttled on provider PATCH

    TypeError: supabase.from(...).update is not a function

      138 |   if (Object.keys(patch).length === 0) return NextResponse.json({ error: { code: 'BAD_REQUEST', message: 'no fields to update' }, requestId }, { status: 400, headers: { 'x-request-id': requestId } });
      139 |   const supabase = getRouteHandlerSupabase();
    > 140 |   const { data, error } = await supabase.from('course_providers').update(patch).eq('id', q.id).select().single();
          |                                                                   ^
      141 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      142 |   try {
      143 |     await supabase.from('audit_logs').insert({ actor_id: user.id, action: 'provider.update', entity_type: 'provider', entity_id: q.id, details: patch });

      at PATCH (../apps/web/src/app/api/providers/route.ts:140:67)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.dto-and-ratelimit.spec.ts:23:16)

FAIL unit/api.runtime.events.ratelimit.spec.ts
  ● runtime events rate-limit headers › returns 429 with standard headers on rate limit

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 403

      30 |     const token = makeJwt(['progress.write']);
      31 |     const res = await (EventsPOST as any)(post({ type: 'course.progress', pct: 10 }, { authorization: `Bearer ${token}` }));
    > 32 |     expect(res.status).toBe(429);
         |                        ^
      33 |     expect(res.headers.get('retry-after')).toBeTruthy();
      34 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      35 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.runtime.events.ratelimit.spec.ts:32:24)

FAIL unit/lib.serverFetch.headers.spec.ts
  ● serverFetch headers and fetchJson › propagates x-request-id and x-test-auth and builds absolute URL

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      22 |   test('propagates x-request-id and x-test-auth and builds absolute URL', async () => {
      23 |     await serverFetch('/api/health');
    > 24 |     expect(fetchSpy).toHaveBeenCalledTimes(1);
         |                      ^
      25 |     const [url, init] = fetchSpy.mock.calls[0];
      26 |     expect(String(url)).toBe('http://localhost:3030/api/health');
      27 |     const hdrs = new Headers(init.headers);

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:24:22)

  ● serverFetch headers and fetchJson › does not attach x-csrf-token on GET even when cookie present

    TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))

      35 |     store.cookies.set('csrf_token', 'tok');
      36 |     await serverFetch('/api/health', { method: 'GET' });
    > 37 |     const [, init] = fetchSpy.mock.calls[0];
         |                      ^
      38 |     const hdrs = new Headers(init.headers);
      39 |     expect(hdrs.get('x-csrf-token')).toBeNull();
      40 |   });

      at Object.<anonymous> (unit/lib.serverFetch.headers.spec.ts:37:22)

FAIL unit/api.files.roundtrip.spec.ts
  ● files round-trip › upload-url → PUT bytes → download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      24 |     const blob = new Blob([new TextEncoder().encode('hello')], { type: 'text/plain' });
      25 |     const put = await (UploadPUT as any)(makePut(`http://localhost${url}`, blob, { 'x-test-auth': 'student' }));
    > 26 |     expect(put.status).toBe(200);
         |                        ^
      27 |     const { id, url: publicUrl } = await put.json();
      28 |     expect(id).toBeTruthy();
      29 |     const dl = await (DownloadGET as any)(makeGet(`http://localhost/api/files/download-url?id=${encodeURIComponent(id)}`, { 'x-test-auth': 'student' }));

      at Object.<anonymous> (unit/api.files.roundtrip.spec.ts:26:24)

FAIL unit/api.runtime.idempotency.spec.ts
  ● runtime progress idempotency › duplicate request with same Idempotency-Key is replayed 200 with header

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204]

      25 |     const h = { authorization: `Bearer ${token}`, 'Idempotency-Key': 'dup-1' } as Record<string,string>;
      26 |     let res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
    > 27 |     expect([200,201,204]).toContain(res.status);
         |                           ^
      28 |     res = await (ProgressPOST as any)(post('http://localhost/api/runtime/progress', h));
      29 |     expect([200]).toContain(res.status);
      30 |     expect(res.headers.get('idempotency-replayed')).toBe('1');

      at Object.<anonymous> (unit/api.runtime.idempotency.spec.ts:27:27)

FAIL unit/middleware.env-assertions.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/middleware.env-assertions.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 |
      3 | describe('middleware production env assertions and CSRF cookie', () => {
      4 |   const orig = { ...process.env } as any;

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/middleware.env-assertions.spec.ts:1:1)

FAIL unit/api.runtime.cors.headers.spec.ts
  ● runtime CORS headers for allowed origin › includes access-control-allow-origin when origin is allowed

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201, 204, 400]

      25 |     const res = await (ProgressPOST as any)(post({ authorization: `Bearer ${token}` }));
      26 |     // success or preflight OK
    > 27 |     expect([200,201,204,400]).toContain(res.status);
         |                               ^
      28 |     // @ts-ignore NextResponse-like headers
      29 |     const h = res.headers as Headers;
      30 |     expect(h.get('access-control-allow-origin')).toBe('https://provider.example');

      at Object.<anonymous> (unit/api.runtime.cors.headers.spec.ts:27:31)

FAIL unit/api.assignments.target.upsert.spec.ts
  ● assignments target upsert (EXTERNAL_COURSES=1) › POST upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 500]

      15 |     const body = { course_id: '00000000-0000-0000-0000-000000000001', title: 'A', target: { source: 'v2', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      16 |     const res = await (AssignPOST as any)(req('POST', 'http://localhost/api/assignments', body));
    > 17 |     expect([201, 500]).toContain(res.status); // 201 success; 500 if DTO mismatch in test harness
         |                        ^
      18 |   });
      19 |
      20 |   test('PATCH upserts assignment_targets when target provided', async () => {

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:17:24)

  ● assignments target upsert (EXTERNAL_COURSES=1) › PATCH upserts assignment_targets when target provided

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      23 |     const body = { title: 'B', target: { source: 'v1', external_course_id: '11111111-1111-1111-1111-111111111111', version_id: '22222222-2222-2222-2222-222222222222' } } as any;
      24 |     const res = await (AssignPATCH as any)(req('PATCH', 'http://localhost/api/assignments?id=00000000-0000-0000-0000-000000000001', body));
    > 25 |     expect([200, 500]).toContain(res.status);
         |                        ^
      26 |   });
      27 | });
      28 |

      at Object.<anonymous> (unit/api.assignments.target.upsert.spec.ts:25:24)

FAIL unit/db.rls.negative.spec.ts
  ● DB RLS negative cases (policy guards) › student cannot read other students notifications

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/db.rls.negative.spec.ts:5:18
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:5:18)

  ● DB RLS negative cases (policy guards) › non-owner cannot finalize someone else file (RLS and route guard)

    TypeError: supabase.from(...).select(...).eq is not a function

      14 |   try { body = finalizeSchema.parse(await req.json()); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: String(e?.message || e) }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      15 |   const supabase = getRouteHandlerSupabase();
    > 16 |   const { data: att } = await supabase.from('attachments').select('id,owner_type,owner_id,size_bytes').eq('object_key', body.key).single();
         |                                                                                                        ^
      17 |   if (!att) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      18 |   // Permission: owner or teacher/admin for domain types (reuse delete semantics where possible)
      19 |   const ownerType = (att as any).owner_type as string;

      at POST (../apps/web/src/app/api/files/finalize/route.ts:16:104)
      at Object.POST (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/db.rls.negative.spec.ts:24:17)

  ● DB RLS negative cases (policy guards) › student cannot list submissions for other assignment without auth as teacher

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [401, 403]

      29 |     const route = await import('../../apps/web/src/app/api/submissions/route');
      30 |     const res = await route.GET(new Request('http://localhost/api/submissions?assignment_id=00000000-0000-0000-0000-000000000999', { headers: { 'x-test-auth': 'student' } } as any) as any);
    > 31 |     expect([401,403]).toContain(res.status);
         |                       ^
      32 |   });
      33 | });
      34 |

      at Object.<anonymous> (unit/db.rls.negative.spec.ts:31:23)

FAIL unit/middleware.security-headers.more.spec.ts
  ● middleware additional security headers › sets Referrer-Policy, X-Content-Type-Options, COOP, CORP, Permissions-Policy

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:25:29)

  ● middleware additional security headers › sets HSTS only in production

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.more.spec.ts:36:32)

FAIL unit/api.runtime.outcomes.rate-limit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.outcomes.rate-limit.spec.ts:2:1)

FAIL unit/api.enrollments.spec.ts
  ● API /api/enrollments › POST unauth → 401; non-student → 403; student → 201 with own student_id

    expect(received).toBe(expected) // Object.is equality

    Expected: "test-student-id"
    Received: "22222222-2222-2222-2222-222222222222"

      28 | 		expect(res.status).toBe(201);
      29 | 		const json = await res.json();
    > 30 | 		expect(json.student_id).toBe('test-student-id');
         | 		                        ^
      31 | 	});
      32 |
      33 | 	test('GET unauth → 401; echoes x-request-id', async () => {

      at Object.<anonymous> (unit/api.enrollments.spec.ts:30:27)

FAIL unit/api.providers.health.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.health.spec.ts:2:1)

FAIL unit/api.notifications.rate-limit.spec.ts
  ● notifications rate-limit headers › GET list returns 429 with standard headers when limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 200

      18 |   test('GET list returns 429 with standard headers when limited', async () => {
      19 |     const res = await (NotifGET as any)(get('http://localhost/api/notifications'));
    > 20 |     expect(res.status).toBe(429);
         |                        ^
      21 |     expect(res.headers.get('retry-after')).toBeTruthy();
      22 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();

      at Object.<anonymous> (unit/api.notifications.rate-limit.spec.ts:20:24)

FAIL unit/api.assignments.post.csrf.spec.ts
  ● assignments POST CSRF double-submit › 403 missing/mismatched tokens; 201 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [200, 201]

      26 |     // Match
      27 |     res = await (AssignmentsPOST as any)(post(payload, { origin: 'http://localhost', referer: 'http://localhost/x', cookie: 'csrf_token=t', 'x-csrf-token': 't' }));
    > 28 |     expect([200,201]).toContain(res.status);
         |                       ^
      29 |   });
      30 | });
      31 |

      at Object.<anonymous> (unit/api.assignments.post.csrf.spec.ts:28:23)

FAIL unit/api.quizzes.ratelimit.spec.ts
  ● quizzes rate-limit headers on PATCH/DELETE › PATCH returns 429 with standard headers when limited

    ZodError: [
      {
        "code": "too_small",
        "minimum": 3,
        "type": "string",
        "inclusive": true,
        "exact": false,
        "message": "String must contain at least 3 character(s)",
        "path": [
          "title"
        ]
      }
    ]

      93 |   } catch {}
      94 |   const body = await req.json();
    > 95 |   const parsed = quizUpdateRequest.parse(body);
         |                                    ^
      96 |   const out = await updateQuizApi(q.id, parsed);
      97 |   try {
      98 |     const dto = quizDto.parse(out);

      at Object.get error [as error] (../node_modules/zod/v3/types.cjs:45:31)
      at ZodEffects.parse (../node_modules/zod/v3/types.cjs:120:22)
      at PATCH (../apps/web/src/app/api/quizzes/route.ts:95:36)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.quizzes.ratelimit.spec.ts:15:17)

FAIL unit/future.observability.logs.spec.ts
  ● observability logs (services) › dash_teacher_widgets and dash_student_widgets include ms

    TypeError: Cannot set properties of undefined (setting 'length')

      23 |   test('dash_teacher_widgets and dash_student_widgets include ms', async () => {
      24 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 25 |     logs.length = 0;
         |                ^
      26 |     await dashboardSvc.getDashboardForUser('test-teacher-id', 'teacher');
      27 |     await dashboardSvc.getDashboardForUser('test-student-id', 'student');
      28 |     expect(logs.some(l => l.msg === 'dash_teacher_widgets' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:25:16)

  ● observability logs (services) › progress_marked counter emitted on completion

    TypeError: Cannot set properties of undefined (setting 'length')

      32 |   test('progress_marked counter emitted on completion', async () => {
      33 |     const logs: any[] = (loggerMod as any).__TEST_LOGS__;
    > 34 |     logs.length = 0;
         |                ^
      35 |     const out = await progressSvc.markLessonComplete('u1', '00000000-0000-0000-0000-000000000001');
      36 |     expect(out.lessonId).toBeTruthy();
      37 |     expect(logs.some(l => l.msg === 'progress_marked' && typeof l.obj?.ms === 'number')).toBe(true);

      at Object.<anonymous> (unit/future.observability.logs.spec.ts:34:16)

FAIL unit/api.progress.errors.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.progress.errors.spec.ts:3:1)

FAIL unit/api.files.finalize.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.finalize.permissions.spec.ts:1:1)

FAIL unit/api.teacher.grading-queue.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at unit/api.teacher.grading-queue.spec.ts:3:19
      at Object.<anonymous> (../apps/web/src/app/api/teacher/grading-queue/route.ts:4:1)
      at Object.<anonymous> (unit/api.teacher.grading-queue.spec.ts:8:1)

FAIL unit/server.withRouteTiming.runtime-csrf-skip.spec.ts
  ● withRouteTiming skips CSRF on /api/runtime/* › cross-origin POST to runtime path passes without same-origin or double-submit

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      23 |     const handler = withRouteTiming(async () => new Response(JSON.stringify({ ok: true }), { status: 200 }));
      24 |     const res = await (handler as any)(mkReq('http://localhost/api/runtime/progress', 'POST', { origin: 'http://evil.example', referer: 'http://evil.example/p' }) as any);
    > 25 |     expect(res.status).toBe(200);
         |                        ^
      26 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      27 |   });
      28 | });

      at Object.<anonymous> (unit/server.withRouteTiming.runtime-csrf-skip.spec.ts:25:24)

FAIL unit/api.files.download-ownership.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-ownership.spec.ts:1:1)

FAIL unit/middleware.csrf-cookie.spec.ts
  ● middleware CSRF cookie issuance › sets csrf_token cookie when missing

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.csrf-cookie.spec.ts:38:29)

FAIL unit/api.files.content-type-default.spec.ts
  ● files default content_type › defaults to application/octet-stream when omitted

    expect(received).toBe(expected) // Object.is equality

    Expected: "application/octet-stream"
    Received: "application/json"

      22 |     const { id } = await put.json();
      23 |     const dl = await (DownloadGET as any)(getUrl(`http://localhost/api/files/download-url?id=${id}`, { 'x-test-auth': 'student' }));
    > 24 |     expect(dl.headers.get('content-type')).toBe('application/octet-stream');
         |                                            ^
      25 |   });
      26 | });
      27 |

      at Object.<anonymous> (unit/api.files.content-type-default.spec.ts:24:44)

FAIL unit/api.progress.access.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.progress.access.spec.ts:3:1)

FAIL unit/security.headers-and-origin.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/security.headers-and-origin.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 | import { POST as MessagesPOST } from '../../apps/web/src/app/api/messages/route';
      3 |
      4 | function req(url: string, method = 'POST', headers?: Record<string,string>, body?: any) {

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/security.headers-and-origin.spec.ts:1:1)

FAIL unit/api.runtime.teacher.outcomes.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.runtime.teacher.outcomes.spec.ts:2:1)

FAIL unit/api.messages.read-all.spec.ts
  ● API /api/messages/threads/[id]/read-all › marks all messages as read for participant; non-participant remains unaffected (TEST_MODE)

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      24 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      25 |     const res = await (ReadAllPATCH as any)(makePatch(`http://localhost/api/messages/threads/${th.id}/read-all`), { params: { id: th.id } } as any);
    > 26 |     expect(res.status).toBe(200);
         |                        ^
      27 |     const json = await res.json();
      28 |     expect(json.ok).toBe(true);
      29 |   });

      at Object.<anonymous> (unit/api.messages.read-all.spec.ts:26:24)

FAIL unit/api.files.resolve.spec.ts
  ● API /api/files/resolve › test-mode: returns mapping for keys with signed download-url

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      22 |   test('test-mode: returns mapping for keys with signed download-url', async () => {
      23 |     const res = await (ResolvePOST as any)(makePost({ keys: ['abc', 'x y', 'z/1'] }, { 'x-test-auth': 'student' }));
    > 24 |     expect(res.status).toBe(200);
         |                        ^
      25 |     const json = await res.json();
      26 |     expect(json['abc'].url).toBe('/api/files/download-url?id=abc');
      27 |     expect(json['x y'].url).toBe('/api/files/download-url?id=x%20y');

      at Object.<anonymous> (unit/api.files.resolve.spec.ts:24:24)

FAIL unit/client.serverFetch.csrf.spec.ts
  ● serverFetch CSRF header attachment › attaches x-csrf-token for unsafe methods when cookie present

    expect(received).toBe(expected) // Object.is equality

    Expected: "abc"
    Received: null

      20 |       Object.defineProperty(global, 'document', { value: { cookie: 'csrf_token=abc' }, configurable: true });
      21 |       await serverFetch('/api/messages', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({}) });
    > 22 |       expect(captured && typeof captured.get === 'function' ? captured.get('x-csrf-token') : captured['x-csrf-token']).toBe('abc');
         |                                                                                                                        ^
      23 |     } finally {
      24 |       (global as any).fetch = origFetch;
      25 |     }

      at Object.<anonymous> (unit/client.serverFetch.csrf.spec.ts:22:120)

FAIL unit/middleware.security-headers.spec.ts
  ● middleware security headers › sets X-Frame-Options: DENY and CSP frame-ancestors none

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.security-headers.spec.ts:30:29)

FAIL unit/api.runtime.outcomes.jwks.rotation.spec.ts
  ● runtime outcomes JWKS rotation › refreshes JWKS on verify failure

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 201]

      21 |     const req = new Request('http://localhost/api/runtime/outcomes', { method: 'POST', headers: { 'content-type': 'application/json', authorization: 'Bearer PROVIDERJWT' } as any, body: JSON.stringify({ courseId: 'c1', userId: 'u1', event: { type: 'attempt.completed', runtimeAttemptId: 'ra1', score: 1, max: 1, passed: true } }) } as any);
      22 |     const res = await route.POST(req as any);
    > 23 |     expect([200,201]).toContain(res.status);
         |                       ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.runtime.outcomes.jwks.rotation.spec.ts:23:23)

FAIL unit/api.admin.quotas.ratelimit.headers.spec.ts
  ● admin quotas rate-limit headers › 429 includes retry-after and rate-limit headers

    TypeError: supabase.from(...).insert is not a function

      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
      54 |   // Use insert with onConflict for broader mock compatibility
    > 55 |   const resp = await (supabase.from('user_storage_quotas') as any).insert(row, { onConflict: 'user_id' } as any).select?.()?.single?.();
         |                                                                    ^
      56 |   const error = (resp as any)?.error ?? null;
      57 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      58 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:55:68)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.headers.spec.ts:18:17)

FAIL unit/api.courses.transfer-owner.audit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.courses.transfer-owner.audit.spec.ts:3:1)

FAIL unit/db.rls.assignments.negative.spec.ts
  ● Assignments RLS/authorization negatives › student cannot create assignment

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/assignments', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'c1', title: 'X', points: 10, due_at: null }) } as any);
      5 |     const res = await route.POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot update assignment', async () => {

      at Object.<anonymous> (unit/db.rls.assignments.negative.spec.ts:6:23)

FAIL unit/api.providers.get.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.get.spec.ts:3:1)

FAIL unit/api.headers.security.spec.ts
  ● security headers (CSP frame-ancestors + X-Frame-Options) › middleware sets CSP frame-ancestors none and X-Frame-Options DENY

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/api.headers.security.spec.ts:29:29)

FAIL unit/api.files.upload-put.avscan.spec.ts
  ● files upload PUT test-mode AV scan › rejects EICAR test string

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 401, 403]

      13 |     const eicar = 'X5O!P%25@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*';
      14 |     const res = await (UploadPut as any)(put(url, headers, eicar));
    > 15 |     expect([400,401,403]).toContain(res.status);
         |                           ^
      16 |   });
      17 |
      18 |   test('accepts small benign text', async () => {

      at Object.<anonymous> (unit/api.files.upload-put.avscan.spec.ts:15:27)

  ● files upload PUT test-mode AV scan › accepts small benign text

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401, 403]

      21 |     const url = 'http://localhost/api/files/upload-url?owner_type=user&owner_id=22222222-2222-2222-2222-222222222222&content_type=text/plain';
      22 |     const res = await (UploadPut as any)(put(url, headers, 'hello'));
    > 23 |     expect([200,401,403]).toContain(res.status);
         |                           ^
      24 |   });
      25 | });
      26 |

      at Object.<anonymous> (unit/api.files.upload-put.avscan.spec.ts:23:27)

FAIL unit/api.events.producers.spec.ts
  ● Event producers (TEST_MODE) › lesson complete records event

    expect(received).toBeTruthy()

    Received: undefined

       9 |     await markLessonComplete('22222222-2222-2222-2222-222222222222', 'aaaaaaaa-aaaa-aaaa-aaaa-000000000111');
      10 |     const ev = getInMemoryEvents().find(e => e.event_type === 'lesson.complete');
    > 11 |     expect(ev).toBeTruthy();
         |                ^
      12 |   });
      13 |
      14 |   test('submission create and grade records events', async () => {

      at Object.<anonymous> (unit/api.events.producers.spec.ts:11:16)

  ● Event producers (TEST_MODE) › submission create and grade records events

    expect(received).toBeTruthy()

    Received: undefined

      17 |     const sub = await createSubmissionApi({ assignment_id: 'aaaaaaaa-aaaa-aaaa-aaaa-000000000222', text: '' } as any, '22222222-2222-2222-2222-222222222222');
      18 |     const createEv = getInMemoryEvents().find(e => e.event_type === 'assignment.submit');
    > 19 |     expect(createEv).toBeTruthy();
         |                      ^
      20 |     await gradeSubmissionApi(sub.id, { score: 95 }, '11111111-1111-1111-1111-111111111111');
      21 |     const gradeEv = getInMemoryEvents().find(e => e.event_type === 'assignment.graded');
      22 |     expect(gradeEv).toBeTruthy();

      at Object.<anonymous> (unit/api.events.producers.spec.ts:19:22)

FAIL unit/api.files.upload-url.quota.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.upload-url.quota.spec.ts:2:1)

FAIL unit/api.reports.dto.spec.ts
  ● reports endpoints headers and DTO-like responses › GET /api/reports/grade-distribution CSV includes header and x-request-id

    expect(received).toBeTruthy()

    Received: false

      20 |     expect(res.headers.get('x-request-id')).toBeTruthy();
      21 |     const ct = res.headers.get('content-type') || '';
    > 22 |     expect(ct.includes('text/csv')).toBeTruthy();
         |                                     ^
      23 |   });
      24 | });
      25 |

      at Object.<anonymous> (unit/api.reports.dto.spec.ts:22:37)

FAIL unit/api.notifications.patch.csrf.spec.ts
  ● notifications preferences PATCH respects CSRF double-submit › 403 when tokens missing or mismatched; 200 when matched

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200]

      17 |     // Match -> 200
      18 |     res = await (NotifPrefsPATCH as any)(patch({ origin: 'http://localhost', referer: 'http://localhost/p', cookie: 'csrf_token=t', 'x-csrf-token': 't', 'content-type': 'application/json' }));
    > 19 |     expect([200]).toContain(res.status);
         |                   ^
      20 |   });
      21 | });
      22 |

      at Object.<anonymous> (unit/api.notifications.patch.csrf.spec.ts:19:19)

FAIL unit/ui/TeacherAnnouncements.spec.tsx
  ● Teacher Announcements (labs) › renders course count and announcement list with jitter

    TypeError: c.getAll is not a function

      11 |   const h = headers();
      12 |   const c = cookies();
    > 13 |   const cookieHeader = h.get("cookie") ?? c.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         |                                             ^
      14 |   const testAuth = h.get("x-test-auth") ?? c.get("x-test-auth")?.value;
      15 |
      16 |   const baseHeaders = { ...(cookieHeader ? { cookie: cookieHeader } : {}), ...(testAuth ? { "x-test-auth": testAuth } : {}) } as HeadersInit;

      at TeacherAnnouncementsPage (../apps/web/src/app/labs/teacher/announcements/page.tsx:13:45)
      at Object.<anonymous> (unit/ui/TeacherAnnouncements.spec.tsx:25:46)

FAIL unit/api.user-profile.put.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.user-profile.put.spec.ts:3:1)

FAIL unit/api.files.download-url.dev-namespace.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.spec.ts:3:1)

FAIL unit/api.providers.create.negatives.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.create.negatives.spec.ts:3:1)

FAIL unit/rate-limit.headers.spec.ts
  ● rate limit headers on 429 › messages POST returns standard headers when throttled

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [201, 401, 403, 429, 500]

      23 |       expect(last.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     } else {
    > 25 |       expect([201,401,403,429,500]).toContain(last.status);
         |                                     ^
      26 |     }
      27 |   });
      28 | });

      at Object.<anonymous> (unit/rate-limit.headers.spec.ts:25:37)

FAIL unit/api.providers.create.happy-path.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.providers.create.happy-path.spec.ts:3:1)

FAIL unit/api.messages.post.ratelimit.spec.ts
  ● messages POST rate limit headers › returns 429 with standard headers when rate-limited

    expect(received).toBe(expected) // Object.is equality

    Expected: 429
    Received: 201

      19 |   test('returns 429 with standard headers when rate-limited', async () => {
      20 |     const res = await (MessagesPOST as any)(post({ thread_id: '00000000-0000-0000-0000-000000000001', body: 'hello' }));
    > 21 |     expect(res.status).toBe(429);
         |                        ^
      22 |     expect(res.headers.get('retry-after')).toBeTruthy();
      23 |     expect(res.headers.get('x-rate-limit-reset')).toBeTruthy();
      24 |     expect(res.headers.get('x-rate-limit-remaining')).toBe('0');

      at Object.<anonymous> (unit/api.messages.post.ratelimit.spec.ts:21:24)

FAIL unit/api.providers.health.ratelimit.spec.ts
  ● providers health rate-limit headers › 429 includes retry-after and x-rate-limit-* headers

    TypeError: supabase.from(...).select(...).eq is not a function

      33 |
      34 |   const supabase = getRouteHandlerSupabase();
    > 35 |   const { data: row, error } = await supabase.from('course_providers').select('id,name,jwks_url,domain').eq('id', q.id).single();
         |                                                                                                          ^
      36 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      37 |   if (!row) return NextResponse.json({ error: { code: 'NOT_FOUND', message: 'Provider not found' }, requestId }, { status: 404, headers: { 'x-request-id': requestId } });
      38 |

      at GET (../apps/web/src/app/api/providers/health/route.ts:35:106)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.providers.health.ratelimit.spec.ts:17:15)

FAIL unit/api.files.quota.enforcement.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.quota.enforcement.spec.ts:2:1)

FAIL unit/api.enrollments.launch-token.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.enrollments.launch-token.spec.ts:3:1)

FAIL unit/gateways/reports.gateway.spec.ts
  ● ReportsGateway › engagement returns counters (course scoped)

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 12

      15 |     }));
      16 |     const out = await createReportsGateway().engagement('c-1');
    > 17 |     expect(out.lessons).toBe(3);
         |                         ^
      18 |     expect(out.assignments).toBe(2);
      19 |   });
      20 |

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:17:25)

  ● ReportsGateway › gradeDistribution returns shape (admin/global)

    expect(received).toBe(expected) // Object.is equality

    Expected: 10
    Received: 42

      28 |     }));
      29 |     const out = await createReportsGateway().gradeDistribution();
    > 30 |     expect(out.total).toBe(10);
         |                       ^
      31 |     expect(out.dist[0].bucket).toBe('80-89');
      32 |   });
      33 | });

      at Object.<anonymous> (unit/gateways/reports.gateway.spec.ts:30:23)

FAIL unit/api.files.av-and-quota.negatives.spec.ts
  ● files AV stub and quota exceed › EICAR-like content rejected

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [400, 200]

      14 |     const id = encodeURIComponent(j.key || 'k');
      15 |     const res = await (UploadPUT as any)(put(`?owner_type=user&owner_id=u1&content_type=text/plain`, `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`));
    > 16 |     expect([400,200]).toContain(res.status);
         |                       ^
      17 |   });
      18 | });
      19 |

      at Object.<anonymous> (unit/api.files.av-and-quota.negatives.spec.ts:16:23)

FAIL unit/middleware.coep.flag.spec.ts
  ● middleware COEP flag › sets Cross-Origin-Embedder-Policy when COEP=1

    TypeError: server_1.NextResponse.next is not a function

      84 |     }
      85 |   } catch {}
    > 86 |   const res = NextResponse.next({ request: { headers } });
         |                            ^
      87 |   res.headers.set("x-request-id", requestId);
      88 |   res.headers.set("Content-Security-Policy", csp);
      89 |   if (process.env.NODE_ENV === 'production') {

      at Object.middleware (../apps/web/middleware.ts:86:28)
      at Object.<anonymous> (unit/middleware.coep.flag.spec.ts:29:29)

FAIL unit/api.flags.spec.ts
  ● Feature flags API (test-mode) › GET requires auth, returns list; PATCH validates key

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      16 |     // PATCH toggle a flag
      17 |     const ok = await route.PATCH(new Request('http://localhost/api/flags', { method: 'PATCH', headers: { 'content-type': 'application/json', 'x-test-auth': 'admin' }, body: JSON.stringify({ key: 'reports.enabled', value: true }) }) as any);
    > 18 |     expect(ok.status).toBe(200);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.flags.spec.ts:18:23)

FAIL unit/api.runtime.jwks.rotation.spec.ts
  ● runtime JWKS rotation (kid refresh) › on verify failure, JWKS cache clears and a subsequent verify can succeed

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      11 |     const bad = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(bad.status);
         |                       ^
      13 |     // Clear cache hook (simulated by env toggle) and retry
      14 |     (process as any).env.JWKS_TTL_MS = '1';
      15 |     const again = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));

      at Object.<anonymous> (unit/api.runtime.jwks.rotation.spec.ts:12:23)

FAIL unit/api.reports.activity-retention.spec.ts
  ● API /api/reports/activity & /api/reports/retention (TEST_MODE) › retention returns array of { day, dau } when authed

    TypeError: supabase.from(...).select(...).order is not a function

      15 |   try { q = parseQuery(req, qSchema); } catch (e: any) { return NextResponse.json({ error: { code: 'BAD_REQUEST', message: e.message }, requestId }, { status: 400, headers: { 'x-request-id': requestId } }); }
      16 |   const supabase = getRouteHandlerSupabase();
    > 17 |   let builder: any = supabase.from('daily_active_users').select('day,dau').order('day', { ascending: true });
         |                                                                            ^
      18 |   if (q.from) builder = builder.gte('day', q.from);
      19 |   if (q.to) builder = builder.lte('day', q.to);
      20 |   const { data, error } = await builder;

      at GET (../apps/web/src/app/api/reports/retention/route.ts:17:76)
      at Object.GET (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.reports.activity-retention.spec.ts:22:17)

FAIL unit/api.files.upload-url.spec.ts
  ● api.files.upload-url › returns signed fields in test-mode

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      18 |     globalThis.__TEST_HEADERS_STORE__.cookies.set('x-test-auth', 'student');
      19 |     const res = await (UploadPOST as any)(makeReq({ owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' }, { 'x-test-auth': 'student' }));
    > 20 |     expect(res.status).toBe(200);
         |                        ^
      21 |     const json = await res.json();
      22 |     expect(json.url).toContain('/api/files/upload-url');
      23 |     expect(json.fields).toBeDefined();

      at Object.<anonymous> (unit/api.files.upload-url.spec.ts:20:24)

FAIL unit/api.courses.transfer-owner.ratelimit.spec.ts
  ● courses transfer-owner rate-limit headers › returns 429 with standard headers when limited

    TypeError: supabase.from(...).select(...).eq is not a function

      38 |   // Only current teacher owner or admin can transfer
      39 |   if (role !== 'admin') {
    > 40 |     const { data: course } = await supabase.from('courses').select('id,teacher_id').eq('id', params.id).single();
         |                                                                                     ^
      41 |     if (!course || (course as any).teacher_id !== user.id) {
      42 |       return NextResponse.json({ error: { code: 'FORBIDDEN', message: 'Not allowed' }, requestId }, { status: 403, headers: { 'x-request-id': requestId } });
      43 |     }

      at PATCH (../apps/web/src/app/api/courses/[id]/transfer-owner/route.ts:40:85)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.courses.transfer-owner.ratelimit.spec.ts:12:17)

FAIL unit/api.user.role.auth.spec.ts
  ● user role update auth › admin -> 200 or 500 (service error tolerated)

    expect(received).toContain(expected) // indexOf

    Expected value: 401
    Received array: [200, 500]

      16 |   test('admin -> 200 or 500 (service error tolerated)', async () => {
      17 |     const res = await (RolePATCH as any)(patch('http://localhost/api/user/role', { 'x-test-auth': 'admin' }, { userId: '11111111-1111-1111-1111-111111111111', role: 'teacher' }));
    > 18 |     expect([200,500]).toContain(res.status);
         |                       ^
      19 |   });
      20 | });
      21 |

      at Object.<anonymous> (unit/api.user.role.auth.spec.ts:18:23)

FAIL unit/api.files.download-url.dev-namespace.guard.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-url.dev-namespace.guard.spec.ts:2:1)

FAIL unit/api.files.upload-url.ratelimit.spec.ts
  ● files upload-url rate limit headers › 429 includes rate limit headers

    expect(received).toContain(expected) // indexOf

    Expected value: 403
    Received array: [200, 401]

      15 |     const payload = { owner_type: 'user', owner_id: 'test-student-id', content_type: 'text/plain' };
      16 |     const res1 = await (UploadPOST as any)(req(payload));
    > 17 |     expect([200,401]).toContain(res1.status);
         |                       ^
      18 |     const res2 = await (UploadPOST as any)(req(payload));
      19 |     if (res2.status === 429) {
      20 |       expect(res2.headers.get('retry-after')).toBeTruthy();

      at Object.<anonymous> (unit/api.files.upload-url.ratelimit.spec.ts:17:23)

FAIL unit/api.attachments.delete.permissions.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.attachments.delete.permissions.spec.ts:3:1)

FAIL unit/lib.serverFetch.extend.spec.ts
  ● serverFetch extended › absolute URL passes through unchanged

    expect(received).toBe(expected) // Object.is equality

    Expected: "http://example.com/api/x"
    Received: "http://web:3022http://example.com/api/x"

       9 |     try {
      10 |       await serverFetch('http://example.com/api/x');
    > 11 |       expect(calls[0].url).toBe('http://example.com/api/x');
         |                            ^
      12 |     } finally {
      13 |       global.fetch = old;
      14 |     }

      at Object.<anonymous> (unit/lib.serverFetch.extend.spec.ts:11:28)

FAIL unit/api.user.role.audit.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.user.role.audit.spec.ts:2:1)

FAIL unit/api.files.download-dev-namespace.spec.ts
  ● Test suite failed to run

    ReferenceError: getRouteHandlerSupabase is not defined

      56 | // Provide direct references for spyOn compatibility in tests that import * as supa
      57 | export const __supabaseExports = {
    > 58 |   getRouteHandlerSupabase,
         |   ^
      59 |   getCurrentUserInRoute,
      60 | };
      61 |

      at Object.<anonymous> (unit/helpers/supabaseMock.ts:58:3)
      at Object.<anonymous> (unit/api.files.download-dev-namespace.spec.ts:1:1)

FAIL unit/lib.metrics.inflight.spec.ts
  ● metrics in-flight tracking › increments and decrements per route

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      21 |     incrInFlight(route);
      22 |     let s1 = snapshot();
    > 23 |     expect((s1[route]?.in_flight || 0)).toBe(before + 2);
         |                                         ^
      24 |     decrInFlight(route);
      25 |     decrInFlight(route);
      26 |     s1 = snapshot();

      at Object.<anonymous> (unit/lib.metrics.inflight.spec.ts:23:41)

FAIL unit/api.reports.engagement.csv-json.spec.ts
  ● reports engagement CSV/JSON › CSV returns text/csv when requested

    expect(received).toMatch(expected)

    Expected pattern: /text\/csv/
    Received string:  "application/json"

      16 |     expect([200,401,403]).toContain(res.status);
      17 |     if (res.status === 200) {
    > 18 |       expect(res.headers.get('content-type') || '').toMatch(/text\/csv/);
         |                                                     ^
      19 |     }
      20 |   });
      21 | });

      at Object.<anonymous> (unit/api.reports.engagement.csv-json.spec.ts:18:53)

FAIL unit/ui/AdminReports.spec.tsx
  ● Admin Reports (dashboard) › renders reports tiles

    TypeError: cc.getAll is not a function

       6 | 	const hh = headers();
       7 | 	const cc = cookies();
    >  8 | 	const cookie = hh.get("cookie") ?? cc.getAll().map(x => `${x.name}=${x.value}`).join("; ");
         | 	                                      ^
       9 | 	const ta = hh.get("x-test-auth") ?? cc.get("x-test-auth")?.value;
      10 | 	const gw = createReportsGateway();
      11 | 	const [engagement, grades, dau, activity] = await Promise.all([

      at AdminReportsPage (../apps/web/src/app/dashboard/admin/reports/page.tsx:8:40)
      at Object.<anonymous> (unit/ui/AdminReports.spec.tsx:18:38)

FAIL unit/api.admin.quotas.ratelimit.spec.ts
  ● admin quotas PATCH rate-limit headers › returns 429 and retry-after header when limited

    TypeError: supabase.from(...).insert is not a function

      53 |   if (typeof body.used_bytes === 'number') row.used_bytes = body.used_bytes;
      54 |   // Use insert with onConflict for broader mock compatibility
    > 55 |   const resp = await (supabase.from('user_storage_quotas') as any).insert(row, { onConflict: 'user_id' } as any).select?.()?.single?.();
         |                                                                    ^
      56 |   const error = (resp as any)?.error ?? null;
      57 |   if (error) return NextResponse.json({ error: { code: 'DB_ERROR', message: error.message }, requestId }, { status: 500, headers: { 'x-request-id': requestId } });
      58 |   return jsonDto({ ok: true } as any, z.object({ ok: z.boolean() }) as any, { requestId, status: 200 });

      at PATCH (../apps/web/src/app/api/admin/quotas/route.ts:55:68)
      at Object.PATCH (../apps/web/src/server/withRouteTiming.ts:89:19)
      at Object.<anonymous> (unit/api.admin.quotas.ratelimit.spec.ts:14:17)

FAIL unit/db.rls.courses.negative.spec.ts
  ● Courses RLS/authorization negatives › student cannot create course

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/courses', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ title: 'X', description: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 |
      9 |   test('student cannot delete course', async () => {

      at Object.<anonymous> (unit/db.rls.courses.negative.spec.ts:6:23)

FAIL unit/lib.runtimeAuth.scopes-aud.spec.ts
  ● runtimeAuth audience and scopes › rejects when aud mismatches allowed origin

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     • If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     • If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     • To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     • If you need a custom transformation specify a "transform" option in your config.
     • If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /workspace/tests/node_modules/jose/dist/webapi/index.js:1
    ({"Object.<anonymous>":function(module,exports,require,__dirname,__filename,jest){export { compactDecrypt } from './jwe/compact/decrypt.js';
                                                                                      ^^^^^^

    SyntaxError: Unexpected token 'export'

      10 |     // Mock getRequestOrigin to return allowed origin and jose verify to return payload with different aud
      11 |     jest.spyOn(require('../../apps/web/src/lib/cors'), 'getRequestOrigin').mockReturnValue('https://good.example' as any);
    > 12 |     jest.spyOn(require('jose') as any, 'jwtVerify').mockResolvedValue({ payload: { aud: 'https://bad.example', scopes: [] } });
         |                ^
      13 |     const out = verifyRuntimeAuthorization(req as any, [] as any) as any;
      14 |     expect(out).toBeTruthy();
      15 |   });

      at Runtime.createScriptFromCode (../node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (unit/lib.runtimeAuth.scopes-aud.spec.ts:12:16)

FAIL unit/lib.runtimeAuth.clockskew.spec.ts
  ● runtimeAuth clock skew tolerance › accepts tokens within tolerance window (dev HS256 path mocked)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      12 |     const req = new Request('http://localhost/api/runtime/progress', { headers: { authorization: 'Bearer X', origin: 'https://wcgyhwvugdnzhegwiiam.lovable.app' } as any } as any);
      13 |     const out: any = await (verifyRuntimeAuthorization as any)(req as any, ['progress.write']);
    > 14 |     expect(out.ok).toBe(true);
         |                    ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/lib.runtimeAuth.clockskew.spec.ts:14:20)

FAIL unit/api.runtime.outcomes.iss-aud.negatives.spec.ts
  ● runtime outcomes provider JWT iss/aud negatives › invalid issuer/audience format yields 403 when present

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      10 |     // Without a real JWT, this exercises the code path expectation only; actual 401/403 depends on signature verify
      11 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 12 |     expect([401,403]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.negatives.spec.ts:12:23)

FAIL unit/api.messages.threads.auth.spec.ts
  ● API /api/messages/threads auth › unauthenticated POST → 401

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 400

      12 |   test('unauthenticated POST → 401', async () => {
      13 |     const res = await (ThreadsPOST as any)(post('http://localhost/api/messages/threads', { participant_ids: [] }));
    > 14 |     expect(res.status).toBe(401);
         |                        ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/api.messages.threads.auth.spec.ts:14:24)

FAIL unit/ui/SystemAuthCheck.spec.tsx
  ● System Auth Check (labs) › renders email and role when authenticated

    expect(element).toHaveTextContent()

    Expected element to have text content:
      t@example.com
    Received:
      s@example.com

      15 |     const ui = await AuthCheckPage();
      16 |     render(ui);
    > 17 |     expect(await screen.findByTestId('auth-email')).toHaveTextContent('t@example.com');
         |                                                     ^
      18 |     expect(await screen.findByTestId('auth-role')).toHaveTextContent('teacher');
      19 |   });
      20 | });

      at Object.<anonymous> (unit/ui/SystemAuthCheck.spec.tsx:17:53)

FAIL unit/api.parent.progress.api.spec.ts
  ● API /api/parent/progress (TEST_MODE) › parent linked to student gets data

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      15 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'parent');
      16 |     const res = await (ParentProgressGET as any)(makeGet('http://localhost/api/parent/progress?student_id=22222222-2222-2222-2222-222222222222'));
    > 17 |     expect(res.status).toBe(200);
         |                        ^
      18 |   });
      19 | });
      20 |

      at Object.<anonymous> (unit/api.parent.progress.api.spec.ts:17:24)

FAIL unit/ui/ParentChildrenReport.spec.tsx
  ● Parent Children Report (labs) › renders total and items

    Unable to find an element by: [data-testid="children-total"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<a[39m
            [33mclass[39m=[32m"text-blue-600 underline"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mSign in[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      17 |     const ui = await ParentChildrenReportPage();
      18 |     render(ui);
    > 19 |     expect(await screen.findByTestId('children-total')).toHaveTextContent('1');
         |                         ^
      20 |   });
      21 | });
      22 |

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/ParentChildrenReport.spec.tsx:19:25)

FAIL unit/ui/SystemOkCard.spec.tsx
  ● System OK Card (labs) › renders ok and ts (human) on success

    TypeError: cookieStore.getAll is not a function

      22 |
      23 |   const cookieHeader = cookieStore
    > 24 |     .getAll()
         |      ^
      25 |     .map((c) => `${c.name}=${c.value}`)
      26 |     .join("; ");
      27 |   const xTestAuth = incomingHeaders.get("x-test-auth") ?? cookieStore.get("x-test-auth")?.value;

      at SystemOkCardPage (../apps/web/src/app/labs/system/ok-card/page.tsx:24:6)
      at Object.<anonymous> (unit/ui/SystemOkCard.spec.tsx:16:38)

FAIL unit/api.runtime.outcomes.iss-aud.strict.spec.ts
  ● runtime outcomes strict iss/aud enforcement › issuer/audience mismatch against provider domain yields 403 (path exercise)

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       9 |     const body = { courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } };
      10 |     const res = await (OutcomesPOST as any)(post(body, { authorization: 'Bearer bad.token.value' }));
    > 11 |     expect([401,403]).toContain(res.status);
         |                       ^
      12 |   });
      13 | });
      14 |

      at Object.<anonymous> (unit/api.runtime.outcomes.iss-aud.strict.spec.ts:11:23)

FAIL unit/ui/ParentChildren.spec.tsx
  ● Parent Children (labs) › renders list with one linked student

    Unable to find an element by: [data-testid="children-list"]

    Ignored nodes: comments, script, style
    [36m<body>[39m
      [36m<div>[39m
        [36m<main[39m
          [33mclass[39m=[32m"p-6"[39m
        [36m>[39m
          [36m<a[39m
            [33mclass[39m=[32m"text-blue-600 underline"[39m
            [33mhref[39m=[32m"/login"[39m
          [36m>[39m
            [0mSign in[0m
          [36m</a>[39m
        [36m</main>[39m
      [36m</div>[39m
    [36m</body>[39m

      15 |     const ui = await ParentChildrenListPage();
      16 |     render(ui);
    > 17 |     await screen.findByTestId('children-list');
         |                  ^
      18 |   });
      19 | });
      20 |

      at waitForWrapper (../node_modules/@testing-library/dom/dist/wait-for.js:163:27)
      at ../node_modules/@testing-library/dom/dist/query-helpers.js:86:33
      at Object.<anonymous> (unit/ui/ParentChildren.spec.tsx:17:18)

FAIL unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts
  ● runtime outcomes JWKS/JWT rotation and alg/aud/iss enforcement › rejects non-RS256 tokens

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

       8 |   test('rejects non-RS256 tokens', async () => {
       9 |     const res = await (OutcomesPOST as any)(post({ courseId: 'c1', userId: 'u1', event: { type: 'progress', pct: 10 } }, { authorization: 'Bearer header.payload.sig' }));
    > 10 |     expect([401,403]).toContain(res.status);
         |                       ^
      11 |   });
      12 | });
      13 |

      at Object.<anonymous> (unit/api.runtime.outcomes.alg-kid-iss-aud.spec.ts:10:23)

FAIL unit/middleware.coep.spec.ts
  ● Test suite failed to run

    Cannot find module '../../apps/web/src/middleware' from 'unit/middleware.coep.spec.ts'

    > 1 | import { middleware } from '../../apps/web/src/middleware';
        | ^
      2 |
      3 | describe('COEP header behavior', () => {
      4 |   const orig = { ...process.env } as any;

      at Resolver._throwModNotFoundError (../node_modules/jest-resolve/build/resolver.js:427:11)
      at Object.<anonymous> (unit/middleware.coep.spec.ts:1:1)

FAIL unit/api.messages.read-all-thread.spec.ts
  ● messages read-all by thread id › student marks thread as read in test-mode

    expect(received).toContain(expected) // indexOf

    Expected value: 500
    Received array: [200, 401]

      10 |     globalThis.__TEST_HEADERS_STORE__?.cookies?.set?.('x-test-auth', 'student');
      11 |     const res = await (ReadAllThreadPATCH as any)(patch('http://localhost/api/messages/threads/11111111-1111-1111-1111-111111111111/read-all'));
    > 12 |     expect([200,401]).toContain(res.status);
         |                       ^
      13 |   });
      14 | });
      15 |

      at Object.<anonymous> (unit/api.messages.read-all-thread.spec.ts:12:23)

FAIL unit/env.validation.spec.ts
  ● environment validation › prod with TEST_MODE=1 throws unless explicitly allowed

    expect(received).toThrow(expected)

    Expected pattern: /TEST_MODE must not be enabled/

    Received function did not throw

      12 |   test('prod with TEST_MODE=1 throws unless explicitly allowed', () => {
      13 |     process.env = { ...original, NODE_ENV: 'production', TEST_MODE: '1' } as any;
    > 14 |     expect(() => loadServerEnv()).toThrow(/TEST_MODE must not be enabled/);
         |                                   ^
      15 |   });
      16 | });
      17 |

      at Object.<anonymous> (unit/env.validation.spec.ts:14:35)

FAIL unit/db.rls.quiz-questions.negative.spec.ts
  ● Quiz questions RLS/authorization negatives › student cannot create quiz question

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quiz-questions', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ quiz_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', text: 'T' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quiz-questions.negative.spec.ts:6:23)

FAIL unit/db.rls.lessons.negative.spec.ts
  ● Lessons RLS/authorization negatives › student cannot create lesson

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/lessons', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'L', content: '' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.lessons.negative.spec.ts:6:23)

FAIL unit/db.rls.modules.negative.spec.ts
  ● Modules RLS/authorization negatives › student cannot create module

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/modules', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'M' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.modules.negative.spec.ts:6:23)

FAIL unit/db.rls.quizzes.negative.spec.ts
  ● Quizzes RLS/authorization negatives › student cannot create quiz

    expect(received).toContain(expected) // indexOf

    Expected value: 400
    Received array: [401, 403]

      4 |     const req = new Request('http://localhost/api/quizzes', { method: 'POST', headers: { 'content-type': 'application/json', 'x-test-auth': 'student' } as any, body: JSON.stringify({ course_id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', title: 'Q' }) } as any);
      5 |     const res = await (route as any).POST(req as any);
    > 6 |     expect([401,403]).toContain(res.status);
        |                       ^
      7 |   });
      8 | });
      9 |

      at Object.<anonymous> (unit/db.rls.quizzes.negative.spec.ts:6:23)


Test Suites: 122 failed, 304 passed, 426 total
Tests:       138 failed, 1 skipped, 14 todo, 561 passed, 714 total
Snapshots:   0 total
Time:        166.737 s
Ran all test suites.
