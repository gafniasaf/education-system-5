// @ts-nocheck
"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[800],{"./src/stories/QuizPlayerClient.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>QuizPlayerClient_stories});var jsx_runtime=__webpack_require__("../../node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("../../node_modules/next/dist/compiled/react/index.js"),types=__webpack_require__("../../node_modules/zod/v3/types.js"),process=(__webpack_require__("./src/lib/serverFetch.ts"),__webpack_require__("../../node_modules/process/browser.js"));let cookies,headers;try{const nh=__webpack_require__("../../node_modules/@storybook/nextjs/dist/export-mocks/headers/index.mjs");cookies=nh.cookies,headers=nh.headers}catch(e){}function isTestMode(){if("1"===process.env.TEST_MODE)return!0;if("1"===process.env.NEXT_PUBLIC_TEST_MODE)return!0;try{if(!0===window.__TEST_MODE__)return!0}catch(e){}return!!process.env.PLAYWRIGHT}var src=__webpack_require__("../../packages/shared/src/index.ts"),quizzes_process=__webpack_require__("../../node_modules/process/browser.js");function buildHttpGateway(){return{async listByCourse(courseId){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quizzes?course_id=${encodeURIComponent(courseId)}`,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.Aw).parse(json)}},async create(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quizzes`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.Aw.parse(json)}},async update(id,data){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quizzes?id=${encodeURIComponent(id)}`,{method:"PATCH",headers:{"content-type":"application/json"},body:JSON.stringify(data),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.Aw.parse(json)}},async delete(id){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quizzes?id=${encodeURIComponent(id)}`,{method:"DELETE",cache:"no-store"});if(!res.ok)throw new Error(`HTTP ${res.status}`)}return{ok:!0}},async listQuestions(quiz_id){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-questions?quiz_id=${encodeURIComponent(quiz_id)}`,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.VL).parse(json)}},async createQuestion(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-questions`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.VL.parse(json)}},async listChoices(question_id){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-choices?question_id=${encodeURIComponent(question_id)}`,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.iT).parse(json)}},async createChoice(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-choices`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.iT.parse(json)}},async startAttempt(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-attempts`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.zP.parse(json)}},async upsertAnswer(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-attempts`,{method:"PATCH",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json().catch(()=>({}));if(!res.ok)throw new Error(`HTTP ${res.status}`);return json}},async submitAttempt(input){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-attempts/submit`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(input),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.zP.parse(json)}},async listAttemptsForQuiz(quiz_id){{const base=quizzes_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/quiz-attempts?quiz_id=${encodeURIComponent(quiz_id)}`,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.zP).parse(json)}}}}function createTestGateway(){return function buildTestGateway(){return buildHttpGateway()}()}function createQuizzesGateway(){return isTestMode()?createTestGateway():function createHttpGateway(){return buildHttpGateway()}()}function QuizPlayerClient({quizId,questions,choicesByQuestion,timeLimitSec,existingAttemptId,secondsLeftInitial}){const[attemptId,setAttemptId]=(0,react.useState)(null!=existingAttemptId?existingAttemptId:null),[secondsLeft,setSecondsLeft]=(0,react.useState)(null!=secondsLeftInitial?secondsLeftInitial:null),submittingRef=(0,react.useRef)(!1);(0,react.useEffect)(()=>{let mounted=!0;return(async()=>{if(!existingAttemptId)try{const data=await createQuizzesGateway().startAttempt({quiz_id:quizId});var _data_id;mounted&&setAttemptId(null!==(_data_id=null==data?void 0:data.id)&&void 0!==_data_id?_data_id:null)}catch(e){}})(),()=>{mounted=!1}},[quizId,existingAttemptId]),(0,react.useEffect)(()=>{null==secondsLeftInitial&&attemptId&&timeLimitSec&&timeLimitSec>0&&setSecondsLeft(timeLimitSec)},[attemptId,timeLimitSec,secondsLeftInitial]);const submit=async()=>{if(submittingRef.current)return;submittingRef.current=!0;let id=attemptId;try{if(!id){const data=await createQuizzesGateway().startAttempt({quiz_id:quizId});var _data_id;id=null!==(_data_id=null==data?void 0:data.id)&&void 0!==_data_id?_data_id:null}id&&await createQuizzesGateway().submitAttempt({attempt_id:id})}catch(e){}setTimeout(()=>window.location.reload(),300)};(0,react.useEffect)(()=>{if(!secondsLeft||secondsLeft<=0)return;const id=setInterval(()=>{setSecondsLeft(s=>null==s?s:s<=1?(clearInterval(id),submit(),0):s-1)},1e3);return()=>clearInterval(id)},[secondsLeft]);const mmss=(0,react.useMemo)(()=>{if(null==secondsLeft)return null;return`${Math.floor(secondsLeft/60)}:${String(secondsLeft%60).padStart(2,"0")}`},[secondsLeft]);return(0,jsx_runtime.jsxs)("div",{children:[mmss&&(0,jsx_runtime.jsxs)("div",{className:"rounded border p-2 inline-block mb-3","data-testid":"quiz-timer",children:["Time left: ",(0,jsx_runtime.jsx)("span",{className:"font-mono",children:mmss})]}),(0,jsx_runtime.jsx)("ol",{className:"space-y-4",children:questions.map((q,idx)=>(0,jsx_runtime.jsxs)("li",{children:[(0,jsx_runtime.jsxs)("div",{className:"mb-1","data-testid":"quiz-question",children:[idx+1,". ",q.text]}),(0,jsx_runtime.jsx)("ul",{className:"space-y-1",children:(choicesByQuestion[q.id]||[]).map(ch=>(0,jsx_runtime.jsx)("li",{children:(0,jsx_runtime.jsxs)("label",{className:"flex items-center gap-2","data-testid":"quiz-choice",children:[(0,jsx_runtime.jsx)("input",{type:"radio",name:`q_${q.id}`,value:ch.id,onChange:()=>(async(questionId,choiceId)=>{if(attemptId)try{await createQuizzesGateway().upsertAnswer({attempt_id:attemptId,question_id:questionId,choice_id:choiceId})}catch(e){}})(q.id,ch.id)}),(0,jsx_runtime.jsx)("span",{children:ch.text})]})},ch.id))})]},q.id))}),(0,jsx_runtime.jsx)("button",{onClick:submit,className:"mt-4 rounded bg-blue-600 text-white px-4 py-2 disabled:opacity-50","data-testid":"quiz-submit-btn",disabled:submittingRef.current,children:"Submit"})]})}QuizPlayerClient.__docgenInfo={description:"",methods:[],displayName:"QuizPlayerClient",props:{quizId:{required:!0,tsType:{name:"string"},description:""},questions:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:"{ id: string; quiz_id: string; text: string; order_index: number }",signature:{properties:[{key:"id",value:{name:"string",required:!0}},{key:"quiz_id",value:{name:"string",required:!0}},{key:"text",value:{name:"string",required:!0}},{key:"order_index",value:{name:"number",required:!0}}]}}],raw:"Question[]"},description:""},choicesByQuestion:{required:!0,tsType:{name:"Record",elements:[{name:"string"},{name:"Array",elements:[{name:"signature",type:"object",raw:"{ id: string; question_id: string; text: string; correct: boolean; order_index: number }",signature:{properties:[{key:"id",value:{name:"string",required:!0}},{key:"question_id",value:{name:"string",required:!0}},{key:"text",value:{name:"string",required:!0}},{key:"correct",value:{name:"boolean",required:!0}},{key:"order_index",value:{name:"number",required:!0}}]}}],raw:"Choice[]"}],raw:"Record<string, Choice[]>"},description:""},timeLimitSec:{required:!1,tsType:{name:"union",raw:"number | null",elements:[{name:"number"},{name:"null"}]},description:""},existingAttemptId:{required:!1,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},secondsLeftInitial:{required:!1,tsType:{name:"union",raw:"number | null",elements:[{name:"number"},{name:"null"}]},description:""}}};const QuizPlayerClient_stories={title:"Student/QuizPlayer",component:QuizPlayerClient,parameters:{layout:"fullscreen"}},Default={args:{quizId:"quiz-1",questions:[{id:"q1",quiz_id:"quiz-1",text:"What is 2 + 2?",order_index:1},{id:"q2",quiz_id:"quiz-1",text:"Capital of France?",order_index:2}],choicesByQuestion:{q1:[{id:"c1",question_id:"q1",text:"3",correct:!1,order_index:1},{id:"c2",question_id:"q1",text:"4",correct:!0,order_index:2}],q2:[{id:"c3",question_id:"q2",text:"Paris",correct:!0,order_index:1},{id:"c4",question_id:"q2",text:"Berlin",correct:!1,order_index:2}]},timeLimitSec:90},render:args=>(0,jsx_runtime.jsx)(QuizPlayerClient,{...args})},__namedExportsOrder=["Default"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:'{\n  args: {\n    quizId: "quiz-1",\n    questions: sampleQuestions as any,\n    choicesByQuestion: sampleChoices as any,\n    timeLimitSec: 90\n  },\n  render: args => <QuizPlayerClient {...args as any} />\n}',...Default.parameters?.docs?.source}}}},"./src/lib/serverFetch.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__("../../node_modules/process/browser.js"),__webpack_require__("../../node_modules/console-browserify/index.js")}}]);