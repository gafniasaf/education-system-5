// @ts-nocheck
"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[290],{"./src/stories/NotificationsDropdownClient.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>NotificationsDropdownClient_stories});var jsx_runtime=__webpack_require__("../../node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("../../node_modules/next/dist/compiled/react/index.js"),types=__webpack_require__("../../node_modules/zod/v3/types.js"),src=__webpack_require__("../../packages/shared/src/index.ts"),process=__webpack_require__("../../node_modules/process/browser.js");function buildHttpGateway(){return{async list(offset=0,limit=100){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications?offset=${offset}&limit=${limit}`,res=await fetch(url,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.t6).parse(json)}},async markRead(id){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications?id=${encodeURIComponent(id)}`,res=await fetch(url,{method:"PATCH",cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.t6.parse(json)}},async markAllRead(){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/read-all`,res=await fetch(url,{method:"PATCH",cache:"no-store"});if(!res.ok)throw new Error(`HTTP ${res.status}`);return{ok:!0}}},async getPreferences(){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/preferences`,res=await fetch(url,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IM(types.O7()).parse(json)}},async updatePreferences(prefs){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/preferences`,res=await fetch(url,{method:"PATCH",headers:{"content-type":"application/json"},body:JSON.stringify(prefs),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IM(types.O7()).parse(json)}}}}function createNotificationsGateway(){return function createHttpGateway(){return buildHttpGateway()}()}function NotificationsDropdownClient({initial}){const[items,setItems]=(0,react.useState)(initial||[]),[offset,setOffset]=(0,react.useState)((null==initial?void 0:initial.length)||0),[loadingMore,setLoadingMore]=(0,react.useState)(!1);return(0,jsx_runtime.jsxs)("div",{"data-testid":"notif-list",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,jsx_runtime.jsx)("span",{className:"font-medium",children:"Notifications"}),(0,jsx_runtime.jsx)("button",{onClick:async function markAll(){const prev=items;setItems(prev.map(n=>({...n,read_at:n.read_at||(new Date).toISOString()})));try{await createNotificationsGateway().markAllRead()}catch(e){setItems(prev)}},className:"underline text-xs",title:"Mark all read","aria-label":"Mark all notifications as read","data-testid":"notif-mark-all",children:"Mark all"})]}),(0,jsx_runtime.jsx)("ul",{className:"space-y-2",children:(items||[]).slice(0,100).map(n=>{var _n_payload,_n_payload1;return(0,jsx_runtime.jsxs)("li",{className:"flex items-center justify-between gap-2","data-testid":"notif-item",children:[(0,jsx_runtime.jsxs)("div",{className:n.read_at?"text-gray-500":"",children:[(0,jsx_runtime.jsx)("span",{children:n.type}),"submission:graded"===n.type&&null!=(null==n||null===(_n_payload=n.payload)||void 0===_n_payload?void 0:_n_payload.score)&&(0,jsx_runtime.jsxs)("span",{className:"ml-2",children:["Score: ",n.payload.score]}),"message:new"===n.type&&(null==n||null===(_n_payload1=n.payload)||void 0===_n_payload1?void 0:_n_payload1.thread_id)&&(0,jsx_runtime.jsx)("a",{className:"ml-2 underline",href:`/labs/system/inbox?thread=${encodeURIComponent(n.payload.thread_id)}`,children:"Open thread"})]}),!n.read_at&&(0,jsx_runtime.jsx)("button",{onClick:()=>async function markRead(id){setItems(prev=>prev.map(n=>n.id===id?{...n,read_at:(new Date).toISOString()}:n));try{await createNotificationsGateway().markRead(id)}catch(e){setItems(prev=>prev.map(n=>n.id===id?{...n,read_at:null}:n))}}(n.id),className:"underline text-xs","aria-label":`Mark notification ${n.id} as read`,"data-testid":"notif-read-btn",children:"Read"})]},n.id)})}),(0,jsx_runtime.jsx)("div",{className:"mt-2 flex justify-end",children:(0,jsx_runtime.jsx)("button",{onClick:async function loadMore(){setLoadingMore(!0);try{const data=await createNotificationsGateway().list(offset,20);Array.isArray(data)&&data.length>0&&(setItems(prev=>[...prev,...data]),setOffset(prev=>prev+data.length))}finally{setLoadingMore(!1)}},className:"underline text-xs",disabled:loadingMore,"data-testid":"notif-load-more",children:loadingMore?"Loadingâ€¦":"Load more"})})]})}NotificationsDropdownClient.__docgenInfo={description:"",methods:[],displayName:"NotificationsDropdownClient",props:{initial:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:"{ id: string; type: string; payload?: any; created_at: string; read_at?: string | null }",signature:{properties:[{key:"id",value:{name:"string",required:!0}},{key:"type",value:{name:"string",required:!0}},{key:"payload",value:{name:"any",required:!1}},{key:"created_at",value:{name:"string",required:!0}},{key:"read_at",value:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}],required:!1}}]}}],raw:"Notif[]"},description:""}}};const NotificationsDropdownClient_stories={title:"Header/NotificationsDropdown",component:NotificationsDropdownClient,parameters:{layout:"centered"}},Default={args:{initial:Array.from({length:6}).map((_,i)=>({id:`n-${i+1}`,type:i%2?"submission:graded":"message:new",payload:i%2?{score:95-i}:{thread_id:`t-${i+1}`},created_at:new Date(Date.now()-6e4*i).toISOString(),read_at:i<2?null:(new Date).toISOString()}))},render:args=>(0,jsx_runtime.jsx)("div",{style:{width:320},children:(0,jsx_runtime.jsx)(NotificationsDropdownClient,{...args})})},__namedExportsOrder=["Default"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:'{\n  args: {\n    initial: Array.from({\n      length: 6\n    }).map((_, i) => ({\n      id: `n-${i + 1}`,\n      type: i % 2 ? "submission:graded" : "message:new",\n      payload: i % 2 ? {\n        score: 95 - i\n      } : {\n        thread_id: `t-${i + 1}`\n      },\n      created_at: new Date(Date.now() - i * 60000).toISOString(),\n      read_at: i < 2 ? null : new Date().toISOString()\n    }))\n  },\n  render: args => <div style={{\n    width: 320\n  }}>\r\n      <NotificationsDropdownClient {...args} />\r\n    </div>\n}',...Default.parameters?.docs?.source}}}}}]);