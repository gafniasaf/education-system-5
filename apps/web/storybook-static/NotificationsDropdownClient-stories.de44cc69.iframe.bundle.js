"use strict";(self.webpackChunkweb=self.webpackChunkweb||[]).push([[290],{"./src/stories/NotificationsDropdownClient.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{BellBadge:()=>BellBadge,Default:()=>Default,Empty:()=>Empty,__namedExportsOrder:()=>__namedExportsOrder,default:()=>NotificationsDropdownClient_stories});var jsx_runtime=__webpack_require__("../../node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("../../node_modules/next/dist/compiled/react/index.js"),types=__webpack_require__("../../node_modules/zod/v3/types.js"),src=__webpack_require__("../../packages/shared/src/index.ts"),testMode=__webpack_require__("./src/lib/testMode.ts"),process=__webpack_require__("../../node_modules/process/browser.js");function buildTestGateway(){return{async list(offset=0,limit=100){const now=Date.now();return Array.from({length:Math.min(500,offset+limit+20)}).map((_,i)=>(i=>({id:`no-${String(i).padStart(4,"0")}`,user_id:"test-user",type:i%3==0?"submission:graded":i%3==1?"message:new":"announcement:published",payload:i%3==0?{score:80+i%20}:i%3==1?{thread_id:`th-${i}`}:{},created_at:new Date(now-6e4*i).toISOString(),read_at:i%5==0?null:new Date(now-3e4*i).toISOString()}))(i)).slice(offset,offset+limit)},markRead:async id=>({id,user_id:"test-user",type:"message:new",payload:{},created_at:(new Date).toISOString(),read_at:(new Date).toISOString()}),markAllRead:async()=>({ok:!0}),getPreferences:async()=>({"assignment:new":!0,"submission:graded":!0,"message:new":!0,"announcement:published":!0,"quiz:due-soon":!0}),updatePreferences:async prefs=>({...prefs})}}function createHttpGateway(){return function buildHttpGateway(){return{async list(offset=0,limit=100){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications?offset=${offset}&limit=${limit}`,res=await fetch(url,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IX(src.t6).parse(json)}},async markRead(id){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications?id=${encodeURIComponent(id)}`,res=await fetch(url,{method:"PATCH",cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return src.t6.parse(json)}},async markAllRead(){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/read-all`,res=await fetch(url,{method:"PATCH",cache:"no-store"});if(!res.ok)throw new Error(`HTTP ${res.status}`);return{ok:!0}}},async getPreferences(){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/preferences`,res=await fetch(url,{cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IM(types.O7()).parse(json)}},async updatePreferences(prefs){{const url=`${process.env.NEXT_PUBLIC_BASE_URL||""}/api/notifications/preferences`,res=await fetch(url,{method:"PATCH",headers:{"content-type":"application/json"},body:JSON.stringify(prefs),cache:"no-store"}),json=await res.json();if(!res.ok)throw new Error(`HTTP ${res.status}`);return types.IM(types.O7()).parse(json)}}}}()}function createNotificationsGateway(){return(0,testMode.Mx)()?function createTestGateway(){return buildTestGateway()}():createHttpGateway()}var Toast=__webpack_require__("./src/components/ui/Toast.tsx");function NotificationsDropdownClient({initial}){const[items,setItems]=(0,react.useState)(initial||[]),[offset,setOffset]=(0,react.useState)((null==initial?void 0:initial.length)||0),[loadingMore,setLoadingMore]=(0,react.useState)(!1),{toasts,push,dismiss}=__webpack_require__("./src/components/ui/Toast.tsx");return(0,jsx_runtime.jsxs)("div",{"data-testid":"notif-list",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,jsx_runtime.jsx)("span",{className:"font-medium",children:"Notifications"}),(0,jsx_runtime.jsx)("button",{onClick:async function markAll(){const prev=items;setItems(prev.map(n=>({...n,read_at:n.read_at||(new Date).toISOString()})));try{await createNotificationsGateway().markAllRead(),(0,Toast.fireToast)("Marked all notifications as read","success");try{window.dispatchEvent(new CustomEvent("notifications:updated"))}catch(e){}}catch(e){setItems(prev),(0,Toast.fireToast)("Failed to mark all as read","error")}},className:"underline text-xs",title:"Mark all read","aria-label":"Mark all notifications as read","data-testid":"notif-mark-all",children:"Mark all"})]}),(0,jsx_runtime.jsx)("ul",{className:"space-y-2",children:(items||[]).slice(0,100).map(n=>{var _n_payload,_n_payload1;return(0,jsx_runtime.jsxs)("li",{className:"flex items-center justify-between gap-2","data-testid":"notif-item",children:[(0,jsx_runtime.jsxs)("div",{className:n.read_at?"text-gray-500":"",children:[(0,jsx_runtime.jsx)("span",{children:n.type}),"submission:graded"===n.type&&null!=(null==n||null===(_n_payload=n.payload)||void 0===_n_payload?void 0:_n_payload.score)&&(0,jsx_runtime.jsxs)("span",{className:"ml-2",children:["Score: ",n.payload.score]}),"message:new"===n.type&&(null==n||null===(_n_payload1=n.payload)||void 0===_n_payload1?void 0:_n_payload1.thread_id)&&(0,jsx_runtime.jsx)("a",{className:"ml-2 underline",href:`/labs/system/inbox?thread=${encodeURIComponent(n.payload.thread_id)}`,children:"Open thread"})]}),!n.read_at&&(0,jsx_runtime.jsx)("button",{onClick:()=>async function markRead(id){setItems(prev=>prev.map(n=>n.id===id?{...n,read_at:(new Date).toISOString()}:n));try{await createNotificationsGateway().markRead(id),(0,Toast.fireToast)("Marked as read","success");try{window.dispatchEvent(new CustomEvent("notifications:updated"))}catch(e){}}catch(e){setItems(prev=>prev.map(n=>n.id===id?{...n,read_at:null}:n)),(0,Toast.fireToast)("Failed to mark as read","error")}}(n.id),className:"underline text-xs","aria-label":`Mark notification ${n.id} as read`,"data-testid":"notif-read-btn",children:"Read"})]},n.id)})}),(0,jsx_runtime.jsx)("div",{className:"mt-2 flex justify-end",children:(0,jsx_runtime.jsx)("button",{onClick:async function loadMore(){setLoadingMore(!0);try{const data=await createNotificationsGateway().list(offset,20);Array.isArray(data)&&data.length>0&&(setItems(prev=>[...prev,...data]),setOffset(prev=>prev+data.length))}finally{setLoadingMore(!1)}},className:"underline text-xs",disabled:loadingMore,"data-testid":"notif-load-more",children:loadingMore?"Loadingâ€¦":"Load more"})})]})}NotificationsDropdownClient.__docgenInfo={description:"",methods:[],displayName:"NotificationsDropdownClient",props:{initial:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:"{ id: string; type: string; payload?: any; created_at: string; read_at?: string | null }",signature:{properties:[{key:"id",value:{name:"string",required:!0}},{key:"type",value:{name:"string",required:!0}},{key:"payload",value:{name:"any",required:!1}},{key:"created_at",value:{name:"string",required:!0}},{key:"read_at",value:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}],required:!1}}]}}],raw:"Notif[]"},description:""}}};var useNotificationsPoll_process=__webpack_require__("../../node_modules/process/browser.js");var NotificationsBellClient_process=__webpack_require__("../../node_modules/process/browser.js");function NotificationsBellClient({initialUnread=0}){const[unread,setUnread]=(0,react.useState)(initialUnread);!function useNotificationsPoll(intervalMs=15e3,onUpdate){(0,react.useEffect)(()=>{let timer=null,mounted=!0;const lastUnreadRef={current:-1};return timer=window.setTimeout(async function tick(){try{const base=useNotificationsPoll_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/notifications`,{cache:"no-store"});if(res.ok){const json=await res.json().catch(()=>[]),arr=Array.isArray(json)?json:[],unread=arr.filter(n=>!n.read_at).length;!(()=>{try{return"1"===localStorage.getItem("notifications.muteToasts")}catch(e){return!1}})()&&unread>0&&unread>(lastUnreadRef.current<0?0:lastUnreadRef.current)&&(0,Toast.fireToast)("You have unread notifications"),lastUnreadRef.current=unread,onUpdate&&onUpdate(unread,arr)}}finally{mounted&&(timer=window.setTimeout(tick,intervalMs))}},intervalMs),()=>{mounted=!1,timer&&window.clearTimeout(timer)}},[intervalMs,onUpdate])}(15e3,count=>setUnread(count)),(0,react.useEffect)(()=>{function onUpdated(){setTimeout(async()=>{try{const base=NotificationsBellClient_process.env.NEXT_PUBLIC_BASE_URL||"",res=await fetch(`${base}/api/notifications`,{cache:"no-store"}),arr=await res.json().catch(()=>[]),cnt=Array.isArray(arr)?arr.filter(n=>!n.read_at).length:0;setUnread(cnt)}catch(e){}},0)}return window.addEventListener("notifications:updated",onUpdated),()=>window.removeEventListener("notifications:updated",onUpdated)},[]);const bumpClass=unread>0?"animate-pulse":"";return(0,jsx_runtime.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,jsx_runtime.jsx)("span",{className:bumpClass,children:"ðŸ””"}),(0,jsx_runtime.jsx)("span",{className:"ml-1 text-xs",children:unread})]})}NotificationsBellClient.__docgenInfo={description:"",methods:[],displayName:"NotificationsBellClient",props:{initialUnread:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"0",computed:!1}}}};const NotificationsDropdownClient_stories={title:"Header/NotificationsDropdown",component:NotificationsDropdownClient,parameters:{layout:"centered"}},Default={args:{initial:Array.from({length:6}).map((_,i)=>({id:`n-${i+1}`,type:i%2?"submission:graded":"message:new",payload:i%2?{score:95-i}:{thread_id:`t-${i+1}`},created_at:new Date(Date.now()-6e4*i).toISOString(),read_at:i<2?null:(new Date).toISOString()}))},render:args=>(0,jsx_runtime.jsx)("div",{style:{width:320},children:(0,jsx_runtime.jsx)(NotificationsDropdownClient,{...args})})},Empty={args:{initial:[]},render:args=>(0,jsx_runtime.jsx)("div",{style:{width:320},children:(0,jsx_runtime.jsx)(NotificationsDropdownClient,{...args})})},BellBadge={render:()=>(0,jsx_runtime.jsx)("div",{className:"inline-flex items-center gap-2",children:(0,jsx_runtime.jsx)(NotificationsBellClient,{initialUnread:3})})},__namedExportsOrder=["Default","Empty","BellBadge"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:'{\n  args: {\n    initial: Array.from({\n      length: 6\n    }).map((_, i) => ({\n      id: `n-${i + 1}`,\n      type: i % 2 ? "submission:graded" : "message:new",\n      payload: i % 2 ? {\n        score: 95 - i\n      } : {\n        thread_id: `t-${i + 1}`\n      },\n      created_at: new Date(Date.now() - i * 60000).toISOString(),\n      read_at: i < 2 ? null : new Date().toISOString()\n    }))\n  },\n  render: args => <div style={{\n    width: 320\n  }}>\r\n      <NotificationsDropdownClient {...args} />\r\n    </div>\n}',...Default.parameters?.docs?.source}}},Empty.parameters={...Empty.parameters,docs:{...Empty.parameters?.docs,source:{originalSource:"{\n  args: {\n    initial: []\n  },\n  render: args => <div style={{\n    width: 320\n  }}>\r\n      <NotificationsDropdownClient {...args} />\r\n    </div>\n}",...Empty.parameters?.docs?.source}}},BellBadge.parameters={...BellBadge.parameters,docs:{...BellBadge.parameters?.docs,source:{originalSource:'{\n  render: () => <div className="inline-flex items-center gap-2">\r\n      <NotificationsBellClient initialUnread={3} />\r\n    </div>\n}',...BellBadge.parameters?.docs?.source}}}},"./src/components/ui/Toast.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ToastRegion:()=>ToastRegion,fireToast:()=>fireToast,useToasts:()=>useToasts});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/next/dist/compiled/react/jsx-runtime.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/next/dist/compiled/react/index.js");function useToasts(){const[toasts,setToasts]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)([]),dismiss=(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)(id=>setToasts(prev=>prev.filter(t=>t.id!==id)),[]);return{toasts,push:(0,react__WEBPACK_IMPORTED_MODULE_1__.useCallback)((title,kind="info")=>{const id=crypto.randomUUID();return setToasts(prev=>[...prev,{id,title,kind}]),id},[]),dismiss}}function ToastRegion({toasts,onDismiss}){return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:"fixed bottom-4 right-4 z-[1000] space-y-2",role:"region","aria-live":"polite","aria-label":"Notifications",children:toasts.map(t=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(Toast,{item:t,onDismiss},t.id))})}function Toast({item,onDismiss}){const ref=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(null);(0,react__WEBPACK_IMPORTED_MODULE_1__.useEffect)(()=>(ref.current=window.setTimeout(()=>onDismiss(item.id),4e3),()=>{ref.current&&window.clearTimeout(ref.current)}),[item.id,onDismiss]);const color="success"===item.kind?"bg-green-600":"error"===item.kind?"bg-red-600":"bg-gray-900";return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:["text-white px-3 py-2 rounded shadow",color].join(" "),children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{className:"flex items-center justify-between gap-4",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("span",{children:item.title}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("button",{className:"underline text-xs",onClick:()=>onDismiss(item.id),"aria-label":"Dismiss",children:"Dismiss"})]})})}function fireToast(title,kind="info"){const ev=new CustomEvent("app:toast",{detail:{title,kind}});window.dispatchEvent(ev)}ToastRegion.__docgenInfo={description:"",methods:[],displayName:"ToastRegion",props:{toasts:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:'{ id: string; title: string; kind?: "success" | "error" | "info" }',signature:{properties:[{key:"id",value:{name:"string",required:!0}},{key:"title",value:{name:"string",required:!0}},{key:"kind",value:{name:"union",raw:'"success" | "error" | "info"',elements:[{name:"literal",value:'"success"'},{name:"literal",value:'"error"'},{name:"literal",value:'"info"'}],required:!1}}]}}],raw:"ToastItem[]"},description:""},onDismiss:{required:!0,tsType:{name:"signature",type:"function",raw:"(id: string) => void",signature:{arguments:[{type:{name:"string"},name:"id"}],return:{name:"void"}}},description:""}}}}}]);